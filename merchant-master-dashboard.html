<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IdealFit - Merchant Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="shopify-data-service.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8fafc;
            color: #1a202c;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            text-rendering: optimizeLegibility;
            font-feature-settings: "kern" 1;
            font-kerning: normal;
        }
        
        /* Login Screen */
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 2rem;
        }
        
        .login-box {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 3rem;
            max-width: 450px;
            width: 100%;
        }
        
        .login-logo {
            font-size: 4rem;
            text-align: center;
            margin-bottom: 1rem;
        }
        
        .login-title {
            text-align: center;
            font-size: 2rem;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 0.5rem;
        }
        
        .login-subtitle {
            text-align: center;
            color: #718096;
            margin-bottom: 2rem;
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #4a5568;
        }
        
        .form-input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .btn-login {
            width: 100%;
            padding: 1rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-login:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }
        
        .login-footer {
            text-align: center;
            margin-top: 1.5rem;
            color: #718096;
            font-size: 0.9rem;
        }
        
        .link {
            color: #667eea;
            text-decoration: none;
            font-weight: 500;
        }
        
        .link:hover {
            text-decoration: underline;
        }
        
        /* Main Dashboard */
        .dashboard {
            display: none;
        }
        
        .dashboard.active {
            display: block;
        }
        
        .navbar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem 2rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        
        .nav-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1600px;
            margin: 0 auto;
        }
        
        .nav-brand {
            font-size: 1.5rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .nav-user {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .user-name {
            font-weight: 500;
        }
        
        .btn-logout {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .btn-logout:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 0;
            display: flex;
            min-height: calc(100vh - 70px);
        }
        
        .sidebar {
            width: 280px;
            background: linear-gradient(180deg, #1e3a8a 0%, #1e40af 100%);
            border-right: none;
            padding: 2rem 0;
            position: sticky;
            top: 70px;
            height: calc(100vh - 70px);
            overflow-y: auto;
            box-shadow: 4px 0 20px rgba(0, 0, 0, 0.1);
        }
        
        .main-content {
            flex: 1;
            padding: 2rem;
            overflow-y: auto;
            background: #f8fafc;
            min-height: calc(100vh - 70px);
        }
        
        .page-header {
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .page-title {
            font-size: 2rem;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 0.5rem;
        }
        
        /* Unit Toggle Styles */
        .unit-toggle-container {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .unit-toggle {
            display: inline-flex;
            background: #f3f4f6;
            border-radius: 8px;
            padding: 4px;
            gap: 4px;
        }
        
        .unit-btn {
            padding: 0.5rem 1rem;
            border: none;
            background: transparent;
            color: #6b7280;
            font-weight: 500;
            font-size: 0.875rem;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .unit-btn:hover {
            background: #e5e7eb;
            color: #374151;
        }
        
        .unit-btn.active {
            background: white;
            color: #667eea;
            font-weight: 600;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .page-subtitle {
            color: #718096;
            font-size: 1.1rem;
        }
        
        .user-section {
            padding: 1.5rem 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .user-avatar {
            width: 48px;
            height: 48px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: white;
        }
        
        .user-info {
            flex: 1;
        }
        
        .user-name {
            color: white;
            font-weight: 600;
            font-size: 1rem;
            margin-bottom: 4px;
        }
        
        .user-email {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.85rem;
        }
        
        .logout-section {
            margin-top: auto;
            padding: 1rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .logout-btn {
            width: 100%;
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            padding: 1rem 1.5rem;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.3s ease;
            text-align: left;
            display: flex;
            align-items: center;
            gap: 12px;
            color: rgba(239, 68, 68, 0.9);
            margin: 4px 0;
        }
        
        .logout-btn:hover {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            transform: translateX(4px);
        }
        
        .sidebar-nav {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            padding: 0 1rem;
        }
        
        .tab {
            background: none;
            border: none;
            padding: 1rem 1.5rem;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.3s ease;
            text-align: left;
            display: flex;
            align-items: center;
            gap: 12px;
            color: rgba(255, 255, 255, 0.8);
            border-left: 3px solid transparent;
            margin: 4px 0;
        }
        
        .tab:hover {
            background: rgba(255, 255, 255, 0.1);
            border-left-color: #60a5fa;
            color: white;
            transform: translateX(4px);
        }
        
        .tab.active {
            background: rgba(255, 255, 255, 0.15);
            color: white;
            font-weight: 600;
            border-left-color: #60a5fa;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .tab-icon {
            font-size: 1.3rem;
            opacity: 0.9;
        }
        
        .tab-label {
            flex: 1;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            text-rendering: optimizeLegibility;
        }
        
        .tab-content {
            display: none;
            animation: fadeIn 0.5s ease;
        }
        
        .tab-content.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: white;
            padding: 2rem;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            text-align: center;
            transition: all 0.3s ease;
            border: 1px solid rgba(0, 0, 0, 0.05);
            position: relative;
            overflow: hidden;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 30px rgba(0,0,0,0.15);
        }
        
        .stat-icon {
            font-size: 2.5rem;
            margin-bottom: 1rem;
        }
        
        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: #667eea;
            margin: 0.5rem 0;
        }
        
        .stat-label {
            color: #718096;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 500;
        }
        
        .card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            padding: 2rem;
            margin-bottom: 2rem;
            border: 1px solid rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }
        
        .card:hover {
            box-shadow: 0 8px 30px rgba(0,0,0,0.12);
            transform: translateY(-2px);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #e2e8f0;
        }
        
        .card-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #2d3748;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        
        .btn-secondary {
            background: #f8fafc;
            color: #4a5568;
            border: 1px solid #e2e8f0;
        }
        
        .btn-secondary:hover {
            background: #e2e8f0;
        }
        
        .btn-success {
            background: #48bb78;
            color: white;
        }
        
        .btn-danger {
            background: #e53e3e;
            color: white;
        }
        
        .chart-container {
            position: relative;
            height: 400px;
            margin: 2rem 0;
        }
        
        .table-container {
            overflow-x: auto;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }
        
        .data-table th,
        .data-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .data-table th {
            background: #f7fafc;
            font-weight: 600;
            color: #4a5568;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 0.875rem;
            position: sticky;
            top: 0;
        }
        
        .data-table tr:hover {
            background: #f8fafc;
        }
        
        .badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .badge-success { background: #c6f6d5; color: #22543d; }
        .badge-warning { background: #faf089; color: #744210; }
        .badge-info { background: #bee3f8; color: #2a4365; }
        
        .filters {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .filter-label {
            font-size: 0.875rem;
            font-weight: 500;
            color: #4a5568;
        }
        
        .filter-select {
            padding: 0.5rem 1rem;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 0.875rem;
            min-width: 150px;
        }
        
        .alert {
            padding: 1.5rem;
            border-radius: 8px;
            margin: 1rem 0;
            border-left: 4px solid;
        }
        
        .alert-info {
            background: #ebf8ff;
            border-color: #3182ce;
            color: #2a4365;
        }
        
        .alert-success {
            background: #f0fff4;
            border-color: #38a169;
            color: #22543d;
        }
        
        .alert-warning {
            background: #fffbeb;
            border-color: #d69e2e;
            color: #744210;
        }
        
        .size-chart-editor {
            background: #f8fafc;
            padding: 2rem;
            border-radius: 12px;
            margin: 1rem 0;
        }
        
        .size-row {
            display: grid;
            grid-template-columns: 100px 1fr 1fr 1fr 80px;
            gap: 1rem;
            margin-bottom: 1rem;
            align-items: center;
        }
        
        .size-row input {
            padding: 0.5rem;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
        }
        
        .btn-delete {
            background: #fee;
            color: #e53e3e;
            border: 1px solid #feb2b2;
            padding: 0.5rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1.2rem;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        
        .btn-delete:hover {
            background: #e53e3e;
            color: white;
            border-color: #e53e3e;
            transform: scale(1.1);
        }
        
        .billing-summary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            border-radius: 12px;
            margin: 2rem 0;
        }
        
        .billing-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-top: 1.5rem;
        }
        
        .billing-item {
            background: rgba(255,255,255,0.1);
            padding: 1.5rem;
            border-radius: 8px;
        }
        
        .billing-item-label {
            font-size: 0.875rem;
            opacity: 0.9;
            margin-bottom: 0.5rem;
        }
        
        .billing-item-value {
            font-size: 2rem;
            font-weight: bold;
        }
        
        .pricing-tiers {
            background: #f0f4f8;
            padding: 2rem;
            border-radius: 12px;
            margin: 2rem 0;
        }
        
        .tier-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: white;
            margin-bottom: 0.5rem;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        
        .tier-info {
            flex: 1;
        }
        
        .tier-range {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 0.25rem;
        }
        
        .tier-price {
            color: #718096;
        }
        
        .tier-badge {
            background: #667eea;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-weight: 600;
        }
        
        .hidden {
            display: none;
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #e2e8f0;
        }
        
        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #2d3748;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #718096;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
        }
        
        .modal-close:hover {
            background: #f8fafc;
        }
        
        .settings-section {
            margin-bottom: 2rem;
        }
        
        .settings-section h3 {
            color: #2d3748;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .settings-tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .settings-tab-content {
            display: block;
        }
        
        .settings-tab-content.hidden {
            display: none;
        }
        
        @media (max-width: 1200px) {
            .card-header .btn {
                font-size: 0.75rem;
                padding: 0.5rem 1rem;
            }
        }
        
        @media (max-width: 1024px) {
            .container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: auto;
                position: static;
                border-right: none;
                border-bottom: 2px solid #e2e8f0;
                padding: 1rem;
            }
            
            .sidebar-nav {
                flex-direction: row;
                overflow-x: auto;
            }
            
            .tab {
                white-space: nowrap;
            }
        }
        
        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .billing-grid {
                grid-template-columns: 1fr;
            }
            
            .size-row {
                grid-template-columns: 1fr;
            }
            
            .main-content {
                padding: 1rem;
            }
        }
        
        /* Notification System Styles */
        .notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            max-width: 400px;
        }
        
        .notification {
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 15px;
            padding: 20px;
            border-left: 4px solid #667eea;
            transform: translateX(450px);
            transition: all 0.3s ease;
            opacity: 0;
        }
        
        .notification.show {
            transform: translateX(0);
            opacity: 1;
        }
        
        .notification.success {
            border-left-color: #10b981;
        }
        
        .notification.warning {
            border-left-color: #f59e0b;
        }
        
        .notification.error {
            border-left-color: #ef4444;
        }
        
        .notification.info {
            border-left-color: #3b82f6;
        }
        
        .notification-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .notification-title {
            font-weight: 600;
            color: #1f2937;
            font-size: 1rem;
        }
        
        .notification-close {
            background: none;
            border: none;
            font-size: 1.2rem;
            color: #6b7280;
            cursor: pointer;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s ease;
        }
        
        .notification-close:hover {
            background: #f3f4f6;
            color: #374151;
        }
        
        .notification-message {
            color: #4b5563;
            font-size: 0.9rem;
            line-height: 1.5;
        }
        
        .notification-icon {
            font-size: 1.5rem;
            margin-right: 10px;
        }
        
        .notification-actions {
            margin-top: 15px;
            display: flex;
            gap: 10px;
        }
        
        .notification-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .notification-btn-primary {
            background: #667eea;
            color: white;
        }
        
        .notification-btn-primary:hover {
            background: #5a67d8;
        }
        
        .notification-btn-secondary {
            background: #f3f4f6;
            color: #374151;
        }
        
        .notification-btn-secondary:hover {
            background: #e5e7eb;
        }
        
        /* Bell Icon for Notifications */
        .notification-bell {
            position: relative;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.1rem;
            transition: all 0.3s ease;
            margin-right: 10px;
        }
        
        .notification-bell:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ef4444;
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 0.7rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        /* Enhanced Mobile Responsiveness */
        @media (max-width: 768px) {
            /* Navigation */
            .navbar {
                padding: 1rem 0.5rem;
            }
            
            .nav-container {
                flex-direction: column;
                gap: 1rem;
            }
            
            .nav-brand {
                font-size: 1.2rem;
            }
            
            .nav-user {
                flex-direction: row;
                justify-content: center;
                gap: 0.5rem;
            }
            
            .notification-bell {
                width: 35px;
                height: 35px;
                font-size: 1rem;
            }
            
            .btn-logout {
                padding: 0.5rem 1rem;
                font-size: 0.9rem;
            }
            
            /* Sidebar */
            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
                padding: 1rem;
            }
            
            .sidebar-header {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 1rem;
            }
            
            .user-info {
                text-align: left;
            }
            
            .nav-menu {
                flex-direction: row;
                flex-wrap: wrap;
                gap: 0.5rem;
                justify-content: center;
            }
            
            .nav-item {
                flex: 1;
                min-width: calc(50% - 0.25rem);
                text-align: center;
                padding: 1rem 0.5rem;
                border-radius: 12px;
                background: rgba(255, 255, 255, 0.1);
                margin-bottom: 0.5rem;
            }
            
            .tab-icon {
                font-size: 1.5rem;
                margin-bottom: 0.5rem;
            }
            
            .tab-label {
                font-size: 0.9rem;
            }
            
            /* Main Content */
            .main-content {
                padding: 1rem 0.5rem;
            }
            
            .page-header {
                text-align: center;
                margin-bottom: 1.5rem;
            }
            
            .page-title {
                font-size: 1.8rem;
            }
            
            .page-subtitle {
                font-size: 1rem;
            }
            
            /* Cards and Sections */
            .card {
                margin-bottom: 1rem;
                padding: 1rem;
            }
            
            .card-header {
                padding: 1rem 0;
            }
            
            .card-title {
                font-size: 1.3rem;
            }
            
            /* Stats Grid */
            .stats-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .stat-card {
                padding: 1.5rem 1rem;
                text-align: center;
            }
            
            .stat-number {
                font-size: 2rem;
            }
            
            .stat-label {
                font-size: 0.9rem;
            }
            
            /* Forms */
            .form-group {
                margin-bottom: 1rem;
            }
            
            .form-label {
                font-size: 0.9rem;
                margin-bottom: 0.5rem;
            }
            
            .form-input, .form-select {
                padding: 12px;
                font-size: 16px; /* Prevents zoom on iOS */
                border-radius: 8px;
            }
            
            /* Buttons */
            .btn {
                padding: 12px 16px;
                font-size: 1rem;
                min-height: 44px; /* Touch-friendly minimum */
                border-radius: 8px;
            }
            
            .btn-primary, .btn-success, .btn-secondary {
                width: 100%;
                margin-bottom: 0.5rem;
            }
            
            /* Tables */
            .data-table {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .data-table table {
                min-width: 600px;
            }
            
            .data-table th,
            .data-table td {
                padding: 8px 4px;
                font-size: 0.85rem;
            }
            
            /* Size Chart */
            .size-chart-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .size-row {
                grid-template-columns: 1fr;
                gap: 0.5rem;
            }
            
            .size-input {
                padding: 12px;
                font-size: 16px;
            }
            
            /* Billing */
            .billing-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .billing-item {
                padding: 1rem;
                text-align: center;
            }
            
            .billing-item-label {
                font-size: 0.9rem;
            }
            
            .billing-item-value {
                font-size: 1.5rem;
            }
            
            /* Modals */
            .modal {
                padding: 1rem;
            }
            
            .modal-content {
                margin: 1rem;
                max-height: 90vh;
                overflow-y: auto;
            }
            
            .modal-header {
                padding: 1rem;
                flex-direction: column;
                gap: 1rem;
            }
            
            .modal-title {
                font-size: 1.3rem;
                text-align: center;
            }
            
            .modal-body {
                padding: 1rem;
            }
            
            .modal-footer {
                padding: 1rem;
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .modal-footer .btn {
                width: 100%;
            }
            
            /* Settings */
            .settings-tabs {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .settings-tab {
                padding: 1rem;
                text-align: center;
                border-radius: 8px;
            }
            
            .settings-section {
                margin-bottom: 1.5rem;
            }
            
            .settings-section h3 {
                font-size: 1.2rem;
                margin-bottom: 1rem;
            }
            
            /* Touch Optimizations */
            .touch-target {
                min-height: 44px;
                min-width: 44px;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            /* Swipe gestures for navigation */
            .swipe-indicator {
                display: block;
                text-align: center;
                color: rgba(255, 255, 255, 0.7);
                font-size: 0.8rem;
                margin-top: 0.5rem;
            }
            
            /* Notifications */
            .notification-container {
                top: 10px;
                right: 10px;
                left: 10px;
                max-width: none;
            }
            
            .notification {
                margin-bottom: 10px;
                padding: 15px;
            }
            
            .notification-actions {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .notification-btn {
                width: 100%;
                padding: 12px;
                font-size: 1rem;
            }
        }
        
        /* Tablet Responsiveness */
        @media (min-width: 769px) and (max-width: 1024px) {
            .sidebar {
                width: 250px;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .size-chart-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .billing-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        /* Large Mobile / Small Tablet */
        @media (min-width: 481px) and (max-width: 768px) {
            .nav-menu {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        /* Onboarding & Tooltip Styles */
        .onboarding-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 9999;
            display: none;
            animation: fadeIn 0.3s ease;
        }
        
        .onboarding-overlay.active {
            display: block;
        }
        
        .onboarding-spotlight {
            position: absolute;
            border: 3px solid #667eea;
            border-radius: 12px;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.8), 0 0 30px rgba(102, 126, 234, 0.5);
            transition: all 0.4s ease;
            pointer-events: none;
            z-index: 10000;
        }
        
        .onboarding-tooltip {
            position: absolute;
            background: white;
            border-radius: 12px;
            padding: 25px;
            max-width: 400px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            z-index: 10001;
            animation: slideIn 0.4s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .onboarding-tooltip-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .onboarding-tooltip-icon {
            font-size: 2rem;
        }
        
        .onboarding-tooltip-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: #1e3a8a;
        }
        
        .onboarding-tooltip-step {
            color: #6b7280;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .onboarding-tooltip-body {
            color: #4b5563;
            line-height: 1.6;
            margin-bottom: 20px;
        }
        
        .onboarding-tooltip-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
        }
        
        .onboarding-progress {
            display: flex;
            gap: 5px;
        }
        
        .onboarding-progress-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #d1d5db;
            transition: all 0.3s ease;
        }
        
        .onboarding-progress-dot.active {
            background: #667eea;
            width: 24px;
            border-radius: 4px;
        }
        
        .onboarding-actions {
            display: flex;
            gap: 10px;
        }
        
        .onboarding-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.9rem;
        }
        
        .onboarding-btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .onboarding-btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }
        
        .onboarding-btn-secondary {
            background: #f3f4f6;
            color: #374151;
        }
        
        .onboarding-btn-secondary:hover {
            background: #e5e7eb;
        }
        
        .onboarding-skip {
            color: #6b7280;
            text-decoration: none;
            font-size: 0.85rem;
            cursor: pointer;
            transition: color 0.2s ease;
        }
        
        .onboarding-skip:hover {
            color: #374151;
        }
        
        /* Tooltip System */
        .tooltip-trigger {
            position: relative;
            cursor: help;
        }
        
        .tooltip {
            position: absolute;
            background: #1f2937;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.85rem;
            white-space: nowrap;
            z-index: 9998;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        
        .tooltip.show {
            opacity: 1;
        }
        
        .tooltip-arrow {
            position: absolute;
            width: 0;
            height: 0;
            border-style: solid;
        }
        
        .tooltip.top .tooltip-arrow {
            bottom: -5px;
            left: 50%;
            transform: translateX(-50%);
            border-width: 5px 5px 0 5px;
            border-color: #1f2937 transparent transparent transparent;
        }
        
        .tooltip.bottom .tooltip-arrow {
            top: -5px;
            left: 50%;
            transform: translateX(-50%);
            border-width: 0 5px 5px 5px;
            border-color: transparent transparent #1f2937 transparent;
        }
        
        /* Help Button */
        .help-button {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
            transition: all 0.3s ease;
            z-index: 9997;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .help-button:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 30px rgba(102, 126, 234, 0.6);
        }
        
        .help-menu {
            position: fixed;
            bottom: 100px;
            right: 30px;
            background: white;
            border-radius: 12px;
            padding: 20px;
            min-width: 250px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            z-index: 9996;
            display: none;
            animation: slideUp 0.3s ease;
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .help-menu.active {
            display: block;
        }
        
        .help-menu-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: #1e3a8a;
            margin-bottom: 15px;
        }
        
        .help-menu-item {
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            color: #4b5563;
            margin-bottom: 5px;
        }
        
        .help-menu-item:hover {
            background: #f3f4f6;
            color: #1e3a8a;
        }
        
        .help-menu-icon {
            font-size: 1.2rem;
        }
        
        /* Touch Device Optimizations */
        @media (hover: none) and (pointer: coarse) {
            .btn:hover,
            .nav-item:hover,
            .notification-bell:hover {
                transform: none;
            }
            
            .btn:active,
            .nav-item:active {
                transform: scale(0.95);
                transition: transform 0.1s ease;
            }
            
            /* Increase touch targets */
            .btn {
                min-height: 48px;
            }
            
            .nav-item {
                min-height: 60px;
            }
            
            /* Remove hover effects on touch devices */
            .card:hover {
                transform: none;
            }
        }
    </style>
</head>
<body>
    <!-- Notification Container -->
    <div class="notification-container" id="notificationContainer"></div>
    
    <!-- Onboarding Overlay -->
    <div class="onboarding-overlay" id="onboardingOverlay">
        <div class="onboarding-spotlight" id="onboardingSpotlight"></div>
        <div class="onboarding-tooltip" id="onboardingTooltip"></div>
    </div>
    
    <!-- Help Button -->
    <button class="help-button" id="helpButton" onclick="toggleHelpMenu()" title="Help & Support">
        ?
    </button>
    
    <!-- Help Menu -->
    <div class="help-menu" id="helpMenu">
        <div class="help-menu-title">üìö Help & Support</div>
        <div class="help-menu-item" onclick="startOnboarding()">
            <span class="help-menu-icon">üéØ</span>
            <span>Start Tutorial</span>
        </div>
        <div class="help-menu-item" onclick="showQuickTips()">
            <span class="help-menu-icon">üí°</span>
            <span>Quick Tips</span>
        </div>
        <div class="help-menu-item" onclick="showKeyboardShortcuts()">
            <span class="help-menu-icon">‚å®Ô∏è</span>
            <span>Keyboard Shortcuts</span>
        </div>
        <div class="help-menu-item" onclick="showFAQ()">
            <span class="help-menu-icon">‚ùì</span>
            <span>FAQ</span>
        </div>
        <div class="help-menu-item" onclick="contactSupport()">
            <span class="help-menu-icon">üí¨</span>
            <span>Contact Support</span>
        </div>
    </div>
    
    <!-- Login Screen -->
    <div id="loginScreen" class="login-container">
        <div class="login-box">
            <div class="login-logo">üéØ</div>
            <h1 class="login-title">IdealFit</h1>
            <p class="login-subtitle">Merchant Dashboard</p>
            
            <form id="loginForm" onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" id="emailInput" class="form-input" placeholder="merchant@store.com" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" id="passwordInput" class="form-input" placeholder="Enter your password" required>
                </div>
                
                <button type="submit" class="btn-login">Sign In</button>
            </form>
            
            <div class="login-footer">
                Don't have an account? <a href="#" class="link" onclick="showSignup()">Sign up</a>
                <br>
                <a href="#" class="link" onclick="showForgotPassword()">Forgot password?</a>
                <br><br>
                <small>Demo: Use any email/password to login</small>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">‚öôÔ∏è Settings</h2>
                <button class="modal-close" onclick="closeSettings()">√ó</button>
            </div>
            
            <!-- Settings Tabs -->
            <div style="display: flex; gap: 1rem; margin-bottom: 2rem; border-bottom: 2px solid #e2e8f0;">
                <button class="btn btn-secondary settings-tab active" onclick="showSettingsTab('info')" id="infoTab">
                    üë§ Info
                </button>
                <button class="btn btn-secondary settings-tab" onclick="showSettingsTab('billing-settings')" id="billingSettingsTab">
                    üí∞ Billing
                </button>
                <button class="btn btn-secondary settings-tab" onclick="showSettingsTab('integration')" id="integrationTab">
                    üîó Integration
                </button>
            </div>
            
            <!-- Info Tab -->
            <div id="settingsInfo" class="settings-tab-content">
                <div class="settings-section">
                    <h3>üë§ Account Information</h3>
                    <div class="form-group">
                        <label class="form-label">Customer ID</label>
                        <input type="text" id="customerId" class="form-input" value="CUST-12345" readonly>
                        <p style="color: #718096; font-size: 0.875rem; margin-top: 0.5rem;">Your unique customer identifier</p>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" id="settingsEmail" class="form-input" value="merchant@store.com" readonly>
                    </div>
                </div>
                
                <div class="settings-section">
                    <h3>üîí Change Password</h3>
                    <div class="form-group">
                        <label class="form-label">Current Password</label>
                        <input type="password" id="currentPassword" class="form-input" placeholder="Enter current password">
                    </div>
                    <div class="form-group">
                        <label class="form-label">New Password</label>
                        <input type="password" id="newPassword" class="form-input" placeholder="Enter new password">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Confirm New Password</label>
                        <input type="password" id="confirmPassword" class="form-input" placeholder="Confirm new password">
                    </div>
                    <button class="btn btn-primary" onclick="changePassword()">Update Password</button>
                </div>
            </div>
            
            <!-- Billing Settings Tab -->
            <div id="settingsBilling" class="settings-tab-content hidden">
                
                <div class="settings-section">
                    <h3>üìã Billing History</h3>
                    <div class="form-group">
                        <label class="form-label">Select Month:</label>
                        <select id="settingsBillingMonth" class="filter-select" onchange="loadSettingsBillingHistory()">
                            <option value="2025-10">October 2025</option>
                            <option value="2025-09">September 2025</option>
                            <option value="2025-08">August 2025</option>
                            <option value="2025-07">July 2025</option>
                            <option value="2025-06">June 2025</option>
                        </select>
                    </div>
                    <div id="settingsBillingDetail"></div>
                </div>
                
                <div class="settings-section">
                    <h3>‚ÑπÔ∏è How Billing Works</h3>
                    <div class="alert alert-info">
                        <ul style="margin-left: 1.5rem; line-height: 1.8;">
                            <li>Only orders with IdealFit measurement data are counted</li>
                            <li>Billing occurs on the 1st of every month</li>
                            <li>Calculation: Total orders √ó Your plan rate</li>
                            <li>Example: 156 orders √ó $0.12 = $18.72</li>
                            <li>Payment: Auto-pay or 7-day invoice</li>
                            <li>Free trial: First 7 days free</li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <!-- Integration Tab -->
            <div id="settingsIntegration" class="settings-tab-content hidden">
                <div class="settings-section">
                    <h3>üîó Shopify Integration</h3>
                    <p style="color: #718096; margin-bottom: 1.5rem;">
                        Connect your Shopify store to sync real-time order data and customer measurements with this dashboard.
                    </p>
                    
                    <div class="form-group">
                        <label class="form-label">Shopify Store URL</label>
                        <input type="text" id="shopifyStoreUrl" class="form-input" placeholder="your-store.myshopify.com">
                        <p style="color: #718096; font-size: 0.875rem; margin-top: 0.5rem;">
                            Enter your Shopify store URL (e.g., mystore.myshopify.com)
                        </p>
                    </div>
                    
                    
                    <button class="btn btn-primary" id="connectButton" onclick="connectShopify()">üîó Connect to Shopify</button>
                    
                    <div id="integrationStatus" style="margin-top: 1.5rem;"></div>
                </div>
                
                <div class="settings-section">
                    <h3>‚ÑπÔ∏è What Gets Synced</h3>
                    <div class="alert alert-success">
                        <p style="margin-bottom: 1rem;"><strong>When connected, this dashboard will display:</strong></p>
                        <ul style="margin-left: 1.5rem; line-height: 2;">
                            <li>‚úÖ Real customer measurements from your orders</li>
                            <li>‚úÖ Actual size recommendations data</li>
                            <li>‚úÖ Live order counts for billing</li>
                            <li>‚úÖ Customer names and emails</li>
                            <li>‚úÖ Order IDs and dates</li>
                            <li>‚úÖ Automatic data refresh</li>
                        </ul>
                        <p style="margin-top: 1rem; opacity: 0.9;">
                            <strong>Note:</strong> Only orders with IdealFit measurement data will be synced.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div id="mainDashboard" class="dashboard">
        <!-- Navigation -->
        <nav class="navbar">
            <div class="nav-container">
                <div class="nav-brand">
                    üéØ IdealFit Merchant Dashboard
                </div>
                <div class="nav-user">
                    <span class="user-name" id="userName">Merchant</span>
                    <button class="notification-bell" onclick="toggleNotifications()" title="Notifications">
                        üîî
                        <span class="notification-badge" id="notificationBadge" style="display: none;">0</span>
                    </button>
                    <button class="btn-logout" onclick="openSettings()" style="margin-right: 0.5rem;">‚öôÔ∏è Settings</button>
                    <button class="btn-logout" onclick="handleLogout()">Logout</button>
                </div>
            </div>
        </nav>

        <div class="container">
            <!-- Sidebar Navigation -->
            <div class="sidebar">
                <!-- User Section -->
                <div class="user-section">
                    <div class="user-avatar">
                        <i class="fas fa-store"></i>
                    </div>
                    <div class="user-info">
                        <div class="user-name" id="merchantName">Merchant Store</div>
                        <div class="user-email" id="merchantEmail">store@example.com</div>
                    </div>
                </div>
                
                <div class="sidebar-nav">
                    <button class="tab active" onclick="showTab('analytics')">
                        <span class="tab-icon">üìä</span>
                        <span class="tab-label">Analytics</span>
                    </button>
                    <button class="tab" onclick="showTab('customers')">
                        <span class="tab-icon">üë•</span>
                        <span class="tab-label">Customer Database</span>
                    </button>
                    <button class="tab" onclick="showTab('sizechart')">
                        <span class="tab-icon">üìè</span>
                        <span class="tab-label">Size Chart</span>
                    </button>
                    <button class="tab" onclick="showTab('billing')">
                        <span class="tab-icon">üí∞</span>
                        <span class="tab-label">Billing</span>
                    </button>
                    <button class="tab" onclick="showTab('bulk-operations')" id="bulkOpsTab">
                        <span class="tab-icon">üîÑ</span>
                        <span class="tab-label">Bulk Operations</span>
                        <span style="font-size: 0.7rem; background: #f59e0b; padding: 2px 6px; border-radius: 8px; margin-left: 4px;">PRO</span>
                    </button>
                </div>
                
                <div class="swipe-indicator" style="display: none;">
                    üí° Swipe left/right to navigate
                </div>
            </div>

            <!-- Main Content Area -->
            <div class="main-content">

            <!-- Tab 1: Analytics & Comparison -->
            <div id="analytics" class="tab-content active">
                <div class="page-header">
                    <h1 class="page-title">üìä Analytics & Size Comparison</h1>
                    <p class="page-subtitle">Understand your customer measurements and optimize production</p>
                </div>

                <!-- Date Filters -->
                <div class="card" style="margin-bottom: 20px;">
                    <div class="card-header">
                        <h2 class="card-title">üìÖ Date Filters</h2>
                    </div>
                    <div style="padding: 20px;">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; align-items: end;">
                            <!-- Date Range -->
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #374151;">üìÖ From Date</label>
                                <input type="date" id="filterDateFrom" class="form-input" style="width: 100%;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #374151;">üìÖ To Date</label>
                                <input type="date" id="filterDateTo" class="form-input" style="width: 100%;">
                            </div>
                            
                            <!-- Month Filter -->
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #374151;">üìÜ Month</label>
                                <select id="filterMonth" class="form-input" style="width: 100%;">
                                    <option value="">All Months</option>
                                    <option value="1">January</option>
                                    <option value="2">February</option>
                                    <option value="3">March</option>
                                    <option value="4">April</option>
                                    <option value="5">May</option>
                                    <option value="6">June</option>
                                    <option value="7">July</option>
                                    <option value="8">August</option>
                                    <option value="9">September</option>
                                    <option value="10">October</option>
                                    <option value="11">November</option>
                                    <option value="12">December</option>
                                </select>
                            </div>
                            
                            <!-- Year Filter -->
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #374151;">üìÖ Year</label>
                                <select id="filterYear" class="form-input" style="width: 100%;">
                                    <option value="">All Years</option>
                                    <option value="2025">2025</option>
                                    <option value="2024">2024</option>
                                    <option value="2023">2023</option>
                                </select>
                            </div>
                            
                            <!-- Quick Filters -->
                            <div style="grid-column: span 2;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #374151;">‚ö° Quick Filters</label>
                                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                    <button class="btn btn-secondary" onclick="applyQuickFilter('today')">Today</button>
                                    <button class="btn btn-secondary" onclick="applyQuickFilter('week')">This Week</button>
                                    <button class="btn btn-secondary" onclick="applyQuickFilter('month')">This Month</button>
                                    <button class="btn btn-secondary" onclick="applyQuickFilter('quarter')">This Quarter</button>
                                    <button class="btn btn-secondary" onclick="applyQuickFilter('year')">This Year</button>
                                    <button class="btn btn-secondary" onclick="applyQuickFilter('all')">All Time</button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Action Buttons -->
                        <div style="display: flex; gap: 10px; margin-top: 15px; padding-top: 15px; border-top: 1px solid #e5e7eb;">
                            <button class="btn btn-primary" onclick="applyDateFilters()">üîç Apply Filters</button>
                            <button class="btn btn-secondary" onclick="clearDateFilters()">üîÑ Clear Filters</button>
                            <button class="btn btn-success" onclick="exportFilteredData()">üì• Export Filtered Data (Excel)</button>
                            <div id="filterStatus" style="margin-left: auto; align-self: center; color: #6b7280; font-size: 14px;"></div>
                        </div>
                    </div>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">üì¶</div>
                        <div class="stat-number" id="totalOrders">156</div>
                        <div class="stat-label">Total Orders</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üë§</div>
                        <div class="stat-number" id="uniqueCustomers">134</div>
                        <div class="stat-label">Unique Customers</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üìè</div>
                        <div class="stat-number" id="mostPopularSize">M</div>
                        <div class="stat-label">Most Popular Size</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üìà</div>
                        <div class="stat-number" id="returnReduction">32%</div>
                        <div class="stat-label">Est. Return Reduction</div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">üìä Size Distribution</h2>
                        <div style="display: flex; gap: 1rem; align-items: center;">
                            <select id="analyticsMonth" class="filter-select">
                                <option value="">All Months</option>
                                <option value="9">October 2025</option>
                                <option value="8">September 2025</option>
                                <option value="7">August 2025</option>
                            </select>
                            <select id="analyticsYear" class="filter-select">
                                <option value="">All Years</option>
                                <option value="2025">2025</option>
                                <option value="2024">2024</option>
                            </select>
                            <button class="btn btn-primary" onclick="exportAnalytics()">üì• Export to Excel</button>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="sizeDistributionChart"></canvas>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">üìà Size Comparison & Production Insights</h2>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Size</th>
                                <th>Recommendations</th>
                                <th>Percentage</th>
                                <th>Avg Bust</th>
                                <th>Avg Waist</th>
                                <th>Avg Hip</th>
                                <th>Production Priority</th>
                            </tr>
                        </thead>
                        <tbody id="sizeComparisonTable">
                            <tr>
                                <td><strong>XS</strong></td>
                                <td>12</td>
                                <td>7.7%</td>
                                <td>29"</td>
                                <td>24"</td>
                                <td>34"</td>
                                <td><span class="badge badge-info">Low</span></td>
                            </tr>
                            <tr>
                                <td><strong>S</strong></td>
                                <td>28</td>
                                <td>17.9%</td>
                                <td>31"</td>
                                <td>26"</td>
                                <td>36"</td>
                                <td><span class="badge badge-warning">Medium</span></td>
                            </tr>
                            <tr>
                                <td><strong>M</strong></td>
                                <td>45</td>
                                <td>28.8%</td>
                                <td>33"</td>
                                <td>28"</td>
                                <td>38"</td>
                                <td><span class="badge badge-success">High</span></td>
                            </tr>
                            <tr>
                                <td><strong>L</strong></td>
                                <td>38</td>
                                <td>24.4%</td>
                                <td>35"</td>
                                <td>30"</td>
                                <td>40"</td>
                                <td><span class="badge badge-success">High</span></td>
                            </tr>
                            <tr>
                                <td><strong>XL</strong></td>
                                <td>22</td>
                                <td>14.1%</td>
                                <td>37"</td>
                                <td>32"</td>
                                <td>42"</td>
                                <td><span class="badge badge-warning">Medium</span></td>
                            </tr>
                            <tr>
                                <td><strong>XXL</strong></td>
                                <td>11</td>
                                <td>7.1%</td>
                                <td>39"</td>
                                <td>34"</td>
                                <td>44"</td>
                                <td><span class="badge badge-info">Low</span></td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Professional Recommendations Section -->
                <div class="card" style="margin-top: 20px;">
                    <div class="card-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                        <h2 class="card-title" style="color: white; margin: 0;">üí° Recommendations</h2>
                    </div>
                    <div style="padding: 20px;">
                        <!-- Recommendation Cards -->
                        <div id="recommendationCards" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; margin-bottom: 20px;">
                            <!-- Cards will be dynamically generated -->
                        </div>
                        
                        <!-- Detailed Insights -->
                        <div id="detailedInsights" style="background: #f8fafc; padding: 20px; border-radius: 8px; border-left: 4px solid #667eea;">
                            <h3 style="margin-top: 0; color: #1e293b; font-size: 16px;">üìä Data-Driven Insights</h3>
                            <div id="insightDetails" style="color: #475569; line-height: 1.8;">
                                Loading insights...
                            </div>
                        </div>
                        
                        <!-- Action Items -->
                        <div id="actionItems" style="margin-top: 20px; background: #ecfdf5; padding: 20px; border-radius: 8px; border-left: 4px solid #10b981;">
                            <h3 style="margin-top: 0; color: #065f46; font-size: 16px;">‚úÖ Recommended Actions</h3>
                            <ul id="actionList" style="color: #047857; line-height: 2; margin: 0; padding-left: 20px;">
                                <!-- Actions will be dynamically generated -->
                            </ul>
                        </div>
                        
                        <!-- Data Confidence Indicator -->
                        <div id="dataConfidence" style="margin-top: 20px; padding: 15px; background: #fff7ed; border-radius: 8px; border-left: 4px solid #f59e0b; text-align: center;">
                            <div style="color: #92400e; font-size: 14px;">
                                <strong>üìà Data Confidence:</strong> <span id="confidenceLevel">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab 2: Customer Database -->
            <div id="customers" class="tab-content">
                <div class="page-header">
                    <h1 class="page-title">üë• Customer Measurement Database</h1>
                    <p class="page-subtitle">View, filter, and export all customer measurement data</p>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">üîç Filters</h2>
                        <button class="btn btn-primary" onclick="exportCustomerData()">üì• Export to Excel</button>
                    </div>
                    
                    <div class="filters">
                        <div class="filter-group">
                            <label class="filter-label">Date From</label>
                            <input type="date" id="dateFrom" class="filter-select" onchange="filterCustomers()">
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Date To</label>
                            <input type="date" id="dateTo" class="filter-select" onchange="filterCustomers()">
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Month</label>
                            <select id="monthFilter" class="filter-select" onchange="filterCustomers()">
                                <option value="">All Months</option>
                                <option value="0">January</option>
                                <option value="1">February</option>
                                <option value="2">March</option>
                                <option value="3">April</option>
                                <option value="4">May</option>
                                <option value="5">June</option>
                                <option value="6">July</option>
                                <option value="7">August</option>
                                <option value="8">September</option>
                                <option value="9">October</option>
                                <option value="10">November</option>
                                <option value="11">December</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Year</label>
                            <select id="yearFilter" class="filter-select" onchange="filterCustomers()">
                                <option value="">All Years</option>
                                <option value="2025">2025</option>
                                <option value="2024">2024</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Size</label>
                            <select id="sizeFilter" class="filter-select" onchange="filterCustomers()">
                                <option value="">All Sizes</option>
                                <option value="XS">XS</option>
                                <option value="S">S</option>
                                <option value="M">M</option>
                                <option value="L">L</option>
                                <option value="XL">XL</option>
                                <option value="XXL">XXL</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">&nbsp;</label>
                            <button class="btn btn-secondary" onclick="clearFilters()">Clear Filters</button>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">üìã Customer Measurements</h2>
                        <span id="customerCount">Showing 156 of 156 customers</span>
                    </div>
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Customer Name</th>
                                    <th>Email</th>
                                    <th>Bust</th>
                                    <th>Waist</th>
                                    <th>Hip</th>
                                    <th>Recommended Size</th>
                                    <th>Order ID</th>
                                </tr>
                            </thead>
                            <tbody id="customerTable">
                                <!-- Dynamic data will be inserted here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Tab 3: Size Chart Management -->
            <div id="sizechart" class="tab-content">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">üìè Size Chart Management</h1>
                        <p class="page-subtitle">Create, edit, and manage your size chart</p>
                    </div>
                    <!-- Unit Toggle -->
                    <div class="unit-toggle-container">
                        <span style="font-size: 0.875rem; color: #6b7280; margin-right: 0.5rem;">Unit:</span>
                        <div class="unit-toggle" id="merchantUnitToggle">
                            <button class="unit-btn active" data-unit="inches" onclick="switchMerchantUnit('inches')">Inches</button>
                            <button class="unit-btn" data-unit="cm" onclick="switchMerchantUnit('cm')">CM</button>
                        </div>
                        <span style="font-size: 0.75rem; color: #9ca3af; margin-left: 0.5rem;" id="unitDetectionInfo">üåç Auto-detected</span>
                    </div>
                </div>

                <div class="alert alert-info">
                    <strong>‚ÑπÔ∏è Note:</strong> Changes to your size chart will be reflected in the measurement form on your product pages. All existing customer measurements will be automatically converted and matched regardless of the unit they use.
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">üìè Current Size Chart</h2>
                        <div>
                            <button class="btn btn-success" onclick="addSizeRow()">‚ûï Add Size</button>
                            <button class="btn btn-primary" onclick="saveSizeChart()">üíæ Save Changes</button>
                            <button class="btn btn-warning" onclick="testUnitConversion()">üß™ Test Conversion</button>
                        </div>
                    </div>
                    
                    <div class="size-chart-editor" id="sizeChartEditor">
                        <div class="size-row" style="font-weight: 600; background: #f7fafc; padding: 0.5rem; border-radius: 6px;">
                            <div>Size</div>
                            <div id="bustHeader">Bust (inches)</div>
                            <div id="waistHeader">Waist (inches)</div>
                            <div id="hipHeader">Hip (inches)</div>
                            <div>Action</div>
                        </div>
                        <!-- Dynamic size rows will be inserted here -->
                    </div>
                </div>

            </div>

            <!-- Tab 4: Billing Overview & Plans -->
            <div id="billing" class="tab-content">
                <div class="page-header">
                    <h1 class="page-title">üí∞ Billing Overview</h1>
                    <p class="page-subtitle">Current month's usage and available plans</p>
                </div>

                <div class="billing-summary">
                    <h2 style="margin-bottom: 1.5rem;">This Month's Summary</h2>
                    <div class="billing-grid">
                        <div class="billing-item">
                            <div class="billing-item-label">Orders with Measurements</div>
                            <div class="billing-item-value" id="billingOrders">156</div>
                        </div>
                        <div class="billing-item">
                            <div class="billing-item-label">Current Phase</div>
                            <div class="billing-item-value" id="billingTier">Starter</div>
                        </div>
                        <div class="billing-item">
                            <div class="billing-item-label">Rate Per Order</div>
                            <div class="billing-item-value" id="billingRate">$0.12</div>
                        </div>
                        <div class="billing-item">
                            <div class="billing-item-label">Estimated Charge</div>
                            <div class="billing-item-value" id="billingTotal">$18.72</div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">üìã Billing Phases & Features</h2>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 2rem;">
                        <!-- Starter Phase -->
                        <div style="background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 12px; padding: 2rem;">
                            <div style="text-align: center; margin-bottom: 1.5rem;">
                                <h3 style="color: #2d3748; font-size: 1.8rem; margin-bottom: 0.5rem;">üå± Starter Phase</h3>
                                <p style="color: #718096; margin-bottom: 1rem;">Perfect for growing stores</p>
                                <div style="font-size: 3rem; font-weight: bold; color: #667eea; margin: 1rem 0;">$0.12</div>
                                <p style="color: #4a5568; font-size: 1.1rem;">per order</p>
                                <p style="color: #4a5568; font-weight: 600; margin-top: 0.5rem;">1-500 orders/month</p>
                            </div>
                            <hr style="margin: 1.5rem 0; border: none; border-top: 1px solid #e2e8f0;">
                            <h4 style="color: #2d3748; margin-bottom: 1rem;">‚ú® Features Included:</h4>
                            <ul style="list-style: none; padding: 0; color: #4a5568; line-height: 2;">
                                <li>‚úÖ Customer measurement form on product pages</li>
                                <li>‚úÖ Instant size recommendations</li>
                                <li>‚úÖ Measurements saved to orders</li>
                                <li>‚úÖ Customizable size charts</li>
                                <li>‚úÖ Basic analytics dashboard</li>
                                <li>‚úÖ Customer database export</li>
                                <li>‚úÖ "Powered by codizzy" branding</li>
                            </ul>
                        </div>

                        <!-- Professional Phase -->
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 12px; padding: 2rem; box-shadow: 0 8px 30px rgba(102, 126, 234, 0.3);">
                            <div style="text-align: center; margin-bottom: 1.5rem;">
                                <h3 style="font-size: 1.8rem; margin-bottom: 0.5rem;">üöÄ Professional Phase</h3>
                                <p style="opacity: 0.95; margin-bottom: 1rem;">Best value for established stores</p>
                                <div style="font-size: 3rem; font-weight: bold; margin: 1rem 0;">$0.09</div>
                                <p style="font-size: 1.1rem; opacity: 0.95;">per order</p>
                                <p style="font-weight: 600; margin-top: 0.5rem; font-size: 1.05rem;">501-1,500 orders/month</p>
                            </div>
                            <hr style="margin: 1.5rem 0; border: none; border-top: 1px solid rgba(255,255,255,0.3);">
                            <h4 style="margin-bottom: 1rem;">‚ú® All Starter Features, Plus:</h4>
                            <ul style="list-style: none; padding: 0; line-height: 2; opacity: 0.95;">
                                <li>‚úÖ Advanced analytics & insights</li>
                                <li>‚úÖ Size distribution charts</li>
                                <li>‚úÖ Production recommendations</li>
                                <li>‚úÖ Customer filtering by date/size</li>
                                <li>‚úÖ Priority email support</li>
                                <li>‚úÖ Custom branding options</li>
                                <li>‚úÖ Monthly reports & trends</li>
                            </ul>
                            <hr style="margin: 1.5rem 0; border: none; border-top: 1px solid rgba(255,255,255,0.3);">
                            <h4 style="margin-bottom: 1rem; background: rgba(255,255,255,0.2); padding: 0.75rem; border-radius: 8px;">üîÑ BULK OPERATIONS INCLUDED</h4>
                            <ul style="list-style: none; padding: 0; line-height: 2; opacity: 0.95;">
                                <li>‚úÖ Bulk import/export (CSV/Excel)</li>
                                <li>‚úÖ Batch email to customers</li>
                                <li>‚úÖ Mass data updates</li>
                                <li>‚úÖ Automated workflows</li>
                            </ul>
                        </div>

                        <!-- Enterprise Phase -->
                        <div style="background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 12px; padding: 2rem;">
                            <div style="text-align: center; margin-bottom: 1.5rem;">
                                <h3 style="color: #2d3748; font-size: 1.8rem; margin-bottom: 0.5rem;">üè¢ Enterprise Phase</h3>
                                <p style="color: #718096; margin-bottom: 1rem;">Maximum value for high-volume stores</p>
                                <div style="font-size: 3rem; font-weight: bold; color: #667eea; margin: 1rem 0;">$0.06</div>
                                <p style="color: #4a5568; font-size: 1.1rem;">per order</p>
                                <p style="color: #4a5568; font-weight: 600; margin-top: 0.5rem;">1,501+ orders/month</p>
                            </div>
                            <hr style="margin: 1.5rem 0; border: none; border-top: 1px solid #e2e8f0;">
                            <h4 style="color: #2d3748; margin-bottom: 1rem;">‚ú® All Professional Features, Plus:</h4>
                            <ul style="list-style: none; padding: 0; color: #4a5568; line-height: 2;">
                                <li>‚úÖ Unlimited size charts</li>
                                <li>‚úÖ Advanced data export (CSV/Excel)</li>
                                <li>‚úÖ API access for integrations</li>
                                <li>‚úÖ Custom measurement fields</li>
                                <li>‚úÖ Dedicated account manager</li>
                                <li>‚úÖ White-label options</li>
                                <li>‚úÖ 24/7 priority support</li>
                                <li>‚úÖ Custom features on request</li>
                            </ul>
                            <hr style="margin: 1.5rem 0; border: none; border-top: 1px solid #e2e8f0;">
                            <h4 style="color: #2d3748; margin-bottom: 1rem; background: #ecfdf5; padding: 0.75rem; border-radius: 8px; border-left: 4px solid #10b981;">üîÑ UNLIMITED BULK OPERATIONS</h4>
                            <ul style="list-style: none; padding: 0; color: #4a5568; line-height: 2;">
                                <li>‚úÖ Unlimited bulk imports</li>
                                <li>‚úÖ Advanced export filters</li>
                                <li>‚úÖ Custom automation workflows</li>
                                <li>‚úÖ Priority processing queue</li>
                            </ul>
                        </div>
                    </div>
                </div>

            </div>
            </div>
            
            <!-- Tab 5: Bulk Operations (Professional & Enterprise Only) -->
            <div id="bulk-operations" class="tab-content">
                <div class="page-header">
                    <h1 class="page-title">üîÑ Bulk Operations Center</h1>
                    <p class="page-subtitle">Import, export, and automate customer data management at scale</p>
                    <span style="display: inline-block; background: linear-gradient(135deg, #f59e0b, #d97706); color: white; padding: 6px 12px; border-radius: 20px; font-size: 0.875rem; font-weight: 600; margin-left: 1rem;">
                        Professional & Enterprise Feature
                    </span>
                </div>
                
                <!-- Access Control Check -->
                <div id="bulk-operations-locked" style="display: block;">
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; padding: 3rem; text-align: center; color: white; margin-bottom: 2rem;">
                        <div style="font-size: 4rem; margin-bottom: 1rem;">üîí</div>
                        <h2 style="font-size: 2rem; margin-bottom: 1rem;">Professional & Enterprise Feature</h2>
                        <p style="font-size: 1.125rem; margin-bottom: 1rem; opacity: 0.9;">
                            This feature is exclusively available for merchants on Professional or Enterprise phase.
                        </p>
                        <p style="font-size: 1rem; margin-bottom: 2rem; opacity: 0.85;">
                            To access Bulk Operations, you must be subscribed to Professional Phase (501-1,500 orders) or Enterprise Phase (1,501+ orders).
                        </p>
                        <button class="btn btn-primary" style="background: white; color: #667eea; padding: 1rem 2rem; font-size: 1.125rem; margin: 0.5rem;" onclick="showTab('billing')">
                            View Phase Details
                        </button>
                    </div>
                    
                    <!-- Feature Preview -->
                    <div style="background: white; border-radius: 12px; padding: 2rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <h3 style="font-size: 1.5rem; margin-bottom: 1.5rem;">‚ú® What You'll Get with Bulk Operations:</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
                            <div style="padding: 1.5rem; background: #f8fafc; border-radius: 8px; border-left: 4px solid #667eea;">
                                <div style="font-size: 2rem; margin-bottom: 0.5rem;">üì•</div>
                                <h4 style="font-weight: 600; margin-bottom: 0.5rem;">Bulk Import</h4>
                                <p style="color: #6b7280; font-size: 0.875rem;">Import hundreds of customer measurements from CSV or Excel files instantly.</p>
                            </div>
                            <div style="padding: 1.5rem; background: #f8fafc; border-radius: 8px; border-left: 4px solid #10b981;">
                                <div style="font-size: 2rem; margin-bottom: 0.5rem;">üì§</div>
                                <h4 style="font-weight: 600; margin-bottom: 0.5rem;">Advanced Export</h4>
                                <p style="color: #6b7280; font-size: 0.875rem;">Export all data with custom filters to CSV, Excel, or JSON format.</p>
                            </div>
                            <div style="padding: 1.5rem; background: #f8fafc; border-radius: 8px; border-left: 4px solid #f59e0b;">
                                <div style="font-size: 2rem; margin-bottom: 0.5rem;">‚ö°</div>
                                <h4 style="font-weight: 600; margin-bottom: 0.5rem;">Batch Actions</h4>
                                <p style="color: #6b7280; font-size: 0.875rem;">Email, update, tag, or delete multiple records with one click.</p>
                            </div>
                            <div style="padding: 1.5rem; background: #f8fafc; border-radius: 8px; border-left: 4px solid #8b5cf6;">
                                <div style="font-size: 2rem; margin-bottom: 0.5rem;">ü§ñ</div>
                                <h4 style="font-weight: 600; margin-bottom: 0.5rem;">Automation</h4>
                                <p style="color: #6b7280; font-size: 0.875rem;">Set up automated workflows to save time on repetitive tasks.</p>
                            </div>
                        </div>
                        
                        <div style="margin-top: 2rem; padding: 1.5rem; background: #ecfdf5; border-radius: 8px; border-left: 4px solid #10b981;">
                            <p style="margin-bottom: 0.5rem;"><strong>üí∞ Time Savings:</strong></p>
                            <ul style="color: #6b7280; margin-left: 1.5rem;">
                                <li>Process 1,000 records in 5 minutes (vs 1 hour manually)</li>
                                <li>Schedule automated weekly reports</li>
                                <li>Bulk update size charts for multiple products</li>
                                <li>Auto-archive old data to keep dashboard clean</li>
                            </ul>
                        </div>
                    </div>
                </div>
                
                <!-- Actual Bulk Operations Content (Hidden until unlocked) -->
                <div id="bulk-operations-content" style="display: none;">
                    <!-- Embedded Bulk Operations directly instead of iframe -->
                    
                    <!-- Progress Section (Hidden by default) -->
                    <div class="card" id="bulkProgressSection" style="display: none; margin-bottom: 2rem;">
                        <div style="font-size: 1.25rem; font-weight: 700; margin-bottom: 1rem;">‚ö° Processing Bulk Operation</div>
                        <div style="background: #e5e7eb; height: 30px; border-radius: 15px; overflow: hidden; margin-bottom: 1rem;">
                            <div id="bulkProgressBar" style="height: 100%; background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); width: 0%; transition: width 0.3s ease; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600;">
                                0%
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-top: 1rem;">
                            <div style="text-align: center; padding: 1rem; background: #f8fafc; border-radius: 8px;">
                                <div style="font-size: 2rem; font-weight: 700; color: #667eea;" id="bulkProcessedCount">0</div>
                                <div style="font-size: 0.875rem; color: #6b7280; margin-top: 0.25rem;">Processed</div>
                            </div>
                            <div style="text-align: center; padding: 1rem; background: #f8fafc; border-radius: 8px;">
                                <div style="font-size: 2rem; font-weight: 700; color: #10b981;" id="bulkSuccessCount">0</div>
                                <div style="font-size: 0.875rem; color: #6b7280; margin-top: 0.25rem;">Successful</div>
                            </div>
                            <div style="text-align: center; padding: 1rem; background: #f8fafc; border-radius: 8px;">
                                <div style="font-size: 2rem; font-weight: 700; color: #ef4444;" id="bulkErrorCount">0</div>
                                <div style="font-size: 0.875rem; color: #6b7280; margin-top: 0.25rem;">Errors</div>
                            </div>
                            <div style="text-align: center; padding: 1rem; background: #f8fafc; border-radius: 8px;">
                                <div style="font-size: 2rem; font-weight: 700; color: #6b7280;" id="bulkRemainingCount">0</div>
                                <div style="font-size: 0.875rem; color: #6b7280; margin-top: 0.25rem;">Remaining</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Main Operations Grid -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 2rem; margin-bottom: 2rem;">
                        <!-- Bulk Import Card -->
                        <div class="card" style="padding: 2rem;">
                            <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem;">
                                <div style="font-size: 2.5rem;">üì•</div>
                                <div style="font-size: 1.5rem; font-weight: 700; color: #1f2937;">Bulk Import</div>
                            </div>
                            <div style="color: #6b7280; margin-bottom: 1.5rem; line-height: 1.6;">
                                Import hundreds of customer measurements at once from CSV or Excel files. Perfect for migrating from other systems or adding historical data.
                            </div>
                            <div id="bulkImportDropZone" onclick="document.getElementById('bulkImportFile').click()" style="border: 2px dashed #d1d5db; border-radius: 8px; padding: 2rem; text-align: center; cursor: pointer; transition: all 0.3s ease; margin-bottom: 1rem;">
                                <div style="font-size: 3rem; margin-bottom: 1rem;">üìÑ</div>
                                <div style="font-weight: 600; margin-bottom: 0.5rem;">Drop file here or click to browse</div>
                                <div style="font-size: 0.875rem; color: #6b7280;">Supports CSV, XLSX (Max 10MB)</div>
                            </div>
                            <input type="file" id="bulkImportFile" accept=".csv,.xlsx" onchange="handleBulkFileImport(event)" style="display: none;">
                            <button class="btn btn-secondary" onclick="downloadBulkTemplate('import')">üìã Download Template</button>
                        </div>
                        
                        <!-- Bulk Export Card -->
                        <div class="card" style="padding: 2rem;">
                            <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem;">
                                <div style="font-size: 2.5rem;">üì§</div>
                                <div style="font-size: 1.5rem; font-weight: 700; color: #1f2937;">Bulk Export</div>
                            </div>
                            <div style="color: #6b7280; margin-bottom: 1.5rem; line-height: 1.6;">
                                Export all customer data with advanced filtering options. Choose date ranges, specific sizes, or custom fields to include.
                            </div>
                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Export Format:</label>
                                <select id="bulkExportFormat" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 1rem;">
                                    <option value="csv">CSV (Comma-separated)</option>
                                    <option value="xlsx">Excel (XLSX)</option>
                                    <option value="json">JSON (Developer)</option>
                                </select>
                            </div>
                            <button class="btn btn-primary" onclick="exportBulkData()">üì• Export All Data</button>
                            <button class="btn btn-secondary" onclick="exportBulkDataFiltered()">üîç Export with Filters</button>
                        </div>
                        
                        <!-- Size Chart Bulk Update Card -->
                        <div class="card" style="padding: 2rem;">
                            <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem;">
                                <div style="font-size: 2.5rem;">üìè</div>
                                <div style="font-size: 1.5rem; font-weight: 700; color: #1f2937;">Size Chart Updates</div>
                            </div>
                            <div style="color: #6b7280; margin-bottom: 1.5rem; line-height: 1.6;">
                                Update size charts for multiple products at once. Upload a CSV with product IDs and new size measurements.
                            </div>
                            <div onclick="document.getElementById('bulkSizeChartFile').click()" style="border: 2px dashed #d1d5db; border-radius: 8px; padding: 2rem; text-align: center; cursor: pointer; transition: all 0.3s ease; margin-bottom: 1rem;">
                                <div style="font-size: 3rem; margin-bottom: 1rem;">üìä</div>
                                <div style="font-weight: 600; margin-bottom: 0.5rem;">Upload Size Chart CSV</div>
                                <div style="font-size: 0.875rem; color: #6b7280;">Bulk update product sizes</div>
                            </div>
                            <input type="file" id="bulkSizeChartFile" accept=".csv" onchange="handleBulkSizeChartImport(event)" style="display: none;">
                            <button class="btn btn-secondary" onclick="downloadBulkTemplate('sizechart')">üìã Download Template</button>
                        </div>
                    </div>
                    
                    <!-- Batch Actions Section -->
                    <div class="card" style="margin-bottom: 2rem; padding: 2rem;">
                        <div style="font-size: 1.5rem; font-weight: 700; margin-bottom: 1.5rem;">‚ö° Batch Actions</div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                            <div onclick="batchActionHandler('email')" style="padding: 1.5rem; border: 2px solid #e5e7eb; border-radius: 8px; background: white; cursor: pointer; transition: all 0.2s ease; text-align: center;">
                                <div style="font-size: 2rem; margin-bottom: 0.5rem;">üìß</div>
                                <div style="font-weight: 600; margin-bottom: 0.25rem;">Send Emails</div>
                                <div style="font-size: 0.875rem; color: #6b7280;">Email multiple customers</div>
                            </div>
                            
                            <div onclick="batchActionHandler('update')" style="padding: 1.5rem; border: 2px solid #e5e7eb; border-radius: 8px; background: white; cursor: pointer; transition: all 0.2s ease; text-align: center;">
                                <div style="font-size: 2rem; margin-bottom: 0.5rem;">‚úèÔ∏è</div>
                                <div style="font-weight: 600; margin-bottom: 0.25rem;">Bulk Update</div>
                                <div style="font-size: 0.875rem; color: #6b7280;">Update multiple records</div>
                            </div>
                            
                            <div onclick="batchActionHandler('tag')" style="padding: 1.5rem; border: 2px solid #e5e7eb; border-radius: 8px; background: white; cursor: pointer; transition: all 0.2s ease; text-align: center;">
                                <div style="font-size: 2rem; margin-bottom: 0.5rem;">üè∑Ô∏è</div>
                                <div style="font-weight: 600; margin-bottom: 0.25rem;">Add Tags</div>
                                <div style="font-size: 0.875rem; color: #6b7280;">Tag customer groups</div>
                            </div>
                            
                            <div onclick="batchActionHandler('delete')" style="padding: 1.5rem; border: 2px solid #e5e7eb; border-radius: 8px; background: white; cursor: pointer; transition: all 0.2s ease; text-align: center;">
                                <div style="font-size: 2rem; margin-bottom: 0.5rem;">üóëÔ∏è</div>
                                <div style="font-weight: 600; margin-bottom: 0.25rem;">Bulk Delete</div>
                                <div style="font-size: 0.875rem; color: #6b7280;">Remove old records</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Automation Workflows -->
                    <div class="card" style="padding: 2rem;">
                        <div style="font-size: 1.5rem; font-weight: 700; margin-bottom: 1.5rem;">ü§ñ Automated Workflows</div>
                        
                        <div style="border: 2px solid #e5e7eb; border-radius: 8px; padding: 1.5rem; margin-bottom: 1rem; display: flex; justify-content: space-between; align-items: center;">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; margin-bottom: 0.5rem;">Auto-email New Measurements</div>
                                <div style="font-size: 0.875rem; color: #6b7280;">Automatically send confirmation email when customers complete measurements</div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 1rem;">
                                <div class="toggle-switch active" onclick="toggleBulkWorkflow(this)" style="position: relative; width: 60px; height: 30px; background: #10b981; border-radius: 15px; cursor: pointer; transition: background 0.3s ease;">
                                    <div class="toggle-slider" style="position: absolute; top: 3px; left: 33px; width: 24px; height: 24px; background: white; border-radius: 50%; transition: left 0.3s ease;"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div style="border: 2px solid #e5e7eb; border-radius: 8px; padding: 1.5rem; margin-bottom: 1rem; display: flex; justify-content: space-between; align-items: center;">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; margin-bottom: 0.5rem;">Weekly Analytics Report</div>
                                <div style="font-size: 0.875rem; color: #6b7280;">Receive weekly summary of size recommendations and conversions</div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 1rem;">
                                <div class="toggle-switch active" onclick="toggleBulkWorkflow(this)" style="position: relative; width: 60px; height: 30px; background: #10b981; border-radius: 15px; cursor: pointer; transition: background 0.3s ease;">
                                    <div class="toggle-slider" style="position: absolute; top: 3px; left: 33px; width: 24px; height: 24px; background: white; border-radius: 50%; transition: left 0.3s ease;"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div style="border: 2px solid #e5e7eb; border-radius: 8px; padding: 1.5rem; margin-bottom: 1rem; display: flex; justify-content: space-between; align-items: center;">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; margin-bottom: 0.5rem;">Auto-archive Old Data</div>
                                <div style="font-size: 0.875rem; color: #6b7280;">Automatically archive customer data older than 2 years</div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 1rem;">
                                <div class="toggle-switch" onclick="toggleBulkWorkflow(this)" style="position: relative; width: 60px; height: 30px; background: #d1d5db; border-radius: 15px; cursor: pointer; transition: background 0.3s ease;">
                                    <div class="toggle-slider" style="position: absolute; top: 3px; left: 3px; width: 24px; height: 24px; background: white; border-radius: 50%; transition: left 0.3s ease;"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div style="border: 2px solid #e5e7eb; border-radius: 8px; padding: 1.5rem; margin-bottom: 1rem; display: flex; justify-content: space-between; align-items: center;">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; margin-bottom: 0.5rem;">Size Chart Sync Alert</div>
                                <div style="font-size: 0.875rem; color: #6b7280;">Get notified when size charts are out of sync with products</div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 1rem;">
                                <div class="toggle-switch" onclick="toggleBulkWorkflow(this)" style="position: relative; width: 60px; height: 30px; background: #d1d5db; border-radius: 15px; cursor: pointer; transition: background 0.3s ease;">
                                    <div class="toggle-slider" style="position: absolute; top: 3px; left: 3px; width: 24px; height: 24px; background: white; border-radius: 50%; transition: left 0.3s ease;"></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Templates Section -->
                        <div style="background: #f8fafc; border-radius: 8px; padding: 1.5rem; margin-top: 1.5rem;">
                            <div style="font-weight: 600; margin-bottom: 1rem;">üìã Import/Export Templates</div>
                            
                            <div onclick="downloadBulkTemplate('customer')" style="background: white; border: 1px solid #e5e7eb; border-radius: 6px; padding: 1rem; margin-bottom: 0.75rem; cursor: pointer; transition: all 0.2s ease;">
                                <strong>Customer Data Template</strong>
                                <div style="font-size: 0.875rem; color: #6b7280; margin-top: 0.25rem;">CSV template for importing customer measurements</div>
                            </div>
                            
                            <div onclick="downloadBulkTemplate('sizechart')" style="background: white; border: 1px solid #e5e7eb; border-radius: 6px; padding: 1rem; margin-bottom: 0.75rem; cursor: pointer; transition: all 0.2s ease;">
                                <strong>Size Chart Template</strong>
                                <div style="font-size: 0.875rem; color: #6b7280; margin-top: 0.25rem;">CSV template for bulk size chart updates</div>
                            </div>
                            
                            <div onclick="downloadBulkTemplate('products')" style="background: white; border: 1px solid #e5e7eb; border-radius: 6px; padding: 1rem; cursor: pointer; transition: all 0.2s ease;">
                                <strong>Product Mapping Template</strong>
                                <div style="font-size: 0.875rem; color: #6b7280; margin-top: 0.25rem;">Map products to size charts</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            </div>
        </div>
    </div>

    <!-- Include billing system -->
    <script src="per-order-billing-system.js"></script>

    <script>
        // ===== CONFIGURATION =====
        // Change this to your Shopify app's URL (default: localhost:3001 for dashboard API)
        const API_BASE_URL = localStorage.getItem('idealfit_api_url') || 'https://idealfit-backend.onrender.com';
        
        // Initialize customer data (will be replaced with real data from API)
        let customerData = [];
        
        // Current merchant phase (stored in localStorage)
        let currentPhase = localStorage.getItem('idealfit_merchant_phase') || 'Starter';
        
        // ===== NOTIFICATION SYSTEM =====
        let notifications = [];
        let notificationCount = 0;
        
        // Notification types and icons
        const notificationTypes = {
            success: { icon: '‚úÖ', color: 'success' },
            warning: { icon: '‚ö†Ô∏è', color: 'warning' },
            error: { icon: '‚ùå', color: 'error' },
            info: { icon: '‚ÑπÔ∏è', color: 'info' }
        };
        
        // Create and show notification
        function showNotification(title, message, type = 'info', duration = 5000, actions = []) {
            const notification = {
                id: Date.now(),
                title,
                message,
                type,
                timestamp: new Date(),
                actions
            };
            
            notifications.push(notification);
            notificationCount++;
            updateNotificationBadge();
            
            const notificationElement = createNotificationElement(notification);
            const container = document.getElementById('notificationContainer');
            container.appendChild(notificationElement);
            
            // Show notification with animation
            setTimeout(() => {
                notificationElement.classList.add('show');
            }, 100);
            
            // Auto-hide after duration
            if (duration > 0) {
                setTimeout(() => {
                    hideNotification(notification.id);
                }, duration);
            }
        }
        
        // Create notification DOM element
        function createNotificationElement(notification) {
            const div = document.createElement('div');
            div.className = `notification ${notification.type}`;
            div.id = `notification-${notification.id}`;
            
            const typeInfo = notificationTypes[notification.type] || notificationTypes.info;
            
            div.innerHTML = `
                <div class="notification-header">
                    <div style="display: flex; align-items: center;">
                        <span class="notification-icon">${typeInfo.icon}</span>
                        <span class="notification-title">${notification.title}</span>
                    </div>
                    <button class="notification-close" onclick="hideNotification(${notification.id})">√ó</button>
                </div>
                <div class="notification-message">${notification.message}</div>
                ${notification.actions.length > 0 ? `
                    <div class="notification-actions">
                        ${notification.actions.map(action => `
                            <button class="notification-btn notification-btn-${action.type}" onclick="${action.onclick}">
                                ${action.text}
                            </button>
                        `).join('')}
                    </div>
                ` : ''}
            `;
            
            return div;
        }
        
        // Hide notification
        function hideNotification(id) {
            const notification = document.getElementById(`notification-${id}`);
            if (notification) {
                notification.classList.remove('show');
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }
            
            // Remove from array
            notifications = notifications.filter(n => n.id !== id);
            notificationCount = Math.max(0, notificationCount - 1);
            updateNotificationBadge();
        }
        
        // Update notification badge
        function updateNotificationBadge() {
            const badge = document.getElementById('notificationBadge');
            if (badge) {
                if (notificationCount > 0) {
                    badge.textContent = notificationCount > 99 ? '99+' : notificationCount;
                    badge.style.display = 'flex';
                } else {
                    badge.style.display = 'none';
                }
            }
        }
        
        // Toggle notifications panel (for future use)
        function toggleNotifications() {
            showNotification(
                'Notifications',
                `You have ${notificationCount} unread notifications.`,
                'info',
                3000,
                [
                    { text: 'View All', type: 'primary', onclick: 'viewAllNotifications()' },
                    { text: 'Mark Read', type: 'secondary', onclick: 'markAllRead()' }
                ]
            );
        }
        
        // View all notifications
        function viewAllNotifications() {
            showNotification('All Notifications', 'This feature will show a notification history panel.', 'info');
        }
        
        // Mark all as read
        function markAllRead() {
            notifications = [];
            notificationCount = 0;
            updateNotificationBadge();
            showNotification('Success', 'All notifications marked as read.', 'success');
        }
        
        // ===== PAYMENT NOTIFICATION HELPERS =====
        
        // Show payment reminder based on days remaining
        function showPaymentReminder(invoiceAmount, daysRemaining, invoiceNumber) {
            let title, message, type, duration;
            
            if (daysRemaining >= 5) {
                // Early reminder (5-7 days) - NO AMOUNT SHOWN
                title = 'Payment Reminder';
                message = `Your invoice #${invoiceNumber} is due in ${daysRemaining} days. Please ensure payment is processed before the due date to avoid service interruption.`;
                type = 'info';
                duration = 8000;
            } else if (daysRemaining >= 3) {
                // Moderate urgency (3-4 days) - NO AMOUNT SHOWN
                title = 'Payment Due Soon';
                message = `Your invoice #${invoiceNumber} is due in ${daysRemaining} days. Your account will be temporarily suspended if payment is not received by the due date.`;
                type = 'warning';
                duration = 10000;
            } else if (daysRemaining >= 1) {
                // High urgency (1-2 days) - NO AMOUNT SHOWN
                title = 'Urgent: Payment Required';
                message = `Your invoice #${invoiceNumber} is due in ${daysRemaining} day${daysRemaining > 1 ? 's' : ''}. Immediate payment is required to prevent account suspension.`;
                type = 'warning';
                duration = 12000;
            } else if (daysRemaining === 0) {
                // Due today - SHOW AMOUNT
                title = 'Payment Due Today';
                message = `Your invoice #${invoiceNumber} for $${invoiceAmount} is due today. Please complete payment immediately to maintain uninterrupted service.`;
                type = 'error';
                duration = 15000;
            } else {
                // Overdue - SHOW AMOUNT
                title = 'Payment Overdue';
                message = `Your invoice #${invoiceNumber} for $${invoiceAmount} is ${Math.abs(daysRemaining)} day${Math.abs(daysRemaining) > 1 ? 's' : ''} overdue. Your account has been suspended. Please complete payment to restore service.`;
                type = 'error';
                duration = 0; // Don't auto-hide
            }
            
            showNotification(
                title,
                message,
                type,
                duration,
                [
                    { text: 'Pay Now', type: 'primary', onclick: 'showTab(\'billing\')' },
                    { text: 'View Invoice', type: 'secondary', onclick: 'showTab(\'billing\')' }
                ]
            );
        }
        
        // Show account suspended notification
        function showAccountSuspendedNotification(invoiceAmount, daysOverdue) {
            showNotification(
                'Account Suspended',
                `Your account has been suspended due to non-payment. Invoice amount: $${invoiceAmount} (${daysOverdue} day${daysOverdue > 1 ? 's' : ''} overdue). Please complete payment immediately to restore full access to your dashboard and services.`,
                'error',
                0, // Don't auto-hide
                [
                    { text: 'Pay Immediately', type: 'primary', onclick: 'showTab(\'billing\')' },
                    { text: 'Contact Support', type: 'secondary', onclick: 'contactSupport()' }
                ]
            );
        }
        
        // ===== UNIT CONVERSION SYSTEM (INCHES/CM) =====
        
        // Global unit state
        let merchantUnit = 'inches'; // inches or cm
        let sizeChartData = []; // Store size chart with original units
        
        // Countries that primarily use inches (US, UK, Canada, India)
        const INCHES_COUNTRIES = ['US', 'GB', 'CA', 'IN', 'LR', 'MM'];
        
        // Conversion functions
        function inchesToCm(inches) {
            return (inches * 2.54).toFixed(2);
        }
        
        function cmToInches(cm) {
            return (cm / 2.54).toFixed(2);
        }
        
        // Convert measurement based on units
        function convertMeasurement(value, fromUnit, toUnit) {
            if (fromUnit === toUnit) return parseFloat(value).toFixed(2);
            if (fromUnit === 'inches' && toUnit === 'cm') return inchesToCm(value);
            if (fromUnit === 'cm' && toUnit === 'inches') return cmToInches(value);
            return value;
        }
        
        // Detect user's country and set primary unit
        async function detectAndSetPrimaryUnit() {
            try {
                // Try to detect country from IP
                const response = await fetch('https://ipapi.co/json/');
                const data = await response.json();
                const countryCode = data.country_code;
                
                // Set unit based on country
                if (INCHES_COUNTRIES.includes(countryCode)) {
                    merchantUnit = 'inches';
                    document.getElementById('unitDetectionInfo').textContent = `üá∫üá∏ ${data.country_name} (Inches)`;
                } else {
                    merchantUnit = 'cm';
                    document.getElementById('unitDetectionInfo').textContent = `üåç ${data.country_name} (CM)`;
                }
                
                // Update toggle UI
                updateUnitToggleUI();
                updateSizeChartHeaders();
                
            } catch (error) {
                // Fallback: detect from browser language
                const lang = navigator.language || navigator.userLanguage;
                if (lang.startsWith('en-US') || lang.startsWith('en-GB') || lang.startsWith('en-CA')) {
                    merchantUnit = 'inches';
                    document.getElementById('unitDetectionInfo').textContent = 'üá∫üá∏ Auto-detected (Inches)';
                } else {
                    merchantUnit = 'cm';
                    document.getElementById('unitDetectionInfo').textContent = 'üåç Auto-detected (CM)';
                }
                updateUnitToggleUI();
                updateSizeChartHeaders();
            }
        }
        
        // Switch merchant unit
        function switchMerchantUnit(unit) {
            console.log(`üîÑ switchMerchantUnit called with unit: ${unit}, current unit: ${merchantUnit}`);
            
            if (merchantUnit === unit) {
                console.log('‚ö†Ô∏è Already on this unit, skipping conversion');
                return; // Already on this unit
            }
            
            const oldUnit = merchantUnit;
            merchantUnit = unit;
            
            console.log(`üìä Unit changed from ${oldUnit} to ${merchantUnit}`);
            
            // Update toggle UI
            updateUnitToggleUI();
            
            // Update headers
            updateSizeChartHeaders();
            
            // Convert existing size chart data
            convertSizeChartDisplay(oldUnit, unit);
            
            // Show notification
            showNotification(
                'Unit Changed',
                `Size chart units changed to ${unit === 'inches' ? 'Inches' : 'Centimeters'}. All measurements have been converted.`,
                'success',
                3000
            );
        }
        
        // Update toggle button UI
        function updateUnitToggleUI() {
            const buttons = document.querySelectorAll('#merchantUnitToggle .unit-btn');
            buttons.forEach(btn => {
                if (btn.getAttribute('data-unit') === merchantUnit) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        }
        
        // Update size chart table headers
        function updateSizeChartHeaders() {
            const unitLabel = merchantUnit === 'inches' ? 'inches' : 'cm';
            document.getElementById('bustHeader').textContent = `Bust (${unitLabel})`;
            document.getElementById('waistHeader').textContent = `Waist (${unitLabel})`;
            document.getElementById('hipHeader').textContent = `Hip (${unitLabel})`;
        }
        
        // Convert size chart display
        function convertSizeChartDisplay(fromUnit, toUnit) {
            console.log(`üîÑ Converting size chart from ${fromUnit} to ${toUnit}`);
            
            const editor = document.getElementById('sizeChartEditor');
            if (!editor) {
                console.error('‚ùå Size chart editor not found');
                return;
            }
            
            const rows = editor.querySelectorAll('.size-row:not(:first-child)');
            console.log(`üìä Found ${rows.length} size rows to convert`);
            
            rows.forEach((row, index) => {
                // Get all inputs in the row (both text and number inputs)
                const allInputs = row.querySelectorAll('input');
                console.log(`üîç Row ${index + 1}: Found ${allInputs.length} total inputs`);
                
                // Find number inputs (bust, waist, hip should be indices 1, 2, 3)
                const numberInputs = Array.from(allInputs).filter(input => input.type === 'number');
                console.log(`üî¢ Row ${index + 1}: Found ${numberInputs.length} number inputs`);
                
                if (numberInputs.length >= 3) {
                    // Convert bust, waist, hip (assuming they are in order)
                    const bustValue = parseFloat(numberInputs[0].value) || 0;
                    const waistValue = parseFloat(numberInputs[1].value) || 0;
                    const hipValue = parseFloat(numberInputs[2].value) || 0;
                    
                    console.log(`üìè Row ${index + 1} original values:`, {bustValue, waistValue, hipValue});
                    
                    const convertedBust = convertMeasurement(bustValue, fromUnit, toUnit);
                    const convertedWaist = convertMeasurement(waistValue, fromUnit, toUnit);
                    const convertedHip = convertMeasurement(hipValue, fromUnit, toUnit);
                    
                    console.log(`üìè Row ${index + 1} converted values:`, {convertedBust, convertedWaist, convertedHip});
                    
                    // Update the input values
                    numberInputs[0].value = convertedBust; // bust
                    numberInputs[1].value = convertedWaist; // waist
                    numberInputs[2].value = convertedHip; // hip
                    
                    console.log(`‚úÖ Row ${index + 1} updated successfully`);
                } else {
                    console.warn(`‚ö†Ô∏è Row ${index + 1} doesn't have enough number inputs for conversion`);
                }
            });
            
            console.log(`üîÑ Size chart conversion completed from ${fromUnit} to ${toUnit}`);
        }

        // Test unit conversion function
        function testUnitConversion() {
            console.log('üß™ Testing unit conversion...');
            console.log('Current unit:', merchantUnit);
            
            // Add a test row if none exist
            const editor = document.getElementById('sizeChartEditor');
            const rows = editor.querySelectorAll('.size-row:not(:first-child)');
            
            if (rows.length === 0) {
                console.log('üìù Adding test row...');
                addSizeRow();
                
                // Set test values
                const newRows = editor.querySelectorAll('.size-row:not(:first-child)');
                if (newRows.length > 0) {
                    const inputs = newRows[0].querySelectorAll('input');
                    inputs[0].value = 'TEST'; // Size
                    inputs[1].value = '32'; // Bust
                    inputs[2].value = '24'; // Waist
                    inputs[3].value = '35'; // Hip
                    console.log('‚úÖ Test row added with values: TEST, 32, 24, 35');
                }
            }
            
            // Test conversion
            const testUnit = merchantUnit === 'inches' ? 'cm' : 'inches';
            console.log(`üîÑ Testing conversion from ${merchantUnit} to ${testUnit}`);
            convertSizeChartDisplay(merchantUnit, testUnit);
            
            // Show result
            alert(`Test conversion completed! Check console for details.\nConverted from ${merchantUnit} to ${testUnit}`);
        }

        // Match customer measurement to size chart (with auto-conversion)
        function findBestSize(customerBust, customerWaist, customerHip, customerUnit) {
            // Convert customer measurements to merchant's unit for comparison
            const convertedBust = parseFloat(convertMeasurement(customerBust, customerUnit, merchantUnit));
            const convertedWaist = parseFloat(convertMeasurement(customerWaist, customerUnit, merchantUnit));
            const convertedHip = parseFloat(convertMeasurement(customerHip, customerUnit, merchantUnit));
            
            // Find best matching size from chart
            let bestSize = 'M'; // Default
            let minDifference = Infinity;
            
            sizeChartData.forEach(size => {
                const bustDiff = Math.abs(size.bust - convertedBust);
                const waistDiff = Math.abs(size.waist - convertedWaist);
                const hipDiff = Math.abs(size.hip - convertedHip);
                const totalDiff = bustDiff + waistDiff + hipDiff;
                
                if (totalDiff < minDifference) {
                    minDifference = totalDiff;
                    bestSize = size.size;
                }
            });
            
            return bestSize;
        }
        
        // Save size chart with unit information
        function saveSizeChartWithUnits() {
            const editor = document.getElementById('sizeChartEditor');
            const rows = editor.querySelectorAll('.size-row:not(:first-child)');
            
            sizeChartData = [];
            rows.forEach(row => {
                const inputs = row.querySelectorAll('input');
                if (inputs.length >= 4) {
                    sizeChartData.push({
                        size: inputs[0].value,
                        bust: parseFloat(inputs[1].value),
                        waist: parseFloat(inputs[2].value),
                        hip: parseFloat(inputs[3].value),
                        unit: merchantUnit // Store the unit used
                    });
                }
            });
            
            // Save to backend/localStorage
            localStorage.setItem('sizeChartData', JSON.stringify(sizeChartData));
            localStorage.setItem('sizeChartUnit', merchantUnit);
            
            console.log('Size chart saved:', sizeChartData);
        }
        
        // Load size chart with unit conversion
        function loadSizeChart() {
            const savedData = localStorage.getItem('sizeChartData');
            const savedUnit = localStorage.getItem('sizeChartUnit') || 'inches';
            
            if (savedData) {
                sizeChartData = JSON.parse(savedData);
                
                // If saved unit differs from current, convert
                if (savedUnit !== merchantUnit) {
                    sizeChartData = sizeChartData.map(size => ({
                        ...size,
                        bust: parseFloat(convertMeasurement(size.bust, savedUnit, merchantUnit)),
                        waist: parseFloat(convertMeasurement(size.waist, savedUnit, merchantUnit)),
                        hip: parseFloat(convertMeasurement(size.hip, savedUnit, merchantUnit)),
                        unit: merchantUnit
                    }));
                }
                
                // Display size chart
                displaySizeChart();
            }
        }
        
        // Display size chart in editor
        function displaySizeChart() {
            const editor = document.getElementById('sizeChartEditor');
            // Clear existing rows (except header)
            const existingRows = editor.querySelectorAll('.size-row:not(:first-child)');
            existingRows.forEach(row => row.remove());
            
            // Add data rows
            sizeChartData.forEach(size => {
                const row = document.createElement('div');
                row.className = 'size-row';
                row.innerHTML = `
                    <input type="text" value="${size.size}" placeholder="XS" style="padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 6px;">
                    <input type="number" step="0.01" value="${size.bust}" placeholder="32" style="padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 6px;">
                    <input type="number" step="0.01" value="${size.waist}" placeholder="24" style="padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 6px;">
                    <input type="number" step="0.01" value="${size.hip}" placeholder="34" style="padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 6px;">
                    <button class="btn btn-danger" onclick="removeSizeRow(this)" style="padding: 0.5rem 1rem;">üóëÔ∏è</button>
                `;
                editor.appendChild(row);
            });
        }
        
        // ===== MOBILE & TOUCH OPTIMIZATIONS =====
        
        // Detect mobile device
        function isMobileDevice() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        }
        
        // Show/hide swipe indicator based on device
        function toggleSwipeIndicator() {
            const indicator = document.querySelector('.swipe-indicator');
            if (indicator && isMobileDevice()) {
                indicator.style.display = 'block';
                setTimeout(() => {
                    indicator.style.display = 'none';
                }, 5000);
            }
        }
        
        // Touch gesture handling
        let touchStartX = 0;
        let touchStartY = 0;
        let touchEndX = 0;
        let touchEndY = 0;
        
        function handleTouchStart(e) {
            touchStartX = e.changedTouches[0].screenX;
            touchStartY = e.changedTouches[0].screenY;
        }
        
        function handleTouchEnd(e) {
            touchEndX = e.changedTouches[0].screenX;
            touchEndY = e.changedTouches[0].screenY;
            handleSwipe();
        }
        
        function handleSwipe() {
            const deltaX = touchEndX - touchStartX;
            const deltaY = touchEndY - touchStartY;
            
            // Only handle horizontal swipes
            if (Math.abs(deltaX) > Math.abs(deltaY) && Math.abs(deltaX) > 50) {
                const currentTab = getCurrentActiveTab();
                const tabs = ['analytics', 'customers', 'sizechart', 'billing', 'bulk-operations'];
                const currentIndex = tabs.indexOf(currentTab);
                
                if (deltaX > 0 && currentIndex > 0) {
                    // Swipe right - go to previous tab
                    showTab(tabs[currentIndex - 1]);
                } else if (deltaX < 0 && currentIndex < tabs.length - 1) {
                    // Swipe left - go to next tab
                    showTab(tabs[currentIndex + 1]);
                }
            }
        }
        
        function getCurrentActiveTab() {
            const activeTab = document.querySelector('.nav-item.active');
            if (activeTab) {
                const onclick = activeTab.getAttribute('onclick');
                const match = onclick.match(/showTab\('(\w+)'\)/);
                return match ? match[1] : 'analytics';
            }
            return 'analytics';
        }
        
        // Add touch event listeners
        function initializeTouchGestures() {
            if (isMobileDevice()) {
                document.addEventListener('touchstart', handleTouchStart, false);
                document.addEventListener('touchend', handleTouchEnd, false);
                
                // Show swipe indicator on mobile
                toggleSwipeIndicator();
                
                // Add mobile-specific classes
                document.body.classList.add('mobile-device');
            }
        }
        
        // Optimize viewport for mobile
        function optimizeViewport() {
            if (isMobileDevice()) {
                // Prevent zoom on input focus
                const inputs = document.querySelectorAll('input, select, textarea');
                inputs.forEach(input => {
                    input.addEventListener('focus', () => {
                        input.style.fontSize = '16px';
                    });
                });
                
                // Add touch-friendly classes
                const buttons = document.querySelectorAll('.btn, .nav-item');
                buttons.forEach(btn => {
                    btn.classList.add('touch-target');
                });
            }
        }
        
        // Mobile menu toggle (for future hamburger menu)
        function toggleMobileMenu() {
            const sidebar = document.querySelector('.sidebar');
            if (sidebar) {
                sidebar.classList.toggle('mobile-open');
            }
        }
        
        // ===== ONBOARDING & TUTORIAL SYSTEM =====
        
        let currentOnboardingStep = 0;
        const onboardingSteps = [
            {
                target: '.sidebar',
                icon: 'üìä',
                title: 'Welcome to IdealFit!',
                content: 'Let\'s take a quick tour of your dashboard. Click "Next" to begin or "Skip" to explore on your own.',
                position: 'right'
            },
            {
                target: '[onclick="showTab(\'analytics\')"]',
                icon: 'üìà',
                title: 'Analytics Dashboard',
                content: 'View your size recommendation analytics, customer trends, and key performance metrics here.',
                position: 'right'
            },
            {
                target: '[onclick="showTab(\'customers\')"]',
                icon: 'üë•',
                title: 'Customer Database',
                content: 'Access all customer measurements, filter by date or size, and export data to Excel.',
                position: 'right'
            },
            {
                target: '[onclick="showTab(\'sizechart\')"]',
                icon: 'üìè',
                title: 'Size Chart Management',
                content: 'Create and edit your size charts here. Changes automatically sync to your storefront!',
                position: 'right'
            },
            {
                target: '[onclick="showTab(\'billing\')"]',
                icon: 'üí∞',
                title: 'Billing & Phases',
                content: 'Monitor your usage, view billing history, and manage your subscription phase.',
                position: 'right'
            },
            {
                target: '.notification-bell',
                icon: 'üîî',
                title: 'Notifications',
                content: 'Stay updated with real-time alerts about new customers, usage limits, and system updates.',
                position: 'bottom'
            },
            {
                target: '.help-button',
                icon: '‚ùì',
                title: 'Need Help?',
                content: 'Click here anytime to restart the tutorial, view shortcuts, or contact support.',
                position: 'left'
            }
        ];
        
        function startOnboarding() {
            // Close help menu
            document.getElementById('helpMenu').classList.remove('active');
            
            // Reset step
            currentOnboardingStep = 0;
            
            // Show onboarding overlay
            const overlay = document.getElementById('onboardingOverlay');
            overlay.classList.add('active');
            
            // Show first step
            showOnboardingStep(currentOnboardingStep);
            
            // Mark as shown
            localStorage.setItem('idealfit_onboarding_shown', 'true');
        }
        
        function showOnboardingStep(step) {
            if (step >= onboardingSteps.length) {
                completeOnboarding();
                return;
            }
            
            const stepData = onboardingSteps[step];
            const target = document.querySelector(stepData.target);
            
            if (!target) {
                // Skip to next step if target not found
                showOnboardingStep(step + 1);
                return;
            }
            
            // Position spotlight
            const rect = target.getBoundingClientRect();
            const spotlight = document.getElementById('onboardingSpotlight');
            spotlight.style.top = `${rect.top - 10}px`;
            spotlight.style.left = `${rect.left - 10}px`;
            spotlight.style.width = `${rect.width + 20}px`;
            spotlight.style.height = `${rect.height + 20}px`;
            
            // Position and populate tooltip
            const tooltip = document.getElementById('onboardingTooltip');
            tooltip.innerHTML = `
                <div class="onboarding-tooltip-header">
                    <div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span class="onboarding-tooltip-icon">${stepData.icon}</span>
                            <div>
                                <div class="onboarding-tooltip-title">${stepData.title}</div>
                                <div class="onboarding-tooltip-step">Step ${step + 1} of ${onboardingSteps.length}</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="onboarding-tooltip-body">${stepData.content}</div>
                <div class="onboarding-tooltip-footer">
                    <div class="onboarding-progress">
                        ${onboardingSteps.map((_, i) => `
                            <div class="onboarding-progress-dot ${i === step ? 'active' : ''}"></div>
                        `).join('')}
                    </div>
                    <div class="onboarding-actions">
                        ${step > 0 ? '<button class="onboarding-btn onboarding-btn-secondary" onclick="previousOnboardingStep()">Back</button>' : ''}
                        <button class="onboarding-btn onboarding-btn-primary" onclick="nextOnboardingStep()">
                            ${step === onboardingSteps.length - 1 ? 'Finish' : 'Next'}
                        </button>
                    </div>
                </div>
                <div style="text-align: center; margin-top: 15px;">
                    <span class="onboarding-skip" onclick="completeOnboarding()">Skip Tour</span>
                </div>
            `;
            
            // Position tooltip based on target position
            positionTooltip(tooltip, rect, stepData.position);
        }
        
        function positionTooltip(tooltip, targetRect, position) {
            const tooltipRect = tooltip.getBoundingClientRect();
            const spacing = 20;
            
            switch(position) {
                case 'right':
                    tooltip.style.left = `${targetRect.right + spacing}px`;
                    tooltip.style.top = `${targetRect.top + (targetRect.height / 2) - 100}px`;
                    break;
                case 'left':
                    tooltip.style.left = `${targetRect.left - tooltipRect.width - spacing}px`;
                    tooltip.style.top = `${targetRect.top + (targetRect.height / 2) - 100}px`;
                    break;
                case 'bottom':
                    tooltip.style.left = `${targetRect.left + (targetRect.width / 2) - 200}px`;
                    tooltip.style.top = `${targetRect.bottom + spacing}px`;
                    break;
                case 'top':
                    tooltip.style.left = `${targetRect.left + (targetRect.width / 2) - 200}px`;
                    tooltip.style.top = `${targetRect.top - tooltipRect.height - spacing}px`;
                    break;
            }
            
            // Ensure tooltip stays within viewport
            const tooltipFinalRect = tooltip.getBoundingClientRect();
            if (tooltipFinalRect.right > window.innerWidth) {
                tooltip.style.left = `${window.innerWidth - tooltipFinalRect.width - 20}px`;
            }
            if (tooltipFinalRect.left < 0) {
                tooltip.style.left = '20px';
            }
            if (tooltipFinalRect.bottom > window.innerHeight) {
                tooltip.style.top = `${window.innerHeight - tooltipFinalRect.height - 20}px`;
            }
        }
        
        function nextOnboardingStep() {
            currentOnboardingStep++;
            showOnboardingStep(currentOnboardingStep);
        }
        
        function previousOnboardingStep() {
            currentOnboardingStep--;
            showOnboardingStep(currentOnboardingStep);
        }
        
        function completeOnboarding() {
            const overlay = document.getElementById('onboardingOverlay');
            overlay.classList.remove('active');
            
            showNotification(
                'Tutorial Complete!',
                'You\'re all set! Click the ? button anytime if you need help.',
                'success',
                5000
            );
        }
        
        // Toggle help menu
        function toggleHelpMenu() {
            const menu = document.getElementById('helpMenu');
            menu.classList.toggle('active');
        }
        
        // Show quick tips
        function showQuickTips() {
            document.getElementById('helpMenu').classList.remove('active');
            
            showNotification(
                'üí° Quick Tips',
                'Swipe left/right on mobile to navigate tabs. Export data from Customer Database. Changes to size charts auto-sync!',
                'info',
                8000,
                [
                    { text: 'Got It', type: 'primary', onclick: 'hideNotification(this.id)' }
                ]
            );
        }
        
        // Show keyboard shortcuts
        function showKeyboardShortcuts() {
            document.getElementById('helpMenu').classList.remove('active');
            
            showNotification(
                '‚å®Ô∏è Keyboard Shortcuts',
                'Coming soon: Keyboard shortcuts for faster navigation!',
                'info',
                4000
            );
        }
        
        // Show FAQ
        function showFAQ() {
            document.getElementById('helpMenu').classList.remove('active');
            
            showNotification(
                '‚ùì FAQ',
                'Visit our help center for frequently asked questions and detailed guides.',
                'info',
                6000,
                [
                    { text: 'Visit Help Center', type: 'primary', onclick: 'window.open("#", "_blank")' },
                    { text: 'Close', type: 'secondary', onclick: 'hideNotification(this.id)' }
                ]
            );
        }
        
        // Contact support
        function contactSupport() {
            document.getElementById('helpMenu').classList.remove('active');
            
            showNotification(
                'üí¨ Contact Support',
                'Need help? Email us at support@idealfit.com or chat with our team.',
                'info',
                8000,
                [
                    { text: 'Email Support', type: 'primary', onclick: 'window.location.href="mailto:support@idealfit.com"' },
                    { text: 'Close', type: 'secondary', onclick: 'hideNotification(this.id)' }
                ]
            );
        }
        
        // Close help menu when clicking outside
        document.addEventListener('click', function(event) {
            const helpMenu = document.getElementById('helpMenu');
            const helpButton = document.getElementById('helpButton');
            
            if (helpMenu && helpButton && !helpMenu.contains(event.target) && !helpButton.contains(event.target)) {
                helpMenu.classList.remove('active');
            }
        });
        
        // ===== BULK OPERATIONS ACCESS CONTROL =====
        
        // Check if bulk operations are available for current phase
        function checkBulkOperationsAccess() {
            // Get phase from billing system or localStorage
            const phase = localStorage.getItem('idealfit_merchant_phase') || 'Starter';
            const hasAccess = phase === 'Professional' || phase === 'Enterprise';
            
            const lockedSection = document.getElementById('bulk-operations-locked');
            const contentSection = document.getElementById('bulk-operations-content');
            const bulkOpsTab = document.getElementById('bulkOpsTab');
            
            if (hasAccess) {
                // User has Professional or Enterprise - unlock feature
                if (lockedSection) lockedSection.style.display = 'none';
                if (contentSection) contentSection.style.display = 'block';
                // Remove PRO badge if they have access
                if (bulkOpsTab) {
                    const badge = bulkOpsTab.querySelector('span[style*="background: #f59e0b"]');
                    if (badge) badge.style.display = 'none';
                }
                return true;
            } else {
                // User is on Starter - show locked screen
                if (lockedSection) lockedSection.style.display = 'block';
                if (contentSection) contentSection.style.display = 'none';
                return false;
            }
        }
        
        // FOR TESTING ONLY - Simulate different phases
        function testProfessionalPhase() {
            localStorage.setItem('idealfit_merchant_phase', 'Professional');
            currentPhase = 'Professional';
            document.getElementById('billingTier').textContent = 'Professional';
            checkBulkOperationsAccess();
            showNotification('Test Mode', 'Phase set to Professional. Bulk Operations unlocked!', 'success', 3000);
        }
        
        function testEnterprisePhase() {
            localStorage.setItem('idealfit_merchant_phase', 'Enterprise');
            currentPhase = 'Enterprise';
            document.getElementById('billingTier').textContent = 'Enterprise';
            checkBulkOperationsAccess();
            showNotification('Test Mode', 'Phase set to Enterprise. All features unlocked!', 'success', 3000);
        }
        
        function testStarterPhase() {
            localStorage.setItem('idealfit_merchant_phase', 'Starter');
            currentPhase = 'Starter';
            document.getElementById('billingTier').textContent = 'Starter';
            checkBulkOperationsAccess();
            showNotification('Test Mode', 'Phase set to Starter. Bulk Operations locked.', 'info', 3000);
        }
        
        // ===== BULK OPERATIONS FUNCTIONS =====
        
        // Handle bulk file import
        function handleBulkFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            console.log('Importing file:', file.name);
            showNotification('Import Started', `Processing ${file.name}...`, 'info', 3000);
            
            // Show progress section
            document.getElementById('bulkProgressSection').style.display = 'block';
            
            // Simulate bulk import process
            simulateBulkImport(500);
        }
        
        // Handle size chart import
        function handleBulkSizeChartImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            console.log('Importing size charts:', file.name);
            showNotification('Size Chart Import', `Processing ${file.name}...`, 'info', 3000);
            document.getElementById('bulkProgressSection').style.display = 'block';
            simulateBulkImport(250);
        }
        
        // Simulate import progress
        function simulateBulkImport(totalRecords) {
            let processed = 0;
            const interval = setInterval(() => {
                processed += Math.floor(Math.random() * 50) + 10;
                if (processed > totalRecords) processed = totalRecords;
                
                const percentage = Math.round((processed / totalRecords) * 100);
                const success = Math.floor(processed * 0.95);
                const errors = processed - success;
                const remaining = totalRecords - processed;
                
                document.getElementById('bulkProgressBar').style.width = percentage + '%';
                document.getElementById('bulkProgressBar').textContent = percentage + '%';
                document.getElementById('bulkProcessedCount').textContent = processed;
                document.getElementById('bulkSuccessCount').textContent = success;
                document.getElementById('bulkErrorCount').textContent = errors;
                document.getElementById('bulkRemainingCount').textContent = remaining;
                
                if (processed >= totalRecords) {
                    clearInterval(interval);
                    setTimeout(() => {
                        showNotification(
                            'Import Complete!',
                            `Successfully imported ${success} records. Errors: ${errors}`,
                            'success',
                            5000
                        );
                        document.getElementById('bulkProgressSection').style.display = 'none';
                    }, 1000);
                }
            }, 200);
        }
        
        // Export bulk data
        function exportBulkData() {
            const format = document.getElementById('bulkExportFormat').value;
            showNotification(
                'Exporting Data',
                `Preparing ${format.toUpperCase()} export with all customer data...`,
                'info',
                3000
            );
            
            setTimeout(() => {
                showNotification(
                    'Export Complete!',
                    `Downloaded: customer_data_export.${format}`,
                    'success',
                    4000
                );
            }, 2000);
        }
        
        // Export with filters
        function exportBulkDataFiltered() {
            showNotification(
                'Advanced Export',
                'Opening filter dialog to customize your export...',
                'info',
                3000
            );
        }
        
        // Download templates
        function downloadBulkTemplate(type) {
            const templates = {
                import: 'Customer_Import_Template.csv',
                sizechart: 'Size_Chart_Template.csv',
                customer: 'Customer_Data_Template.csv',
                products: 'Product_Mapping_Template.csv'
            };
            
            showNotification(
                'Template Downloaded',
                `Downloaded: ${templates[type]}. Fill in your data and re-upload!`,
                'success',
                4000
            );
        }
        
        // Batch actions
        function batchActionHandler(action) {
            const actions = {
                email: 'Send batch emails to selected customers',
                update: 'Update multiple records at once',
                tag: 'Add tags to customer groups',
                delete: 'Remove multiple records (with confirmation)'
            };
            
            showNotification(
                'Batch Action',
                actions[action],
                'info',
                4000
            );
        }
        
        // Toggle workflow
        function toggleBulkWorkflow(element) {
            const slider = element.querySelector('.toggle-slider');
            const isActive = element.classList.contains('active');
            
            if (isActive) {
                // Turn off
                element.classList.remove('active');
                element.style.background = '#d1d5db';
                slider.style.left = '3px';
                showNotification('Workflow Disabled', 'Automation workflow has been turned off.', 'info', 2000);
            } else {
                // Turn on
                element.classList.add('active');
                element.style.background = '#10b981';
                slider.style.left = '33px';
                showNotification('Workflow Enabled', 'Automation workflow is now active.', 'success', 2000);
            }
        }
        
        // Demo notifications for testing
        function showDemoNotifications() {
            setTimeout(() => {
                showNotification(
                    'Welcome to IdealFit!',
                    'Your size recommendation system is now active. Start collecting customer measurements today!',
                    'success',
                    6000,
                    [
                        { text: 'Get Started', type: 'primary', onclick: 'showTab(\'analytics\')' },
                        { text: 'Learn More', type: 'secondary', onclick: 'openSettings()' }
                    ]
                );
            }, 2000);
            
            setTimeout(() => {
                showNotification(
                    'Payment Reminder',
                    'Your invoice #IF-2024-001234 is due in 5 days. Please ensure payment is processed before the due date to avoid service interruption.',
                    'info',
                    8000,
                    [
                        { text: 'View Invoice', type: 'primary', onclick: 'showTab(\'billing\')' },
                        { text: 'Dismiss', type: 'secondary', onclick: 'hideNotification(this.id)' }
                    ]
                );
            }, 5000);
            
            setTimeout(() => {
                showNotification(
                    'New Customer',
                    'Sarah Johnson just completed measurements for Order #12345. Size recommended: Medium.',
                    'info',
                    4000
                );
            }, 8000);
        }
        let originalCustomerData = []; // Keep unfiltered copy
        let analyticsData = null;

        // Initialize size chart (will be replaced with real data from API)
        let sizeChart = [
            { size: 'XS', bust: 30, waist: 25, hip: 35 },
            { size: 'S', bust: 32, waist: 27, hip: 37 },
            { size: 'M', bust: 34, waist: 29, hip: 39 },
            { size: 'L', bust: 36, waist: 31, hip: 41 },
            { size: 'XL', bust: 38, waist: 33, hip: 43 },
            { size: 'XXL', bust: 40, waist: 35, hip: 45 }
        ];

        // ===== DATE FILTER FUNCTIONS =====
        let currentFilters = {};
        
        // Apply quick filters
        function applyQuickFilter(period) {
            const today = new Date();
            let fromDate, toDate = today;
            
            switch(period) {
                case 'today':
                    fromDate = new Date(today);
                    break;
                case 'week':
                    fromDate = new Date(today);
                    fromDate.setDate(today.getDate() - 7);
                    break;
                case 'month':
                    fromDate = new Date(today);
                    fromDate.setMonth(today.getMonth() - 1);
                    break;
                case 'quarter':
                    fromDate = new Date(today);
                    fromDate.setMonth(today.getMonth() - 3);
                    break;
                case 'year':
                    fromDate = new Date(today);
                    fromDate.setFullYear(today.getFullYear() - 1);
                    break;
                case 'all':
                    fromDate = null;
                    toDate = null;
                    break;
            }
            
            // Set date inputs
            if (fromDate) {
                document.getElementById('filterDateFrom').value = fromDate.toISOString().split('T')[0];
            } else {
                document.getElementById('filterDateFrom').value = '';
            }
            
            if (toDate && period !== 'all') {
                document.getElementById('filterDateTo').value = toDate.toISOString().split('T')[0];
            } else {
                document.getElementById('filterDateTo').value = '';
            }
            
            // Clear month/year filters
            document.getElementById('filterMonth').value = '';
            document.getElementById('filterYear').value = '';
            
            // Apply filters
            applyDateFilters();
        }
        
        // Apply date filters
        async function applyDateFilters() {
            const fromDate = document.getElementById('filterDateFrom').value;
            const toDate = document.getElementById('filterDateTo').value;
            const month = document.getElementById('filterMonth').value;
            const year = document.getElementById('filterYear').value;
            
            currentFilters = {};
            
            if (fromDate) currentFilters.dateFrom = fromDate;
            if (toDate) currentFilters.dateTo = toDate;
            if (month) currentFilters.month = month;
            if (year) currentFilters.year = year;
            
            // Show filter status
            let statusText = 'Showing: ';
            if (Object.keys(currentFilters).length === 0) {
                statusText += 'All Time';
            } else {
                const parts = [];
                if (fromDate && toDate) parts.push(`${fromDate} to ${toDate}`);
                else if (fromDate) parts.push(`From ${fromDate}`);
                else if (toDate) parts.push(`Until ${toDate}`);
                if (month) parts.push(`Month: ${document.getElementById('filterMonth').options[document.getElementById('filterMonth').selectedIndex].text}`);
                if (year) parts.push(`Year: ${year}`);
                statusText += parts.join(', ');
            }
            document.getElementById('filterStatus').textContent = statusText;
            
            // Reload data with filters
            await loadAllData();
        }
        
        // Clear date filters
        function clearDateFilters() {
            document.getElementById('filterDateFrom').value = '';
            document.getElementById('filterDateTo').value = '';
            document.getElementById('filterMonth').value = '';
            document.getElementById('filterYear').value = '';
            currentFilters = {};
            document.getElementById('filterStatus').textContent = 'Showing: All Time';
            loadAllData();
        }
        
        // Export filtered data to Excel
        function exportFilteredData() {
            if (!customerData || customerData.length === 0) {
                alert('No data to export!');
                return;
            }
            
            // Create CSV content
            let csv = 'Order Date,Customer Name,Order ID,Product ID,Bust,Waist,Hip,Recommended Size\n';
            
            customerData.forEach(customer => {
                csv += `${customer.date},${customer.name},"${customer.orderId}","${customer.productId}",${customer.bust},${customer.waist},${customer.hip},${customer.size}\n`;
            });
            
            // Add analytics summary
            csv += '\n\nANALYTICS SUMMARY\n';
            csv += `Total Orders,${analyticsData ? analyticsData.totalOrders : 0}\n`;
            csv += `Unique Customers,${analyticsData ? analyticsData.uniqueCustomers : 0}\n`;
            csv += `Most Popular Size,${analyticsData ? analyticsData.mostPopularSize : 'N/A'}\n`;
            csv += '\n\nSIZE DISTRIBUTION\n';
            csv += 'Size,Count,Percentage,Avg Bust,Avg Waist,Avg Hip\n';
            
            if (analyticsData && analyticsData.sizeAnalytics) {
                analyticsData.sizeAnalytics.forEach(size => {
                    csv += `${size.size},${size.count},${size.percentage}%,${size.avgBust},${size.avgWaist},${size.avgHip}\n`;
                });
            }
            
            // Download
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            
            // Create filename with filter info
            let filename = 'idealfit-analytics';
            if (currentFilters.dateFrom && currentFilters.dateTo) {
                filename += `_${currentFilters.dateFrom}_to_${currentFilters.dateTo}`;
            } else if (currentFilters.month && currentFilters.year) {
                filename += `_${currentFilters.year}-${currentFilters.month}`;
            } else if (currentFilters.year) {
                filename += `_${currentFilters.year}`;
            }
            filename += '.csv';
            
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            alert(`‚úÖ Exported ${customerData.length} records to ${filename}`);
        }

        // ===== API FUNCTIONS =====
        async function fetchMeasurements(filters = {}) {
            try {
                const shop = localStorage.getItem('idealfit_shop_domain') || '';
                const params = new URLSearchParams({ shop, ...filters });
                
                console.log(`üîó Fetching from: ${API_BASE_URL}/api/measurements?${params}`);
                
                const response = await fetch(`${API_BASE_URL}/api/shopify/orders?${params}`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    },
                    mode: 'cors'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (Array.isArray(result) && result.length > 0) {
                    // Transform API data to match dashboard format
                    customerData = result.map(order => ({
                        date: order.orderDate,
                        name: order.customer,
                        email: order.customerEmail || 'N/A',
                        bust: order.measurements?.bust || 'N/A',
                        waist: order.measurements?.waist || 'N/A', 
                        hip: order.measurements?.hip || 'N/A',
                        size: order.recommendedSize,
                        orderId: order.id,
                        amount: order.amount,
                        merchant: order.merchant,
                        unit: order.unit || 'inches'
                    }));
                    originalCustomerData = [...customerData];
                    
                    // Calculate analytics from the transformed data
                    analyticsData = {
                        totalOrders: customerData.length,
                        uniqueCustomers: new Set(customerData.map(c => c.name)).size,
                        mostPopularSize: getMostPopularSize(customerData),
                        sizeAnalytics: calculateSizeAnalytics(customerData)
                    };
                    
                    console.log(`‚úÖ Fetched ${result.length} orders from Shopify API`);
                    return result;
                } else {
                    console.warn('No data from API');
                    return null;
                }
            } catch (error) {
                console.error('Failed to fetch measurements:', error);
                
                // Check if it's a CORS issue
                if (error.message.includes('Failed to fetch') || error.message.includes('CORS')) {
                    showDataSourceInfo('‚ùå Cannot connect to Shopify API. Check Render API status.');
                } else {
                    showDataSourceInfo('Using demo data - API connection failed');
                }
                return null;
            }
        }

        // Helper functions for analytics calculation
        function getMostPopularSize(customers) {
            const sizeCounts = {};
            customers.forEach(c => {
                if (c.size && c.size !== 'N/A') {
                    sizeCounts[c.size] = (sizeCounts[c.size] || 0) + 1;
                }
            });
            
            let mostPopular = 'N/A';
            let maxCount = 0;
            Object.entries(sizeCounts).forEach(([size, count]) => {
                if (count > maxCount) {
                    maxCount = count;
                    mostPopular = size;
                }
            });
            
            return mostPopular;
        }

        function calculateSizeAnalytics(customers) {
            const sizeCounts = {};
            const sizeMeasurements = {};
            
            customers.forEach(c => {
                if (c.size && c.size !== 'N/A') {
                    sizeCounts[c.size] = (sizeCounts[c.size] || 0) + 1;
                    
                    if (!sizeMeasurements[c.size]) {
                        sizeMeasurements[c.size] = { bust: [], waist: [], hip: [] };
                    }
                    
                    if (c.bust !== 'N/A') sizeMeasurements[c.size].bust.push(parseFloat(c.bust));
                    if (c.waist !== 'N/A') sizeMeasurements[c.size].waist.push(parseFloat(c.waist));
                    if (c.hip !== 'N/A') sizeMeasurements[c.size].hip.push(parseFloat(c.hip));
                }
            });
            
            const total = customers.length;
            return Object.entries(sizeCounts).map(([size, count]) => {
                const measurements = sizeMeasurements[size];
                return {
                    size,
                    count,
                    percentage: total > 0 ? ((count / total) * 100).toFixed(1) : 0,
                    avgBust: measurements.bust.length > 0 ? (measurements.bust.reduce((a, b) => a + b, 0) / measurements.bust.length).toFixed(1) : 'N/A',
                    avgWaist: measurements.waist.length > 0 ? (measurements.waist.reduce((a, b) => a + b, 0) / measurements.waist.length).toFixed(1) : 'N/A',
                    avgHip: measurements.hip.length > 0 ? (measurements.hip.reduce((a, b) => a + b, 0) / measurements.hip.length).toFixed(1) : 'N/A'
                };
            });
        }

        async function fetchSizeCharts() {
            try {
                const shop = localStorage.getItem('idealfit_shop_domain') || '';
                const response = await fetch(`${API_BASE_URL}/api/shopify/merchants?shop=${shop}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.success && result.data.length > 0) {
                    // Use the most recent size chart
                    sizeChart = result.data[0].data;
                    return result.data[0];
                }
                return null;
            } catch (error) {
                console.error('Failed to fetch size charts:', error);
                return null;
            }
        }

        function showDataSourceInfo(message) {
            const existingAlert = document.querySelector('.data-source-alert');
            if (existingAlert) {
                existingAlert.remove();
            }
            
            const alert = document.createElement('div');
            alert.className = 'alert alert-warning data-source-alert';
            alert.style.position = 'fixed';
            alert.style.top = '80px';
            alert.style.right = '20px';
            alert.style.zIndex = '1500';
            alert.style.maxWidth = '400px';
            alert.innerHTML = `
                <strong>‚ÑπÔ∏è Data Source:</strong> ${message}
                <button onclick="this.parentElement.remove()" style="float: right; background: none; border: none; font-size: 1.5rem; cursor: pointer; line-height: 1;">√ó</button>
            `;
            document.body.appendChild(alert);
            
            // Auto-remove after 5 seconds
            setTimeout(() => alert.remove(), 5000);
        }

        // Login/Signup
        function handleLogin(event) {
            event.preventDefault();
            const email = document.getElementById('emailInput').value;
            
            // Store user info
            localStorage.setItem('idealfit_user_email', email);
            localStorage.setItem('idealfit_user_name', email.split('@')[0]);
            
            // Show dashboard
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainDashboard').classList.add('active');
            document.getElementById('userName').textContent = email.split('@')[0];
            
            // Load data
            loadAllData();
        }

        function showSignup() {
            alert('Sign up functionality would redirect to registration page.\n\nFor demo: Use any email/password to login.');
        }

        function showForgotPassword() {
            const email = prompt('Enter your email address to reset password:');
            if (email) {
                alert('‚úÖ Password reset link sent to ' + email + '\n\nCheck your email for instructions.\n\n(Demo mode: This would send an actual email in production)');
            }
        }

        function handleLogout() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.removeItem('idealfit_user_email');
                localStorage.removeItem('idealfit_user_name');
                document.getElementById('mainDashboard').classList.remove('active');
                document.getElementById('loginScreen').classList.remove('hidden');
            }
        }

        // Settings modal
        function openSettings() {
            const email = localStorage.getItem('idealfit_user_email') || 'merchant@store.com';
            document.getElementById('settingsEmail').value = email;
            document.getElementById('customerId').value = 'CUST-' + Math.floor(Math.random() * 90000 + 10000);
            document.getElementById('settingsModal').classList.add('active');
        }

        function closeSettings() {
            document.getElementById('settingsModal').classList.remove('active');
        }

        // Settings tab navigation
        function showSettingsTab(tabName) {
            // Hide all settings tabs
            document.querySelectorAll('.settings-tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });
            document.querySelectorAll('.settings-tab').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            if (tabName === 'info') {
                document.getElementById('settingsInfo').classList.remove('hidden');
                document.getElementById('infoTab').classList.add('active');
            } else if (tabName === 'billing-settings') {
                document.getElementById('settingsBilling').classList.remove('hidden');
                document.getElementById('billingSettingsTab').classList.add('active');
                loadSettingsBillingHistory();
            } else if (tabName === 'integration') {
                document.getElementById('settingsIntegration').classList.remove('hidden');
                document.getElementById('integrationTab').classList.add('active');
                loadIntegrationStatus();
            }
        }

        // Shopify Integration
        async function connectShopify() {
            const storeUrl = document.getElementById('shopifyStoreUrl').value;
            
            if (!storeUrl) {
                alert('‚ùå Please enter your Shopify Store URL (e.g., mystore.myshopify.com)');
                return;
            }
            
            // Extract shop domain
            const shopDomain = storeUrl.replace('https://', '').replace('http://', '').split('/')[0];
            
            // Save configuration
            localStorage.setItem('idealfit_shop_domain', shopDomain);
            localStorage.setItem('idealfit_shopify_url', storeUrl);
            localStorage.setItem('idealfit_connected', 'true');
            
            // Show loading
            document.getElementById('integrationStatus').innerHTML = `
                <div class="alert alert-info">
                    <strong>‚è≥ Connecting...</strong><br>
                    Fetching data from your Shopify store...
                </div>
            `;
            
            // Try to fetch data
            const result = await fetchMeasurements();
            
            if (result && result.success) {
                // Hide connect button and show connected state
                document.getElementById('connectButton').textContent = '‚úÖ Connected';
                document.getElementById('connectButton').disabled = true;
                document.getElementById('connectButton').style.background = '#10b981';
                document.getElementById('connectButton').style.cursor = 'not-allowed';
                document.getElementById('shopifyStoreUrl').disabled = true;
                
                // Show professional connected status
                document.getElementById('integrationStatus').innerHTML = `
                    <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); padding: 30px; border-radius: 12px; color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px;">
                            <div>
                                <div style="font-size: 48px; margin-bottom: 10px;">‚úÖ</div>
                                <h2 style="margin: 0; font-size: 24px;">Connected</h2>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 14px; opacity: 0.9;">Status</div>
                                <div style="font-size: 20px; font-weight: 700;">ACTIVE</div>
                            </div>
                        </div>
                        
                        <div style="background: rgba(255,255,255,0.2); padding: 20px; border-radius: 8px; margin-top: 20px;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div>
                                    <div style="font-size: 12px; opacity: 0.9;">STORE</div>
                                    <div style="font-size: 16px; font-weight: 600; margin-top: 5px;">${shopDomain}</div>
                                </div>
                                <div>
                                    <div style="font-size: 12px; opacity: 0.9;">MEASUREMENTS</div>
                                    <div style="font-size: 16px; font-weight: 600; margin-top: 5px;">${result.analytics.totalOrders} Orders</div>
                                </div>
                                <div>
                                    <div style="font-size: 12px; opacity: 0.9;">CUSTOMERS</div>
                                    <div style="font-size: 16px; font-weight: 600; margin-top: 5px;">${result.analytics.uniqueCustomers} Unique</div>
                                </div>
                                <div>
                                    <div style="font-size: 12px; opacity: 0.9;">TOP SIZE</div>
                                    <div style="font-size: 16px; font-weight: 600; margin-top: 5px;">${result.analytics.mostPopularSize}</div>
                                </div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.3); font-size: 14px; opacity: 0.9;">
                            üîÑ Your dashboard is syncing real-time data from your Shopify store
                        </div>
                    </div>
                `;
                
                // Reload all data
                loadAllData();
                
                alert(`‚úÖ Shopify integration connected!\n\nüìä Found ${result.analytics.totalOrders} customer measurements.\nüîÑ Dashboard updated with real data.`);
            } else {
                // Show warning - API might not be running
                document.getElementById('integrationStatus').innerHTML = `
                    <div class="alert alert-warning">
                        <h4 style="margin-bottom: 0.5rem;">‚ö†Ô∏è Configuration Saved</h4>
                        <p><strong>Store:</strong> ${shopDomain}</p>
                        <p><strong>Status:</strong> Cannot connect to API</p>
                        <p style="margin-top: 1rem;">
                            Shopify API endpoint: <code>${API_BASE_URL}</code>
                            <br><br>
                            This connects to your deployed Render API server.
                        </p>
                    </div>
                `;
                
                alert('‚ö†Ô∏è Shop configured but API not responding.\n\nThis connects to your deployed Render API server.\n\nCheck if the Render API is online at: https://idealfit-backend.onrender.com');
            }
        }

        function disconnectShopify() {
            if (confirm('Are you sure you want to disconnect Shopify integration?')) {
                localStorage.removeItem('idealfit_shop_domain');
                localStorage.removeItem('idealfit_shopify_url');
                localStorage.removeItem('idealfit_shopify_token');
                
                document.getElementById('shopifyStoreUrl').value = '';
                document.getElementById('shopifyAccessToken').value = '';
                document.getElementById('integrationStatus').innerHTML = `
                    <div class="alert alert-warning">
                        <strong>‚ö†Ô∏è Disconnected</strong><br>
                        Shopify integration has been disconnected. Dashboard will show demo data.
                    </div>
                `;
                
                // Clear data
                customerData = [];
                originalCustomerData = [];
                analyticsData = null;
                
                alert('‚úÖ Shopify integration disconnected. Dashboard cleared.');
            }
        }

        function loadIntegrationStatus() {
            const storeUrl = localStorage.getItem('idealfit_shopify_url');
            const shopDomain = localStorage.getItem('idealfit_shop_domain');
            const isConnected = localStorage.getItem('idealfit_connected');
            
            if (isConnected && shopDomain) {
                // Show store URL (disabled)
                document.getElementById('shopifyStoreUrl').value = storeUrl || shopDomain;
                document.getElementById('shopifyStoreUrl').disabled = true;
                
                // Update button to show connected
                document.getElementById('connectButton').textContent = '‚úÖ Connected';
                document.getElementById('connectButton').disabled = true;
                document.getElementById('connectButton').style.background = '#10b981';
                document.getElementById('connectButton').style.cursor = 'not-allowed';
                
                // Show connected status (fetch current stats)
                fetchMeasurements().then(result => {
                    if (result && result.success) {
                        document.getElementById('integrationStatus').innerHTML = `
                            <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); padding: 30px; border-radius: 12px; color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px;">
                                    <div>
                                        <div style="font-size: 48px; margin-bottom: 10px;">‚úÖ</div>
                                        <h2 style="margin: 0; font-size: 24px;">Connected</h2>
                                    </div>
                                    <div style="text-align: right;">
                                        <div style="font-size: 14px; opacity: 0.9;">Status</div>
                                        <div style="font-size: 20px; font-weight: 700;">ACTIVE</div>
                                    </div>
                                </div>
                                
                                <div style="background: rgba(255,255,255,0.2); padding: 20px; border-radius: 8px;">
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                        <div>
                                            <div style="font-size: 12px; opacity: 0.9;">STORE</div>
                                            <div style="font-size: 16px; font-weight: 600; margin-top: 5px;">${shopDomain}</div>
                                        </div>
                                        <div>
                                            <div style="font-size: 12px; opacity: 0.9;">MEASUREMENTS</div>
                                            <div style="font-size: 16px; font-weight: 600; margin-top: 5px;">${result.analytics.totalOrders} Orders</div>
                                        </div>
                                        <div>
                                            <div style="font-size: 12px; opacity: 0.9;">CUSTOMERS</div>
                                            <div style="font-size: 16px; font-weight: 600; margin-top: 5px;">${result.analytics.uniqueCustomers} Unique</div>
                                        </div>
                                        <div>
                                            <div style="font-size: 12px; opacity: 0.9;">TOP SIZE</div>
                                            <div style="font-size: 16px; font-weight: 600; margin-top: 5px;">${result.analytics.mostPopularSize}</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.3); font-size: 14px; opacity: 0.9;">
                                    üîÑ Your dashboard is syncing real-time data from your Shopify store
                                </div>
                            </div>
                        `;
                    }
                });
            } else {
                document.getElementById('integrationStatus').innerHTML = `
                    <div class="alert alert-warning">
                        <strong>‚ö†Ô∏è Not Connected</strong><br>
                        Connect your Shopify store to sync real-time data with this dashboard.
                    </div>
                `;
            }
        }

        // Load billing history in settings
        function loadSettingsBillingHistory() {
            const selectedMonth = document.getElementById('settingsBillingMonth').value;
            
            const billingData = {
                '2025-10': { month: 'October 2025', orders: 156, plan: 'Starter Phase', rate: 0.12, total: 18.72, status: 'Pending' },
                '2025-09': { month: 'September 2025', orders: 423, plan: 'Starter Phase', rate: 0.12, total: 50.76, status: 'Paid' },
                '2025-08': { month: 'August 2025', orders: 387, plan: 'Starter Phase', rate: 0.12, total: 46.44, status: 'Paid' },
                '2025-07': { month: 'July 2025', orders: 512, plan: 'Professional Phase', rate: 0.09, total: 46.08, status: 'Paid' },
                '2025-06': { month: 'June 2025', orders: 298, plan: 'Starter Phase', rate: 0.12, total: 35.76, status: 'Paid' }
            };
            
            const data = billingData[selectedMonth];
            
            document.getElementById('settingsBillingDetail').innerHTML = `
                <div class="alert alert-info" style="margin-top: 1rem;">
                    <h4 style="margin-bottom: 1rem;">üìä ${data.month} Invoice</h4>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
                        <div>
                            <p style="color: #2a4365; margin-bottom: 0.5rem;"><strong>Orders:</strong></p>
                            <p style="font-size: 1.3rem; font-weight: bold; color: #2d3748;">${data.orders}</p>
                        </div>
                        <div>
                            <p style="color: #2a4365; margin-bottom: 0.5rem;"><strong>Phase:</strong></p>
                            <p style="font-size: 1.3rem; font-weight: bold; color: #2d3748;">${data.plan}</p>
                        </div>
                        <div>
                            <p style="color: #2a4365; margin-bottom: 0.5rem;"><strong>Rate:</strong></p>
                            <p style="font-size: 1.3rem; font-weight: bold; color: #2d3748;">$${data.rate.toFixed(2)}</p>
                        </div>
                        <div>
                            <p style="color: #2a4365; margin-bottom: 0.5rem;"><strong>Total:</strong></p>
                            <p style="font-size: 1.3rem; font-weight: bold; color: #667eea;">$${data.total.toFixed(2)}</p>
                        </div>
                    </div>
                    <hr style="margin: 1rem 0; border: none; border-top: 1px solid rgba(0,0,0,0.1);">
                    <p style="font-size: 1.1rem;"><strong>Calculation:</strong> ${data.orders} √ó $${data.rate.toFixed(2)} = $${data.total.toFixed(2)}</p>
                    <p style="margin-top: 1rem;"><strong>Status:</strong> <span class="badge ${data.status === 'Paid' ? 'badge-success' : 'badge-warning'}">${data.status}</span></p>
                </div>
            `;
        }

        function changePassword() {
            const current = document.getElementById('currentPassword').value;
            const newPass = document.getElementById('newPassword').value;
            const confirm = document.getElementById('confirmPassword').value;
            
            if (!current || !newPass || !confirm) {
                alert('‚ùå Please fill in all password fields');
                return;
            }
            
            if (newPass !== confirm) {
                alert('‚ùå New passwords do not match!');
                return;
            }
            
            if (newPass.length < 6) {
                alert('‚ùå Password must be at least 6 characters');
                return;
            }
            
            // In production, this would call your API
            alert('‚úÖ Password changed successfully!');
            document.getElementById('currentPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
            closeSettings();
        }

        // Tab navigation
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            // Load tab-specific data
            if (tabName === 'analytics') loadAnalytics();
            if (tabName === 'customers') loadCustomers();
            if (tabName === 'sizechart') loadSizeChart();
            if (tabName === 'billing') loadBilling();
            if (tabName === 'bulk-operations') checkBulkOperationsAccess();
        }

        // Load all data
        async function loadAllData() {
            // Show loading state
            showDataSourceInfo('Loading data...');
            
            // Fetch real data from API with current filters
            const measurementsResult = await fetchMeasurements(currentFilters);
            const sizeChartResult = await fetchSizeCharts();
            
            if (measurementsResult && measurementsResult.success) {
                const filterInfo = Object.keys(currentFilters).length > 0 ? ' (filtered)' : '';
                showDataSourceInfo(`‚úÖ Loaded ${measurementsResult.analytics.totalOrders} real measurements from database${filterInfo}`);
            }
            
            // Load all tabs
            loadAnalytics();
            loadCustomers();
            loadSizeChart();
            loadBilling();
        }

        // Load analytics
        function loadAnalytics() {
            // Update stats cards
            if (analyticsData) {
                document.getElementById('totalOrders').textContent = analyticsData.totalOrders || 0;
                document.getElementById('uniqueCustomers').textContent = analyticsData.uniqueCustomers || 0;
                document.getElementById('mostPopularSize').textContent = analyticsData.mostPopularSize || 'N/A';
                
                // Calculate estimated return reduction (placeholder calculation)
                const returnReduction = analyticsData.totalOrders > 0 ? '32%' : '0%';
                document.getElementById('returnReduction').textContent = returnReduction;
                
                // Update size comparison table
                updateSizeComparisonTable();
                
                // Generate dynamic production insights
                generateProductionInsights();
            } else {
                // Show zeros if no data
                document.getElementById('totalOrders').textContent = '0';
                document.getElementById('uniqueCustomers').textContent = '0';
                document.getElementById('mostPopularSize').textContent = 'N/A';
                document.getElementById('returnReduction').textContent = '0%';
                
                // Show default insight
                document.getElementById('productionInsight').innerHTML = '<strong>üí° Production Insight:</strong> No data available yet. Start collecting customer measurements to get inventory recommendations!';
            }
            
            createSizeDistributionChart();
        }
        
        // Generate professional production insights with visual cards
        function generateProductionInsights() {
            if (!analyticsData || !analyticsData.sizeAnalytics || analyticsData.sizeAnalytics.length === 0) {
                document.getElementById('recommendationCards').innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #64748b;">
                        <div style="font-size: 48px; margin-bottom: 10px;">üìä</div>
                        <h3 style="color: #475569;">No Data Available Yet</h3>
                        <p>Start collecting customer measurements to get AI-powered inventory recommendations!</p>
                    </div>
                `;
                document.getElementById('insightDetails').innerHTML = 'Waiting for customer data...';
                document.getElementById('actionList').innerHTML = '<li>Add the measurement form to your product pages</li><li>Encourage customers to enter their measurements</li>';
                document.getElementById('confidenceLevel').innerHTML = '<span style="color: #dc2626;">Low - Need more data</span>';
                return;
            }
            
            const sizeData = analyticsData.sizeAnalytics;
            const totalOrders = analyticsData.totalOrders;
            
            // Sort by count to find top sizes
            const sortedSizes = [...sizeData].sort((a, b) => b.count - a.count);
            
            // Get top sizes and low demand sizes
            const topSizes = sortedSizes.slice(0, 2);
            const topSizesPercentage = topSizes.reduce((sum, s) => sum + parseFloat(s.percentage), 0);
            const lowDemandSizes = sizeData.filter(s => parseFloat(s.percentage) < 10 && s.size !== 'N/A');
            const highDemandSizes = sizeData.filter(s => parseFloat(s.percentage) >= 20);
            
            // Generate Recommendation Cards
            let cardsHTML = '';
            
            // Card 1: Top Performing Sizes
            if (topSizes.length > 0) {
                const topSizesList = topSizes.map(s => `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #e0e7ff;">
                        <span style="font-size: 18px; font-weight: 600; color: #4f46e5;">Size ${s.size}</span>
                        <span style="font-size: 24px; font-weight: 700; color: #4f46e5;">${s.percentage}%</span>
                    </div>
                `).join('');
                
                cardsHTML += `
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 12px; color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                        <div style="font-size: 14px; opacity: 0.9; margin-bottom: 5px;">üèÜ TOP PERFORMERS</div>
                        <div style="font-size: 32px; font-weight: 700; margin: 10px 0;">${topSizesPercentage.toFixed(1)}%</div>
                        <div style="font-size: 14px; opacity: 0.9;">of all recommendations</div>
                        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.3);">
                            <div style="font-weight: 600; margin-bottom: 8px;">Focus Production On:</div>
                            ${topSizes.map(s => `<div style="font-size: 18px;">üìç Size ${s.size} (${s.count} orders)</div>`).join('')}
                        </div>
                    </div>
                `;
            }
            
            // Card 2: High Demand Sizes
            if (highDemandSizes.length > 0) {
                cardsHTML += `
                    <div style="background: #10b981; padding: 20px; border-radius: 12px; color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                        <div style="font-size: 14px; opacity: 0.9; margin-bottom: 5px;">üî• HIGH DEMAND</div>
                        <div style="font-size: 32px; font-weight: 700; margin: 10px 0;">${highDemandSizes.length}</div>
                        <div style="font-size: 14px; opacity: 0.9;">size(s) with 20%+ demand</div>
                        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.3);">
                            <div style="font-weight: 600; margin-bottom: 8px;">Increase Stock:</div>
                            ${highDemandSizes.map(s => `<div>‚úÖ Size ${s.size} - ${s.percentage}%</div>`).join('')}
                        </div>
                    </div>
                `;
            }
            
            // Card 3: Low Demand Sizes
            if (lowDemandSizes.length > 0) {
                cardsHTML += `
                    <div style="background: #ef4444; padding: 20px; border-radius: 12px; color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                        <div style="font-size: 14px; opacity: 0.9; margin-bottom: 5px;">‚ö†Ô∏è LOW DEMAND</div>
                        <div style="font-size: 32px; font-weight: 700; margin: 10px 0;">${lowDemandSizes.length}</div>
                        <div style="font-size: 14px; opacity: 0.9;">size(s) with <10% demand</div>
                        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.3);">
                            <div style="font-weight: 600; margin-bottom: 8px;">Reduce Inventory:</div>
                            ${lowDemandSizes.map(s => `<div>üìâ Size ${s.size} - ${s.percentage}%</div>`).join('')}
                        </div>
                    </div>
                `;
            }
            
            document.getElementById('recommendationCards').innerHTML = cardsHTML;
            
            // Generate Detailed Insights
            let insightHTML = '<ul style="margin: 0; padding-left: 20px; list-style: none;">';
            
            if (topSizes.length >= 2) {
                insightHTML += `<li style="margin-bottom: 10px;">‚úÖ <strong>Primary Focus:</strong> Sizes ${topSizes.map(s => s.size).join(' and ')} represent your core market (${topSizesPercentage.toFixed(1)}% of demand)</li>`;
            }
            
            if (highDemandSizes.length > 0) {
                const avgMeasurements = highDemandSizes.map(s => 
                    `Size ${s.size}: Bust ${s.avgBust}", Waist ${s.avgWaist}", Hip ${s.avgHip}"`
                ).join(' | ');
                insightHTML += `<li style="margin-bottom: 10px;">üìè <strong>Customer Profile:</strong> ${avgMeasurements}</li>`;
            }
            
            if (lowDemandSizes.length > 0) {
                const potentialSavings = lowDemandSizes.length * 50; // Estimated units per size
                insightHTML += `<li style="margin-bottom: 10px;">üí∞ <strong>Cost Optimization:</strong> Reducing inventory on ${lowDemandSizes.length} low-demand sizes could save ~${potentialSavings} units in stock</li>`;
            }
            
            insightHTML += `<li style="margin-bottom: 10px;">üìà <strong>Market Coverage:</strong> Your current size range covers ${((totalOrders / (totalOrders + sizeData.filter(s => s.size === 'N/A').reduce((sum, s) => sum + s.count, 0))) * 100).toFixed(1)}% of customer measurements</li>`;
            
            insightHTML += '</ul>';
            document.getElementById('insightDetails').innerHTML = insightHTML;
            
            // Generate Action Items
            let actionsHTML = '';
            
            if (topSizes.length > 0) {
                actionsHTML += `<li><strong>Increase production</strong> for sizes ${topSizes.map(s => s.size).join(' and ')} by ${Math.round(topSizesPercentage / 10)}0%</li>`;
            }
            
            if (lowDemandSizes.length > 0) {
                actionsHTML += `<li><strong>Reduce inventory</strong> for sizes ${lowDemandSizes.map(s => s.size).join(', ')} by 50%</li>`;
            }
            
            if (totalOrders < 50) {
                actionsHTML += `<li><strong>Collect more data</strong> - You have ${totalOrders}/50 measurements. More data = better insights!</li>`;
            }
            
            const naCount = sizeData.find(s => s.size === 'N/A')?.count || 0;
            if (naCount > 0) {
                actionsHTML += `<li><strong>Consider adding larger sizes</strong> - ${naCount} customer(s) exceeded your size range</li>`;
            }
            
            actionsHTML += `<li><strong>Review monthly</strong> - Update inventory strategy based on latest trends</li>`;
            
            document.getElementById('actionList').innerHTML = actionsHTML;
            
            // Set Data Confidence Level
            let confidenceHTML = '';
            let confidenceColor = '';
            
            if (totalOrders >= 100) {
                confidenceHTML = '<span style="color: #065f46; font-weight: 600;">HIGH</span> - Highly reliable insights based on ' + totalOrders + ' measurements';
                confidenceColor = '#10b981';
            } else if (totalOrders >= 50) {
                confidenceHTML = '<span style="color: #047857; font-weight: 600;">GOOD</span> - Reliable insights based on ' + totalOrders + ' measurements';
                confidenceColor = '#34d399';
            } else if (totalOrders >= 20) {
                confidenceHTML = '<span style="color: #d97706; font-weight: 600;">MODERATE</span> - Collect more data for better accuracy (' + totalOrders + '/50 measurements)';
                confidenceColor = '#f59e0b';
            } else {
                confidenceHTML = '<span style="color: #dc2626; font-weight: 600;">LOW</span> - Early stage data (' + totalOrders + ' measurements) - insights will improve';
                confidenceColor = '#ef4444';
            }
            
            document.getElementById('confidenceLevel').innerHTML = confidenceHTML;
            document.getElementById('dataConfidence').style.borderLeftColor = confidenceColor;
        }
        
        // Update size comparison table with real data
        function updateSizeComparisonTable() {
            const tbody = document.getElementById('sizeComparisonTable');
            tbody.innerHTML = '';
            
            if (!analyticsData || !analyticsData.sizeAnalytics || analyticsData.sizeAnalytics.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 2rem; color: #718096;">
                            No size data available yet
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Sort by count descending
            const sortedSizes = analyticsData.sizeAnalytics.sort((a, b) => b.count - a.count);
            
            sortedSizes.forEach(sizeData => {
                const priority = parseFloat(sizeData.percentage) >= 20 ? 'High' : 
                               parseFloat(sizeData.percentage) >= 10 ? 'Medium' : 'Low';
                const badgeClass = priority === 'High' ? 'badge-success' : 
                                 priority === 'Medium' ? 'badge-warning' : 'badge-info';
                
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td><strong>${sizeData.size}</strong></td>
                    <td>${sizeData.count}</td>
                    <td>${sizeData.percentage}%</td>
                    <td>${sizeData.avgBust}"</td>
                    <td>${sizeData.avgWaist}"</td>
                    <td>${sizeData.avgHip}"</td>
                    <td><span class="badge ${badgeClass}">${priority}</span></td>
                `;
            });
        }

        // Create size distribution chart
        function createSizeDistributionChart() {
            const ctx = document.getElementById('sizeDistributionChart').getContext('2d');
            
            // Prepare data from analytics
            let labels = ['XS', 'S', 'M', 'L', 'XL', 'XXL'];
            let data = [0, 0, 0, 0, 0, 0];
            
            if (analyticsData && analyticsData.sizeDistribution) {
                // Use real data
                labels = Object.keys(analyticsData.sizeDistribution);
                data = Object.values(analyticsData.sizeDistribution);
            }
            
            // Destroy existing chart if it exists
            if (window.sizeChart) {
                window.sizeChart.destroy();
            }
            
            window.sizeChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Recommendations',
                        data: data,
                        backgroundColor: [
                            '#fbbf24',
                            '#60a5fa',
                            '#34d399',
                            '#a78bfa',
                            '#f87171',
                            '#fb923c'
                        ],
                        borderWidth: 3,
                        borderColor: 'white'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        title: {
                            display: true,
                            text: 'Size Recommendations Distribution',
                            font: {
                                size: 16,
                                weight: 'bold'
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const size = context.label;
                                    const value = context.parsed;
                                    return size + ' (' + value + ') recommendations';
                                }
                            }
                        }
                    }
                },
                plugins: [{
                    afterDraw: (chart) => {
                        const ctx = chart.ctx;
                        const chartArea = chart.chartArea;
                        const centerX = (chartArea.left + chartArea.right) / 2;
                        const centerY = (chartArea.top + chartArea.bottom) / 2;
                        
                        chart.data.datasets.forEach((dataset, i) => {
                            const meta = chart.getDatasetMeta(i);
                            meta.data.forEach((arc, index) => {
                                const size = chart.data.labels[index];
                                const value = dataset.data[index];
                                
                                // Calculate position in the middle of the slice
                                const midAngle = (arc.startAngle + arc.endAngle) / 2;
                                const radius = (arc.innerRadius + arc.outerRadius) / 2;
                                const x = centerX + Math.cos(midAngle) * radius;
                                const y = centerY + Math.sin(midAngle) * radius;
                                
                                // Draw size label
                                ctx.fillStyle = 'white';
                                ctx.font = 'bold 18px sans-serif';
                                ctx.textAlign = 'center';
                                ctx.textBaseline = 'middle';
                                ctx.fillText(size, x, y - 8);
                                
                                // Draw count below
                                ctx.font = 'bold 14px sans-serif';
                                ctx.fillText('(' + value + ')', x, y + 10);
                            });
                        });
                    }
                }]
            });
        }

        // Load customers
        function loadCustomers() {
            const tbody = document.getElementById('customerTable');
            tbody.innerHTML = '';
            
            if (customerData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 3rem; color: #718096;">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">üì≠</div>
                            <div style="font-size: 1.2rem; font-weight: 600; margin-bottom: 0.5rem;">No measurement data found</div>
                            <div>Customer measurements will appear here once they submit their measurements on product pages</div>
                            <div style="margin-top: 1rem;">
                                <a href="#" onclick="showTab('sizechart'); return false;" style="color: #667eea;">Set up your size chart</a> to start collecting measurements
                            </div>
                        </td>
                    </tr>
                `;
                document.getElementById('customerCount').textContent = 'No customers yet';
                return;
            }
            
            customerData.forEach(customer => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${customer.date}</td>
                    <td>${customer.name}</td>
                    <td>${customer.email || 'N/A'}</td>
                    <td>${customer.bust}"</td>
                    <td>${customer.waist}"</td>
                    <td>${customer.hip}"</td>
                    <td><span class="badge badge-info">${customer.size}</span></td>
                    <td>${customer.orderId}</td>
                `;
            });
            
            document.getElementById('customerCount').textContent = `Showing ${customerData.length} of ${originalCustomerData.length} customers`;
        }

        // Filter customers
        function filterCustomers() {
            const dateFrom = document.getElementById('dateFrom').value;
            const dateTo = document.getElementById('dateTo').value;
            const month = document.getElementById('monthFilter').value;
            const year = document.getElementById('yearFilter').value;
            const size = document.getElementById('sizeFilter').value;
            
            let filtered = originalCustomerData;
            
            if (dateFrom) {
                filtered = filtered.filter(c => c.date >= dateFrom);
            }
            if (dateTo) {
                filtered = filtered.filter(c => c.date <= dateTo);
            }
            if (month !== '') {
                filtered = filtered.filter(c => new Date(c.date).getMonth() === parseInt(month));
            }
            if (year) {
                filtered = filtered.filter(c => new Date(c.date).getFullYear() === parseInt(year));
            }
            if (size) {
                filtered = filtered.filter(c => c.size === size);
            }
            
            // Update customerData with filtered results
            customerData = filtered;
            
            // Update table
            loadCustomers();
        }

        // Clear filters
        function clearFilters() {
            document.getElementById('dateFrom').value = '';
            document.getElementById('dateTo').value = '';
            document.getElementById('monthFilter').value = '';
            document.getElementById('yearFilter').value = '';
            document.getElementById('sizeFilter').value = '';
            customerData = [...originalCustomerData];
            loadCustomers();
        }

        // Export customer data
        function exportCustomerData() {
            const csv = [
                ['Date', 'Customer Name', 'Email', 'Bust', 'Waist', 'Hip', 'Recommended Size', 'Order ID'],
                ...customerData.map(c => [c.date, c.name, c.email, c.bust + '"', c.waist + '"', c.hip + '"', c.size, c.orderId])
            ].map(row => row.join(',')).join('\n');
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `idealfit-customers-${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            alert('‚úÖ Customer data exported to Excel!');
        }

        // Export analytics to Excel
        function exportAnalytics() {
            const month = document.getElementById('analyticsMonth').value;
            const year = document.getElementById('analyticsYear').value;
            
            // CSV data
            const csvData = [
                ['Size', 'Recommendations', 'Percentage', 'Avg Bust', 'Avg Waist', 'Avg Hip', 'Priority'],
                ['XS', '12', '7.7%', '29"', '24"', '34"', 'Low'],
                ['S', '28', '17.9%', '31"', '26"', '36"', 'Medium'],
                ['M', '45', '28.8%', '33"', '28"', '38"', 'High'],
                ['L', '38', '24.4%', '35"', '30"', '40"', 'High'],
                ['XL', '22', '14.1%', '37"', '32"', '42"', 'Medium'],
                ['XXL', '11', '7.1%', '39"', '34"', '44"', 'Low'],
                [''],
                ['Total Recommendations', '156'],
                ['Most Popular Size', 'M'],
                ['Production Focus', 'M and L (53.2% of orders)']
            ];
            
            const csv = csvData.map(row => row.join(',')).join('\n');
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const filterSuffix = month || year ? `-${year || 'all'}-${month || 'all'}` : '';
            a.download = `idealfit-analytics${filterSuffix}-${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        // Load size chart
        function loadSizeChart() {
            const editor = document.getElementById('sizeChartEditor');
            
            // Clear existing rows (except header)
            const rows = editor.querySelectorAll('.size-row:not(:first-child)');
            rows.forEach(row => row.remove());
            
            // Add rows for each size
            sizeChart.forEach((size, index) => {
                const row = document.createElement('div');
                row.className = 'size-row';
                row.innerHTML = `
                    <input type="text" value="${size.size}" data-index="${index}" data-field="size" onchange="updateSizeChart(${index}, 'size', this.value)">
                    <input type="number" value="${size.bust}" data-index="${index}" data-field="bust" onchange="updateSizeChart(${index}, 'bust', this.value)">
                    <input type="number" value="${size.waist}" data-index="${index}" data-field="waist" onchange="updateSizeChart(${index}, 'waist', this.value)">
                    <input type="number" value="${size.hip}" data-index="${index}" data-field="hip" onchange="updateSizeChart(${index}, 'hip', this.value)">
                    <button class="btn-delete" onclick="deleteSizeRow(${index})" title="Delete this size">üóëÔ∏è</button>
                `;
                editor.appendChild(row);
            });
            
            // Update JSON display
            updateSizeChartJSON();
        }

        // Update size chart
        function updateSizeChart(index, field, value) {
            if (field === 'size') {
                sizeChart[index][field] = value;
            } else {
                sizeChart[index][field] = parseFloat(value) || 0;
            }
            updateSizeChartJSON();
        }

        // Add size row
        function addSizeRow() {
            const editor = document.getElementById('sizeChartEditor');
            const row = document.createElement('div');
            row.className = 'size-row';
            row.innerHTML = `
                <input type="text" value="NEW" placeholder="XS" style="padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 6px;">
                <input type="number" step="0.01" value="0" placeholder="32" style="padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 6px;">
                <input type="number" step="0.01" value="0" placeholder="24" style="padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 6px;">
                <input type="number" step="0.01" value="0" placeholder="34" style="padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 6px;">
                <button class="btn btn-danger" onclick="removeSizeRow(this)" style="padding: 0.5rem 1rem;">üóëÔ∏è</button>
            `;
            editor.appendChild(row);
        }

        // Save size chart to API
        async function saveSizeChartToAPI() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/shopify/merchants/sizechart`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        merchantId: 'idealfit',
                        sizeChart: sizeChartData,
                        unit: merchantUnit
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                console.log('‚úÖ Size chart saved to API:', result);
                
            } catch (error) {
                console.error('‚ùå Failed to save size chart to API:', error);
                throw error;
            }
        }

        // Remove size row
        function removeSizeRow(button) {
            if (confirm('Delete this size?')) {
                button.parentElement.remove();
            }
        }

        // Save size chart (updated to use unit-aware system)
        async function saveSizeChart() {
            try {
                // Save using the new unit-aware function
                saveSizeChartWithUnits();
                
                // Save to API
                await saveSizeChartToAPI();
                
                // Generate the code snippet to update theme extension
                const codeSnippet = `window.IDEALFIT_SIZE_CHART = ${JSON.stringify(sizeChartData, null, 2)};`;
                
                // Show success notification
                showNotification(
                    'Size Chart Saved',
                    `Size chart saved successfully with ${sizeChartData.length} sizes in ${merchantUnit}. All customer measurements will be automatically converted for matching.`,
                    'success',
                    5000
                );
                
                // Show instructions with code snippet
                const instructions = `‚úÖ Size chart saved to dashboard!

üìã Unit: ${merchantUnit === 'inches' ? 'Inches' : 'Centimeters'}
üìä Sizes: ${sizeChartData.length}

üí° Customer measurements will be automatically converted and matched regardless of their unit preference!

üìã TO UPDATE YOUR SHOPIFY STORE:

Copy this code and paste it in your theme extension:

File: extensions/ideal-fit/snippets/dynamic-size-chart.liquid

${codeSnippet}

‚úÖ Code ready to copy!`;

                // Copy to clipboard
                navigator.clipboard.writeText(codeSnippet).then(() => {
                    console.log('Size chart code copied to clipboard');
                }).catch(() => {
                    console.log('Could not copy to clipboard');
                });
                
            } catch (error) {
                console.error('Error saving size chart:', error);
                showNotification(
                    'Save Failed',
                    '‚ùå Failed to save size chart. Error: ' + error.message,
                    'error',
                    5000
                );
            }
        }

        // Load billing
        function loadBilling() {
            // Get current month orders from analytics data
            const orders = analyticsData ? analyticsData.totalOrders : 0;
            
            let plan, rate;
            if (orders <= 500) {
                plan = 'Starter';
                rate = 0.12;
            } else if (orders <= 1500) {
                plan = 'Professional';
                rate = 0.09;
            } else {
                plan = 'Enterprise';
                rate = 0.06;
            }
            
            const total = orders * rate;
            
            // Update summary
            document.getElementById('billingOrders').textContent = orders;
            document.getElementById('billingTier').textContent = plan;
            document.getElementById('billingRate').textContent = '$' + rate.toFixed(2);
            document.getElementById('billingTotal').textContent = '$' + total.toFixed(2);
        }

        // Auto-login check
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize mobile optimizations
            initializeTouchGestures();
            optimizeViewport();
            
            // Initialize unit detection and conversion system
            detectAndSetPrimaryUnit();
            
            const savedEmail = localStorage.getItem('idealfit_user_email');
            if (savedEmail) {
                // Auto-login
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('mainDashboard').classList.add('active');
                document.getElementById('userName').textContent = savedEmail.split('@')[0];
                loadAllData();
                
                // Load size chart with unit conversion
                loadSizeChart();
                
                // Show demo notifications on first visit
                if (!localStorage.getItem('idealfit_notifications_shown')) {
                    setTimeout(() => {
                        showDemoNotifications();
                        localStorage.setItem('idealfit_notifications_shown', 'true');
                    }, 2000);
                }
                
                // Show onboarding for first-time users
                if (!localStorage.getItem('idealfit_onboarding_shown')) {
                    setTimeout(() => {
                        startOnboarding();
                    }, 3000);
                }
            }
            
            console.log('Merchant Dashboard initialized with onboarding and mobile optimizations');
        });
    </script>
</body>
</html>
