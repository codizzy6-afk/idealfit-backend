<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IdealFit - Merchant Dashboard (Fixed)</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8fafc;
            color: #1a202c;
            line-height: 1.6;
        }
        
        .container {
            display: flex;
            min-height: 100vh;
        }
        
        .sidebar {
            width: 280px;
            background: linear-gradient(180deg, #1e3a8a 0%, #1e40af 100%);
            padding: 2rem 0;
            box-shadow: 4px 0 20px rgba(0, 0, 0, 0.1);
            position: relative;
        }
        
        .user-section {
            padding: 1.5rem 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .user-avatar {
            width: 48px;
            height: 48px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: white;
        }
        
        .user-info-sidebar {
            flex: 1;
        }
        
        .user-name {
            color: white;
            font-weight: 600;
            font-size: 1rem;
            margin-bottom: 4px;
        }
        
        .user-email {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.85rem;
        }
        
        .sidebar-nav {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            padding: 0 1rem;
        }
        
        .tab {
            background: none;
            border: none;
            padding: 1rem 1.5rem;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 12px;
            color: rgba(255, 255, 255, 0.8);
            border-left: 3px solid transparent;
            margin: 4px 0;
        }
        
        .tab:hover {
            background: rgba(255, 255, 255, 0.1);
            border-left-color: #60a5fa;
            color: white;
            transform: translateX(4px);
        }
        
        .tab.active {
            background: rgba(255, 255, 255, 0.15);
            color: white;
            font-weight: 600;
            border-left-color: #60a5fa;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .tab-icon {
            font-size: 1.3rem;
            opacity: 0.9;
        }
        
        .tab-label {
            flex: 1;
        }
        
        .main-content {
            flex: 1;
            padding: 2rem;
            background: #f8fafc;
        }
        
        .page-header {
            margin-bottom: 2rem;
        }
        
        .page-title {
            font-size: 2rem;
            font-weight: 700;
            color: #1e3a8a;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .page-subtitle {
            color: #718096;
            font-size: 1.1rem;
        }
        
        .card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            padding: 2rem;
            margin-bottom: 2rem;
            border: 1px solid rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }
        
        .card:hover {
            box-shadow: 0 8px 30px rgba(0,0,0,0.12);
            transform: translateY(-2px);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: white;
            padding: 2rem;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            text-align: center;
            transition: all 0.3s ease;
            border: 1px solid rgba(0, 0, 0, 0.05);
            position: relative;
            overflow: hidden;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 30px rgba(0,0,0,0.15);
        }
        
        .stat-icon {
            font-size: 2.5rem;
            margin-bottom: 1rem;
        }
        
        .stat-number {
            font-size: 2.5rem;
            font-weight: 700;
            color: #1e3a8a;
            margin-bottom: 0.5rem;
        }
        
        .stat-label {
            color: #6b7280;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 500;
        }
        
        .customer-table-wrapper {
            overflow-x: auto;
            max-width: 100%;
        }
        
        .customer-table {
            width: 100%;
            min-width: 1200px;
            border-collapse: collapse;
        }
        
        .customer-table thead th {
            background: #f8fafc;
            padding: 12px;
            text-align: left;
            border-bottom: 2px solid #e2e8f0;
            font-weight: 600;
            color: #374151;
            font-size: 0.875rem;
            white-space: nowrap;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .customer-table tbody td {
            padding: 12px;
            border-bottom: 1px solid #f3f4f6;
            color: #6b7280;
            font-size: 0.875rem;
            white-space: nowrap;
        }
        
        .customer-table tbody tr:hover {
            background: #f8fafc;
        }
        
        .size-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.875rem;
        }
        
        .size-badge.M {
            background: #dbeafe;
            color: #1e40af;
        }
        
        .size-badge.L {
            background: #dcfce7;
            color: #166534;
        }
        
        .size-badge.XL {
            background: #fef3c7;
            color: #92400e;
        }
        
        .size-badge.XXL {
            background: #fecaca;
            color: #991b1b;
        }
        
        .filter-section {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        
        .filter-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .filter-group label {
            font-size: 0.875rem;
            font-weight: 600;
            color: #374151;
        }
        
        .filter-group input,
        .filter-group select {
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 0.875rem;
            transition: all 0.3s ease;
        }
        
        .filter-group input:focus,
        .filter-group select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .filter-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .btn-primary {
            background: #3b82f6;
            color: white;
        }
        
        .btn-primary:hover {
            background: #2563eb;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }
        
        .btn-success {
            background: #10b981;
            color: white;
        }
        
        .btn-success:hover {
            background: #059669;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }
        
        .btn-secondary {
            background: #6b7280;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #4b5563;
        }
        
        /* Analytics specific styles - Bar Chart */
        .bar-chart-container {
            display: flex;
            align-items: flex-end;
            justify-content: space-around;
            height: 350px;
            padding: 20px;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            background: #f9fafb;
            gap: 12px;
        }
        
        .bar-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100%;
        }
        
        .bar-container {
            width: 100%;
            max-width: 80px;
            height: calc(100% - 60px);
            background: #e5e7eb;
            border-radius: 8px 8px 0 0;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
        }
        
        .bar-fill {
            background: linear-gradient(180deg, #3b82f6 0%, #1e40af 100%);
            width: 100%;
            transition: height 0.5s ease;
            border-radius: 8px 8px 0 0;
            position: relative;
            min-height: 20px;
        }
        
        .bar-value {
            position: absolute;
            top: -24px;
            left: 50%;
            transform: translateX(-50%);
            background: #1f2937;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            white-space: nowrap;
        }
        
        .bar-label {
            margin-top: 8px;
            font-weight: 600;
            color: #374151;
            font-size: 0.875rem;
            text-align: center;
        }
        
                 .bar-count {
             margin-top: 4px;
             color: #6b7280;
             font-size: 0.75rem;
             text-align: center;
         }
         
         /* Size Comparison Table */
         .size-comparison-table {
             width: 100%;
             border-collapse: collapse;
             margin-top: 1rem;
         }
         
         .size-comparison-table thead th {
             background: #f8fafc;
             padding: 12px;
             text-align: left;
             border-bottom: 2px solid #e2e8f0;
             font-weight: 600;
             color: #374151;
             font-size: 0.875rem;
             white-space: nowrap;
         }
         
         .size-comparison-table tbody td {
             padding: 12px;
             border-bottom: 1px solid #f3f4f6;
             color: #6b7280;
             font-size: 0.875rem;
         }
         
         .size-comparison-table tbody tr:hover {
             background: #f8fafc;
         }
         
         .priority-badge {
             display: inline-block;
             padding: 4px 12px;
             border-radius: 12px;
             font-weight: 600;
             font-size: 0.75rem;
         }
         
         .priority-badge.HIGH {
             background: #dcfce7;
             color: #166534;
         }
         
         .priority-badge.MEDIUM {
             background: #fef3c7;
             color: #92400e;
         }
         
         .priority-badge.LOW {
             background: #fee2e2;
             color: #991b1b;
         }
         
         .insight-card {
            background: #f8fafc;
            border-left: 4px solid #3b82f6;
            padding: 1rem;
            border-radius: 8px;
            margin: 0.5rem 0;
        }
        
        .insight-card.success {
            border-left-color: #10b981;
        }
        
        .insight-card.warning {
            border-left-color: #f59e0b;
        }
        
        .insight-card.info {
            border-left-color: #3b82f6;
        }
        
        .insight-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #1f2937;
        }
        
        .insight-desc {
            color: #6b7280;
            font-size: 0.875rem;
        }
        
        .animated-number {
            display: inline-block;
            transition: transform 0.3s ease;
        }
        
                 .animated-number.updating {
             transform: scale(1.1);
         }
         
         /* Size Chart Editable Table */
         .editable-input {
             width: 100%;
             padding: 6px 8px;
             border: 1px solid #d1d5db;
             border-radius: 4px;
             font-size: 0.875rem;
             transition: all 0.2s ease;
         }
         
         .editable-input:focus {
             outline: none;
             border-color: #3b82f6;
             box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
         }
         
         .delete-btn {
             background: #ef4444;
             color: white;
             border: none;
             padding: 6px 12px;
             border-radius: 6px;
             cursor: pointer;
             font-size: 0.875rem;
             font-weight: 600;
             transition: all 0.3s ease;
         }
         
         .delete-btn:hover {
             background: #dc2626;
             transform: translateY(-2px);
             box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
         }
    </style>
</head>
<body>
    <div class="container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="user-section">
                <div class="user-avatar">👤</div>
                <div class="user-info-sidebar">
                    <div class="user-name">Merchant Store</div>
                    <div class="user-email">store@example.com</div>
                </div>
            </div>

            <div class="sidebar-nav">
                <button class="tab active" onclick="showTab('analytics')">
                    <span class="tab-icon">📊</span>
                    <span class="tab-label">Analytics</span>
                </button>
                <button class="tab" onclick="showTab('customers')">
                    <span class="tab-icon">👥</span>
                    <span class="tab-label">Customer Database</span>
                </button>
                <button class="tab" onclick="showTab('sizechart')">
                    <span class="tab-icon">📏</span>
                    <span class="tab-label">Size Chart</span>
                </button>
                <button class="tab" onclick="showTab('billing')">
                    <span class="tab-icon">💰</span>
                    <span class="tab-label">Billing</span>
                </button>
                <button class="tab" onclick="showTab('settings')">
                    <span class="tab-icon">⚙️</span>
                    <span class="tab-label">Settings</span>
                </button>
            </div>
            
            <div style="position: absolute; bottom: 1rem; left: 0; right: 0; padding: 0 1rem;">
                <button onclick="logout()" style="width: 100%; padding: 0.75rem; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 8px; color: #ef4444; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">
                    🚪 Logout
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Analytics Tab -->
            <div id="analytics" class="tab-content active">
                <div class="page-header" style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <div class="page-title">
                            📊 Analytics Dashboard
                        </div>
                        <div class="page-subtitle">
                            Real-time insights and performance metrics
                        </div>
                    </div>
                    <button onclick="loadAnalyticsData()" class="btn btn-primary" style="margin-left: auto;">
                        🔄 Refresh Analytics
                    </button>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">📦</div>
                        <div class="stat-number" id="totalOrders">Loading...</div>
                        <div class="stat-label">Total Orders</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">💰</div>
                        <div class="stat-number" id="totalRevenue">Loading...</div>
                        <div class="stat-label">Total Revenue</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">👥</div>
                        <div class="stat-number" id="totalCustomers">Loading...</div>
                        <div class="stat-label">Total Customers</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">📏</div>
                        <div class="stat-number" id="avgOrderValue">Loading...</div>
                        <div class="stat-label">Avg Order Value</div>
                    </div>
                </div>

                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h3>Size Distribution</h3>
                        <span id="sizeDistributionStatus" style="color: #6b7280; font-size: 0.875rem;">Loading...</span>
                    </div>
                    <div id="sizeDistributionChart" style="min-height: 300px;">
                        <p style="color: #6b7280;">Loading size distribution data...</p>
                    </div>
                </div>

                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h3>Size Comparison & Production Insights</h3>
                        <input type="text" id="searchSizes" placeholder="🔍 Search sizes..." style="padding: 0.5rem 1rem; border: 1px solid #d1d5db; border-radius: 8px; font-size: 0.875rem;">
                    </div>
                    <div id="sizeComparisonTable" style="overflow-x: auto;">
                        <p style="color: #6b7280;">Loading size comparison data...</p>
                    </div>
                </div>

                <div class="card">
                    <h3>Size Performance Insights</h3>
                    <div id="sizeInsightsContainer" style="margin-top: 1rem;">
                        <p style="color: #6b7280;">Loading insights...</p>
                    </div>
                </div>
            </div>

            <!-- Customer Database Tab -->
            <div id="customers" class="tab-content">
                <div class="page-header" style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <div class="page-title">
                            👥 Customer Database
                        </div>
                        <div class="page-subtitle">
                            Customer measurements and order history
                        </div>
                    </div>
                    <button onclick="loadCustomerData()" class="btn btn-primary">
                        🔄 Refresh Data
                    </button>
                </div>

                <!-- Filter Section -->
                <div class="filter-section">
                    <h3 style="margin-bottom: 1rem; color: #374151;">🔍 Filter Options</h3>
                    <div class="filter-row">
                        <div class="filter-group">
                            <label for="filterDateFrom">Date From</label>
                            <input type="date" id="filterDateFrom">
                        </div>
                        <div class="filter-group">
                            <label for="filterDateTo">Date To</label>
                            <input type="date" id="filterDateTo">
                        </div>
                        <div class="filter-group">
                            <label for="filterMonth">Month</label>
                            <select id="filterMonth">
                                <option value="">All Months</option>
                                <option value="01">January</option>
                                <option value="02">February</option>
                                <option value="03">March</option>
                                <option value="04">April</option>
                                <option value="05">May</option>
                                <option value="06">June</option>
                                <option value="07">July</option>
                                <option value="08">August</option>
                                <option value="09">September</option>
                                <option value="10">October</option>
                                <option value="11">November</option>
                                <option value="12">December</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="filterYear">Year</label>
                            <select id="filterYear">
                                <option value="">All Years</option>
                            </select>
                        </div>
                    </div>
                    <div class="filter-actions">
                        <button onclick="applyFilters()" class="btn btn-primary">✅ Apply Filters</button>
                        <button onclick="clearFilters()" class="btn btn-secondary">🔄 Clear Filters</button>
                        <button onclick="exportToExcel()" class="btn btn-success">📥 Export to Excel</button>
                    </div>
                </div>

                <div class="card">
                    <h3>Customer Measurements</h3>
                    <p id="customerDataStatus" style="color: #6b7280; margin-bottom: 1rem;">Loading customer data...</p>
                    <div id="customerDataContainer">
                        <!-- Dynamic customer data will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Size Chart Tab -->
            <div id="sizechart" class="tab-content">
                <div class="page-header" style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <div class="page-title">
                            📏 Size Chart Management
                        </div>
                        <div class="page-subtitle">
                            Configure size measurements for your products
                        </div>
                    </div>
                    <div style="display: flex; gap: 0.5rem;">
                        <button onclick="loadSizeChart()" class="btn btn-primary">🔄 Refresh</button>
                        <button onclick="addNewSizeRow()" class="btn btn-success">➕ Add Size</button>
                        <button onclick="saveSizeChart()" class="btn btn-primary">💾 Save Chart</button>
                    </div>
                </div>

                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h3>Editable Size Chart</h3>
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <!-- Unit Toggle -->
                            <div style="display: flex; align-items: center; gap: 0.5rem; background: #f3f4f6; padding: 0.5rem; border-radius: 8px;">
                                <label style="font-size: 0.875rem; font-weight: 600; color: #374151;">Unit:</label>
                                <label style="display: flex; align-items: center; cursor: pointer; font-size: 0.875rem; color: #6b7280;">
                                    <input type="radio" name="unitToggle" value="inches" checked onchange="toggleUnit('inches')" style="margin-right: 0.25rem;">
                                    Inches
                                </label>
                                <label style="display: flex; align-items: center; cursor: pointer; font-size: 0.875rem; color: #6b7280;">
                                    <input type="radio" name="unitToggle" value="cm" onchange="toggleUnit('cm')" style="margin-right: 0.25rem;">
                                    CM
                                </label>
                            </div>
                            <span id="sizeChartStatus" style="color: #6b7280; font-size: 0.875rem;">Ready to edit</span>
                        </div>
                    </div>
                    
                    <div id="sizeChartContainer" style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; margin-top: 1rem;">
                            <thead>
                                <tr style="background: #f8fafc;">
                                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e2e8f0; font-weight: 600; color: #374151;">Size</th>
                                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e2e8f0; font-weight: 600; color: #374151;" id="bustHeader">Bust (inches)</th>
                                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e2e8f0; font-weight: 600; color: #374151;" id="waistHeader">Waist (inches)</th>
                                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e2e8f0; font-weight: 600; color: #374151;" id="hipHeader">Hip (inches)</th>
                                    <th style="padding: 12px; text-align: center; border-bottom: 2px solid #e2e8f0; font-weight: 600; color: #374151;">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="sizeChartBody">
                                <!-- Dynamic rows will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                    
                    <p style="margin-top: 1rem; color: #6b7280; font-size: 0.875rem;">
                        💡 Tip: Toggle between Inches and CM to view measurements in your preferred unit. All values are automatically converted.
                    </p>
                </div>
            </div>

            <!-- Billing Tab -->
            <div id="billing" class="tab-content">
                <div class="page-header" style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <div class="page-title">
                            💰 Billing & Subscription
                        </div>
                        <div class="page-subtitle">
                            Manage your subscription and billing preferences
                        </div>
                    </div>
                    <button onclick="loadBillingData()" class="btn btn-primary">
                        🔄 Refresh Billing
                    </button>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">💳</div>
                        <div class="stat-number" id="currentPlan">Loading...</div>
                        <div class="stat-label">Current Plan</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">📅</div>
                        <div class="stat-number" id="nextBillingDate">Loading...</div>
                        <div class="stat-label">Next Billing</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">💰</div>
                        <div class="stat-number" id="currentRate">Loading...</div>
                        <div class="stat-label">Rate per Order</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">📦</div>
                        <div class="stat-number" id="ordersThisMonth">Loading...</div>
                        <div class="stat-label">Orders This Month</div>
                    </div>
                </div>

                <div class="card">
                    <h3>Billing Breakdown</h3>
                    <p id="billingBreakdown" style="color: #6b7280;">Loading billing information...</p>
                    
                    <!-- Make Payment Section -->
                    <div id="makePaymentSection" style="margin-top: 2rem; padding-top: 2rem; border-top: 2px solid #e5e7eb; display: none;">
                        <h3 style="margin-bottom: 1rem; color: #1f2937;">💳 Payment Options</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                            <button onclick="initiatePayment('razorpay')" class="btn btn-primary" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 1rem 2rem; font-size: 1rem;">
                                <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">💳</div>
                                <div>Pay with Razorpay</div>
                                <div style="font-size: 0.75rem; opacity: 0.8; margin-top: 0.25rem;">Secure & Fast</div>
                            </button>
                            <button onclick="initiatePayment('stripe')" class="btn btn-primary" style="background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); padding: 1rem 2rem; font-size: 1rem;">
                                <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">💳</div>
                                <div>Pay with Stripe</div>
                                <div style="font-size: 0.75rem; opacity: 0.8; margin-top: 0.25rem;">Global Payments</div>
                            </button>
                        </div>
                        <p style="margin-top: 1rem; color: #6b7280; font-size: 0.875rem; text-align: center;">
                            🔒 All payments are secured with 256-bit SSL encryption
                        </p>
                    </div>
                </div>

                <div class="card">
                    <h3>Billing History</h3>
                    <div id="billingHistory">
                        <p style="color: #6b7280;">Loading billing history...</p>
                    </div>
                </div>

                                 <div class="card" style="background: #f0f9ff; border-left: 4px solid #3b82f6;">
                     <h3 style="margin-top: 0;">📋 Billing Tier Information</h3>
                     <div id="billingTierTable">
                         <!-- Dynamic content will be loaded here -->
                     </div>
                     <p style="margin-top: 1rem; color: #6b7280; font-size: 0.875rem;">
                         💡 <strong>Note:</strong> Billing is calculated automatically at the end of each month based on your total order count. The tier is determined by the total number of orders in the current month. Currency is automatically detected based on your location.
                     </p>
                 </div>
            </div>

            <!-- Settings Tab -->
            <div id="settings" class="tab-content">
                <div class="page-header">
                    <div class="page-title">⚙️ Settings</div>
                    <div class="page-subtitle">Manage your account and preferences</div>
                </div>

                <div class="card">
                    <h3>Change Username & Password</h3>
                    <form id="changeCredentialsForm" onsubmit="changeCredentials(event); return false;" style="margin-top: 1.5rem;">
                        <div class="form-group" style="margin-bottom: 1.5rem;">
                            <label for="currentPassword">Current Password</label>
                            <input type="password" id="currentPassword" placeholder="Enter current password" required style="padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 8px; width: 100%;">
                        </div>
                        
                        <div class="form-group" style="margin-bottom: 1.5rem;">
                            <label for="newUsername">New Username</label>
                            <input type="text" id="newUsername" placeholder="Enter new username" required style="padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 8px; width: 100%;">
                        </div>
                        
                        <div class="form-group" style="margin-bottom: 1.5rem;">
                            <label for="newPassword">New Password</label>
                            <input type="password" id="newPassword" placeholder="Enter new password" required style="padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 8px; width: 100%;">
                        </div>
                        
                        <div class="form-group" style="margin-bottom: 1.5rem;">
                            <label for="confirmPassword">Confirm New Password</label>
                            <input type="password" id="confirmPassword" placeholder="Confirm new password" required style="padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 8px; width: 100%;">
                        </div>
                        
                        <button type="submit" class="btn btn-primary">💾 Save Changes</button>
                        <div id="credentialsMessage" style="margin-top: 1rem;"></div>
                    </form>
                </div>

                <div class="card">
                    <h3>Account Information</h3>
                    <div style="margin-top: 1.5rem;">
                        <div style="margin-bottom: 1rem;">
                            <strong>Username:</strong> <span id="displayUsername">admin</span>
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <strong>Store Name:</strong> Merchant Store
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <strong>Email:</strong> store@example.com
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <strong>Account Status:</strong> <span style="color: #10b981; font-weight: 600;">● Active</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let dashboardState;
        // Ensure dashboard state is available globally for inline handlers
        if (typeof window !== 'undefined') {
            window.dashboardState = window.dashboardState || { currentTab: 'analytics' };
            dashboardState = window.dashboardState;
        }
        
        // Tab navigation function (global scope)
        function showTab(tabName) {
            try {
                console.log('showTab called with:', tabName);
                
                // Check for unsaved changes in size chart
                if (hasUnsavedChanges) {
                    const shouldContinue = confirm('⚠️ You have unsaved changes in the size chart. If you leave now, your changes will be lost.\n\nWould you like to stay on this page and save your changes?');
                    if (!shouldContinue) {
                        // User chose to leave - continue with tab switch
                        hasUnsavedChanges = false;
                    } else {
                        // User chose to stay - don't switch tabs
                        return;
                    }
                }
                
                // Hide all tab contents
                const contents = document.querySelectorAll('.tab-content');
                contents.forEach(content => content.style.display = 'none');
                
                // Remove active class from all nav items
                const navItems = document.querySelectorAll('.tab');
                navItems.forEach(item => item.classList.remove('active'));
                
                // Add active class to clicked item
                const clickedTab = document.querySelector(`[onclick="showTab('${tabName}')"]`);
                if (clickedTab) {
                    clickedTab.classList.add('active');
                }
                
                // Show selected content
                const content = document.getElementById(tabName);
                if (content) {
                    content.style.display = 'block';
                    if (dashboardState) {
                        dashboardState.currentTab = tabName;
                    }
                    
                    // Save current tab to localStorage for persistence
                    localStorage.setItem('idealfit_current_tab', tabName);
                    
                    // Load data based on tab
                    if (tabName === 'analytics') {
                        loadAnalyticsData();
                    } else if (tabName === 'customers') {
                        loadCustomerData();
                    } else if (tabName === 'sizechart') {
                        loadSizeChart();
                    } else if (tabName === 'billing') {
                        loadBillingData();
                    }
                }
                
                console.log('Tab switched to:', tabName);
            } catch (error) {
                console.error('Error switching tabs:', error);
            }
        }
        // Expose for inline onclick handlers
        if (typeof window !== 'undefined') {
            window.showTab = showTab;
        }
        
        // Initialize dashboard state if not already set
        if (!dashboardState) {
            dashboardState = { currentTab: 'analytics' };
            if (typeof window !== 'undefined') {
                window.dashboardState = dashboardState;
            }
        }
        
        // Store all customer data for filtering
        let allCustomerData = [];
        
        // Populate year dropdown
        function populateYearDropdown() {
            const yearSelect = document.getElementById('filterYear');
            if (!yearSelect) return;
            
            const currentYear = new Date().getFullYear();
            for (let year = 2020; year <= currentYear + 1; year++) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearSelect.appendChild(option);
            }
        }
        
        // Load analytics data
        async function loadAnalyticsData() {
            try {
                const statusEl = document.getElementById('sizeDistributionStatus');
                if (statusEl) statusEl.textContent = '🔄 Loading...';
                
                                 // Fetch data from API
                 const apiBaseUrl = 'https://ideal-fit-app1.onrender.com/api';
                 
                 const response = await fetch(`${apiBaseUrl}/analytics`);
                const data = await response.json();
                
                if (data.success && data.data) {
                    const analytics = data.data;
                    
                    // Extract KPIs from analytics data
                    const kpis = analytics.kpis || {};
                    
                    console.log('📊 KPIs from API:', kpis);
                    
                    // Update stat cards with correct field names
                    updateStatCard('totalOrders', kpis.totalOrders || 0);
                    updateStatCard('totalRevenue', formatCurrency(kpis.totalRevenue || 0));
                    updateStatCard('totalCustomers', kpis.totalOrders || 0); // Use totalOrders as fallback
                    updateStatCard('avgOrderValue', formatCurrency(kpis.avgOrderValue || 0));
                    
                    // Update size distribution - handle both array and object format
                    const sizeData = analytics.sizeDistribution || [];
                    
                    // Transform size data if it has a different structure (preserve avgBust, avgWaist, avgHip)
                    const transformedSizeData = sizeData.map(item => ({
                        size: item.size || item.label || 'Unknown',
                        count: item.recommendations || item.count || item.quantity || 0,
                        avgBust: item.avgBust,
                        avgWaist: item.avgWaist,
                        avgHip: item.avgHip
                    }));
                    
                    if (transformedSizeData.length > 0) {
                        updateSizeDistribution(transformedSizeData);
                        renderSizeComparisonTable(transformedSizeData);
                        generateSizeInsights(transformedSizeData);
                    } else {
                        // Show no data message
                        document.getElementById('sizeDistributionChart').innerHTML = '<p style="color: #6b7280; text-align: center; padding: 2rem;">No size distribution data available yet. Size recommendations will appear here once customers start using the app.</p>';
                        document.getElementById('sizeComparisonTable').innerHTML = '<p style="color: #6b7280; text-align: center;">No size comparison data available yet.</p>';
                        document.getElementById('sizeInsightsContainer').innerHTML = '<p style="color: #6b7280; text-align: center;">Waiting for size recommendation data...</p>';
                    }
                    
                    if (statusEl) statusEl.textContent = '✅ Last updated: ' + new Date().toLocaleTimeString();
                } else {
                    if (statusEl) statusEl.textContent = '⚠️ No data available';
                    // Reset KPIs to zero to avoid endless "Loading..."
                    updateStatCard('totalOrders', 0);
                    updateStatCard('totalRevenue', formatCurrency(0));
                    updateStatCard('totalCustomers', 0);
                    updateStatCard('avgOrderValue', formatCurrency(0));
                }
                
            } catch (error) {
                console.error('Error loading analytics:', error);
                const statusEl = document.getElementById('sizeDistributionStatus');
                if (statusEl) statusEl.textContent = '❌ Error loading data';
                // Reset KPIs on error
                updateStatCard('totalOrders', 0);
                updateStatCard('totalRevenue', formatCurrency(0));
                updateStatCard('totalCustomers', 0);
                updateStatCard('avgOrderValue', formatCurrency(0));
            }
        }
        
        // Update stat card with animation
        function updateStatCard(id, value) {
            const element = document.getElementById(id);
            if (element) {
                element.classList.add('animated-number', 'updating');
                element.textContent = value;
                setTimeout(() => {
                    element.classList.remove('updating');
                }, 300);
            }
        }
        
        // Format currency
        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD'
            }).format(amount);
        }
        
        // Update size distribution chart - Bar Chart
        function updateSizeDistribution(sizeData) {
            const container = document.getElementById('sizeDistributionChart');
            if (!container) return;
            
            // Sort by count descending
            const sorted = [...sizeData].sort((a, b) => b.count - a.count);
            const maxCount = sorted.length > 0 ? sorted[0].count : 1;
            const totalOrders = getTotalOrders(sizeData);
            
            let html = '<div class="bar-chart-container">';
            sorted.forEach(item => {
                const percentage = maxCount > 0 ? (item.count / maxCount) * 100 : 0;
                const color = getSizeColor(item.size);
                const orderPercent = totalOrders > 0 ? ((item.count / totalOrders) * 100).toFixed(1) : 0;
                
                html += `
                    <div class="bar-wrapper">
                        <div class="bar-container">
                            <div class="bar-fill" style="height: ${percentage}%; background: linear-gradient(180deg, ${color} 0%, ${adjustColor(color, -20)} 100%);">
                                <span class="bar-value">${item.count}</span>
                            </div>
                        </div>
                        <div class="bar-label">Size ${item.size}</div>
                        <div class="bar-count">${orderPercent}%</div>
                    </div>
                `;
            });
            html += '</div>';
            
            container.innerHTML = html;
        }
        
        // Helper function to adjust color brightness
        function adjustColor(color, percent) {
            const num = parseInt(color.replace("#", ""), 16);
            const amt = Math.round(2.55 * percent);
            const R = (num >> 16) + amt;
            const G = (num >> 8 & 0x00FF) + amt;
            const B = (num & 0x0000FF) + amt;
            return "#" + (0x1000000 + (R < 255 ? R < 1 ? 0 : R : 255) * 0x10000 +
                (G < 255 ? G < 1 ? 0 : G : 255) * 0x100 +
                (B < 255 ? B < 1 ? 0 : B : 255)).toString(16).slice(1);
        }
        
        // Get color for size
        function getSizeColor(size) {
            const colors = {
                'XS': '#6366f1',
                'S': '#3b82f6',
                'M': '#10b981',
                'L': '#f59e0b',
                'XL': '#ef4444',
                'XXL': '#ec4899',
                'XXXL': '#8b5cf6',
                'XXXXL': '#64748b'
            };
            return colors[size] || '#6b7280';
        }
        
        // Get total orders from size distribution
        function getTotalOrders(sizeData) {
            return sizeData.reduce((sum, item) => sum + item.count, 0);
        }
        
        // Generate size insights
        function generateSizeInsights(sizeData) {
            const container = document.getElementById('sizeInsightsContainer');
            if (!container || !sizeData || sizeData.length === 0) return;
            
            const sorted = [...sizeData].sort((a, b) => b.count - a.count);
            const total = getTotalOrders(sizeData);
            const topSize = sorted[0];
            const leastSize = sorted[sorted.length - 1];
            
            let html = '';
            
            // Top performing size
            if (topSize) {
                const percentage = ((topSize.count / total) * 100).toFixed(1);
                html += `
                    <div class="insight-card success">
                        <div class="insight-title">🏆 Best Selling Size: ${topSize.size}</div>
                        <div class="insight-desc">Size ${topSize.size} accounts for ${percentage}% of all orders (${topSize.count} orders). Consider stocking more inventory for this popular size.</div>
                    </div>
                `;
            }
            
            // Least performing size
            if (leastSize && leastSize.count > 0) {
                const percentage = ((leastSize.count / total) * 100).toFixed(1);
                html += `
                    <div class="insight-card warning">
                        <div class="insight-title">📉 Low Demand: Size ${leastSize.size}</div>
                        <div class="insight-desc">Size ${leastSize.size} has the lowest sales with only ${percentage}% of orders (${leastSize.count} orders). Consider targeted marketing or inventory adjustments.</div>
                    </div>
                `;
            }
            
            // Size distribution analysis
            if (sizeData.length > 0) {
                const avgOrders = total / sizeData.length;
                const aboveAvg = sizeData.filter(item => item.count > avgOrders);
                
                html += `
                    <div class="insight-card info">
                        <div class="insight-title">📊 Sales Distribution</div>
                        <div class="insight-desc">Out of ${sizeData.length} available sizes, ${aboveAvg.length} sizes are performing above average (${avgOrders.toFixed(1)} orders per size). This indicates ${((aboveAvg.length / sizeData.length) * 100).toFixed(0)}% of your size range is meeting demand.</div>
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }
        
        // Render size comparison table
        function renderSizeComparisonTable(sizeData) {
            const container = document.getElementById('sizeComparisonTable');
            if (!container) return;
            
            if (!sizeData || sizeData.length === 0) {
                container.innerHTML = '<p style="color: #6b7280; text-align: center;">No size comparison data available yet.</p>';
                return;
            }
            
            const sorted = [...sizeData].sort((a, b) => b.count - a.count);
            const total = getTotalOrders(sizeData);
            
            let html = `
                <table class="size-comparison-table">
                    <thead>
                        <tr>
                            <th>SIZE ↕</th>
                            <th>RECOMMENDATIONS ↕</th>
                            <th>PERCENTAGE ↕</th>
                            <th>AVG BUST ↕</th>
                            <th>AVG WAIST ↕</th>
                            <th>AVG HIP ↕</th>
                            <th>PRODUCTION PRIORITY ↕</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            sorted.forEach(item => {
                const percentage = total > 0 ? ((item.count / total) * 100).toFixed(1) : 0;
                // Parse as numbers and handle both string and number values
                const avgBust = item.avgBust ? parseFloat(item.avgBust).toFixed(1) + '"' : 'N/A';
                const avgWaist = item.avgWaist ? parseFloat(item.avgWaist).toFixed(1) + '"' : 'N/A';
                const avgHip = item.avgHip ? parseFloat(item.avgHip).toFixed(1) + '"' : 'N/A';
                
                // Determine production priority based on count
                let priority, priorityClass;
                if (item.count >= 3) {
                    priority = 'HIGH';
                    priorityClass = 'HIGH';
                } else if (item.count >= 2) {
                    priority = 'MEDIUM';
                    priorityClass = 'MEDIUM';
                } else {
                    priority = 'LOW';
                    priorityClass = 'LOW';
                }
                
                html += `
                    <tr data-size="${item.size}">
                        <td><strong style="color: #1e40af;">${item.size}</strong></td>
                        <td>${item.count}</td>
                        <td>${percentage}%</td>
                        <td>${avgBust}</td>
                        <td>${avgWaist}</td>
                        <td>${avgHip}</td>
                        <td><span class="priority-badge ${priorityClass}">${priority}</span></td>
                    </tr>
                `;
            });
            
            html += `
                    </tbody>
                </table>
                <div style="margin-top: 1rem; text-align: center; color: #6b7280; font-size: 0.875rem;">
                    <span>Page 1 of 1</span>
                    <span style="margin: 0 1rem;">←</span>
                    <span>→</span>
                </div>
            `;
            
            container.innerHTML = html;
            
            // Add search functionality
            const searchInput = document.getElementById('searchSizes');
            if (searchInput) {
                searchInput.addEventListener('input', function() {
                    const searchTerm = this.value.toLowerCase();
                    const rows = container.querySelectorAll('tbody tr');
                    rows.forEach(row => {
                        const size = row.dataset.size.toLowerCase();
                        row.style.display = size.includes(searchTerm) ? '' : 'none';
                    });
                });
            }
        }
        
        // Apply filters to customer data
        function applyFilters() {
            try {
                const dateFrom = document.getElementById('filterDateFrom').value;
                const dateTo = document.getElementById('filterDateTo').value;
                const month = document.getElementById('filterMonth').value;
                const year = document.getElementById('filterYear').value;
                
                if (allCustomerData.length === 0) {
                    alert('⚠️ No data to filter. Please refresh the data first.');
                    return;
                }
                
                let filteredData = [...allCustomerData];
                
                // Filter by date range
                if (dateFrom) {
                    filteredData = filteredData.filter(order => {
                        const orderDate = new Date(order.createdAt).toISOString().split('T')[0];
                        return orderDate >= dateFrom;
                    });
                }
                
                if (dateTo) {
                    filteredData = filteredData.filter(order => {
                        const orderDate = new Date(order.createdAt).toISOString().split('T')[0];
                        return orderDate <= dateTo;
                    });
                }
                
                // Filter by month and year
                if (month || year) {
                    filteredData = filteredData.filter(order => {
                        const orderDate = new Date(order.createdAt);
                        const orderMonth = String(orderDate.getMonth() + 1).padStart(2, '0');
                        const orderYear = orderDate.getFullYear();
                        
                        let matchesMonth = !month || orderMonth === month;
                        let matchesYear = !year || orderYear.toString() === year;
                        
                        return matchesMonth && matchesYear;
                    });
                }
                
                // Display filtered data
                displayCustomerData(filteredData);
                
                alert(`✅ Filter applied! Showing ${filteredData.length} of ${allCustomerData.length} orders.`);
                
            } catch (error) {
                console.error('Error applying filters:', error);
                alert('❌ Error applying filters. Please try again.');
            }
        }
        
        // Clear filters
        function clearFilters() {
            document.getElementById('filterDateFrom').value = '';
            document.getElementById('filterDateTo').value = '';
            document.getElementById('filterMonth').value = '';
            document.getElementById('filterYear').value = '';
            
            // Display all data
            displayCustomerData(allCustomerData);
            
            alert('🔄 Filters cleared!');
        }
        
        // Display customer data in table
        function displayCustomerData(orders) {
            const containerEl = document.getElementById('customerDataContainer');
            if (!containerEl) return;
            
            if (orders.length === 0) {
                containerEl.innerHTML = '<p style="color: #6b7280;">No orders match the filter criteria.</p>';
                return;
            }
            
            let tableHTML = `
                <div class="customer-table-wrapper">
                    <table class="customer-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Customer Name</th>
                                <th>Email</th>
                                <th>Mobile</th>
                                <th>Address</th>
                                <th>City</th>
                                <th>State</th>
                                <th>Country</th>
                                <th>Bust</th>
                                <th>Waist</th>
                                <th>Hip</th>
                                <th>Size</th>
                                <th>Order ID</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            orders.forEach(order => {
                const orderDate = new Date(order.createdAt).toISOString().split('T')[0];
                const customer = order.customer || {};
                const customerName = `${customer.firstName || ''} ${customer.lastName || ''}`.trim() || 'Unknown Customer';
                const email = customer.email || 'N/A';
                const phone = customer.phone || 'N/A';
                
                // Get address details
                const address = customer.address || {};
                const address1 = address.address1 || 'N/A';
                const city = address.city || 'N/A';
                const province = address.province || 'N/A';
                const country = address.country || 'N/A';
                
                const measurements = order.measurements || {};
                const bust = measurements.bust ? `${measurements.bust}"` : 'N/A';
                const waist = measurements.waist ? `${measurements.waist}"` : 'N/A';
                const hip = measurements.hip ? `${measurements.hip}"` : 'N/A';
                const recommendedSize = measurements.recommendedSize || 'N/A';
                
                tableHTML += `
                    <tr>
                        <td>${orderDate}</td>
                        <td><strong>${customerName}</strong></td>
                        <td>${email}</td>
                        <td>${phone}</td>
                        <td>${address1}</td>
                        <td>${city}</td>
                        <td>${province}</td>
                        <td>${country}</td>
                        <td>${bust}</td>
                        <td>${waist}</td>
                        <td>${hip}</td>
                        <td><span class="size-badge ${recommendedSize}">${recommendedSize}</span></td>
                        <td>${order.orderNumber || order.orderName}</td>
                    </tr>
                `;
            });
            
            tableHTML += `
                        </tbody>
                    </table>
                </div>
                <p style="margin-top: 1rem; color: #6b7280; font-size: 0.875rem;">
                    Showing ${orders.length} orders with customer measurements
                </p>
            `;
            
            containerEl.innerHTML = tableHTML;
        }
        
        // Export data to Excel
        function exportToExcel() {
            try {
                if (allCustomerData.length === 0) {
                    alert('⚠️ No data to export. Please refresh the data first.');
                    return;
                }
                
                // Get currently displayed data (filtered or all)
                const containerEl = document.getElementById('customerDataContainer');
                const table = containerEl.querySelector('.customer-table');
                if (!table) {
                    alert('⚠️ No data table found.');
                    return;
                }
                
                let csv = 'Date,Customer Name,Email,Mobile,Address,City,State,Country,Bust,Waist,Hip,Size,Order ID\n';
                
                allCustomerData.forEach(order => {
                    const orderDate = new Date(order.createdAt).toISOString().split('T')[0];
                    const customer = order.customer || {};
                    const customerName = `${customer.firstName || ''} ${customer.lastName || ''}`.trim() || 'Unknown Customer';
                    const email = customer.email || 'N/A';
                    const phone = customer.phone || 'N/A';
                    
                    const address = customer.address || {};
                    const address1 = address.address1 || 'N/A';
                    const city = address.city || 'N/A';
                    const province = address.province || 'N/A';
                    const country = address.country || 'N/A';
                    
                    const measurements = order.measurements || {};
                    // Export raw numbers without quotes or units
                    const bust = measurements.bust ? measurements.bust : 'N/A';
                    const waist = measurements.waist ? measurements.waist : 'N/A';
                    const hip = measurements.hip ? measurements.hip : 'N/A';
                    const recommendedSize = measurements.recommendedSize || 'N/A';
                    
                    // Get order number - check multiple fields
                    const orderNumber = order.orderNumber || order.orderName || order.name || `#${order.id}`;
                    
                    const row = [
                        orderDate,
                        customerName,
                        email,
                        phone,
                        address1,
                        city,
                        province,
                        country,
                        bust,
                        waist,
                        hip,
                        recommendedSize,
                        orderNumber
                    ];
                    
                    // Escape double quotes in cell values
                    csv += row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',') + '\n';
                });
                
                // Create download link
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `customer_data_${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                
                alert(`✅ Exported ${allCustomerData.length} records to Excel!`);
                
            } catch (error) {
                console.error('Error exporting to Excel:', error);
                alert('❌ Error exporting to Excel. Please try again.');
            }
        }
        
        // Load customer data from API
        async function loadCustomerData() {
            try {
                const statusEl = document.getElementById('customerDataStatus');
                const containerEl = document.getElementById('customerDataContainer');
                
                if (statusEl) statusEl.textContent = '🔄 Loading customer data from Shopify...';
                
                                // Fetch data from API
                const apiBaseUrl = 'https://ideal-fit-app1.onrender.com/api';
                
                const response = await fetch(`${apiBaseUrl}/public-orders?limit=50`);
                const data = await response.json();
                
                if (data.success && data.data && data.data.length > 0) {
                    const orders = data.data;
                    
                    // Store all data for filtering
                    allCustomerData = orders;
                    
                    // Display data using the new function
                    displayCustomerData(orders);
                    
                    // OLD: Build table HTML with wrapper for horizontal scroll
                    /* let tableHTML = `
                        <div class="customer-table-wrapper">
                            <table class="customer-table">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Customer Name</th>
                                        <th>Email</th>
                                        <th>Mobile</th>
                                        <th>Address</th>
                                        <th>City</th>
                                        <th>State</th>
                                        <th>Country</th>
                                        <th>Bust</th>
                                        <th>Waist</th>
                                        <th>Hip</th>
                                        <th>Size</th>
                                        <th>Order ID</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    
                    orders.forEach(order => {
                        const orderDate = new Date(order.createdAt).toISOString().split('T')[0];
                        const customer = order.customer || {};
                        const customerName = `${customer.firstName || ''} ${customer.lastName || ''}`.trim() || 'Unknown Customer';
                        const email = customer.email || 'N/A';
                        const phone = customer.phone || 'N/A';
                        
                        // Get address details
                        const address = customer.address || {};
                        const address1 = address.address1 || 'N/A';
                        const city = address.city || 'N/A';
                        const province = address.province || 'N/A';
                        const country = address.country || 'N/A';
                        
                        const measurements = order.measurements || {};
                        const bust = measurements.bust ? `${measurements.bust}"` : 'N/A';
                        const waist = measurements.waist ? `${measurements.waist}"` : 'N/A';
                        const hip = measurements.hip ? `${measurements.hip}"` : 'N/A';
                        const recommendedSize = measurements.recommendedSize || 'N/A';
                        
                        tableHTML += `
                            <tr>
                                <td>${orderDate}</td>
                                <td><strong>${customerName}</strong></td>
                                <td>${email}</td>
                                <td>${phone}</td>
                                <td>${address1}</td>
                                <td>${city}</td>
                                <td>${province}</td>
                                <td>${country}</td>
                                <td>${bust}</td>
                                <td>${waist}</td>
                                <td>${hip}</td>
                                <td><span class="size-badge ${recommendedSize}">${recommendedSize}</span></td>
                                <td>${order.orderNumber || order.orderName}</td>
                            </tr>
                        `;
                    });
                    
                    tableHTML += `
                                </tbody>
                            </table>
                        </div>
                        <p style="margin-top: 1rem; color: #6b7280; font-size: 0.875rem;">
                            Showing ${orders.length} orders with customer measurements
                        </p>
                    `; */
                    
                    if (statusEl) {
                        statusEl.textContent = `✅ Loaded ${orders.length} orders from Shopify`;
                        statusEl.style.color = '#10b981';
                    }
                    
                } else {
                    if (statusEl) {
                        statusEl.textContent = '⚠️ No customer data found';
                        statusEl.style.color = '#f59e0b';
                    }
                    if (containerEl) {
                        containerEl.innerHTML = '<p style="color: #6b7280;">No orders found with customer measurements.</p>';
                    }
                }
                
            } catch (error) {
                console.error('Error loading customer data:', error);
                const statusEl = document.getElementById('customerDataStatus');
                if (statusEl) {
                    statusEl.textContent = '❌ Error loading customer data';
                    statusEl.style.color = '#ef4444';
                }
            }
        }
        
        // Size Chart Management Functions
        let sizeChartData = [];
        let sizeChartOriginalData = []; // Store original data to detect changes
        let hasUnsavedChanges = false; // Track if there are unsaved changes
        let currentUnit = 'inches'; // Current unit for display (inches or cm)
        const BASE_UNIT = 'inches'; // Always store in inches in the database
        
        // Unit conversion functions
        function inchesToCm(inches) {
            return parseFloat((inches * 2.54).toFixed(2));
        }
        
        function cmToInches(cm) {
            return parseFloat((cm / 2.54).toFixed(2));
        }
        
        // Toggle between inches and cm
        function toggleUnit(unit) {
            currentUnit = unit;
            
            // Update headers
            const bustHeader = document.getElementById('bustHeader');
            const waistHeader = document.getElementById('waistHeader');
            const hipHeader = document.getElementById('hipHeader');
            
            if (unit === 'inches') {
                if (bustHeader) bustHeader.textContent = 'Bust (inches)';
                if (waistHeader) waistHeader.textContent = 'Waist (inches)';
                if (hipHeader) hipHeader.textContent = 'Hip (inches)';
            } else {
                if (bustHeader) bustHeader.textContent = 'Bust (cm)';
                if (waistHeader) waistHeader.textContent = 'Waist (cm)';
                if (hipHeader) hipHeader.textContent = 'Hip (cm)';
            }
            
            // Re-render the size chart with converted values
            renderSizeChart();
        }
        
        // Get display value based on current unit
        function getDisplayValue(inchesValue) {
            if (currentUnit === 'inches') {
                return inchesValue;
            } else {
                return inchesToCm(inchesValue);
            }
        }
        
        // Parse input value based on current unit
        function parseInputValue(inputValue) {
            const numValue = parseFloat(inputValue);
            if (isNaN(numValue)) return 0;
            
            if (currentUnit === 'inches') {
                return numValue;
            } else {
                // Convert cm back to inches for storage
                return cmToInches(numValue);
            }
        }
        
        // Ensure at least N rows in size chart with sensible size labels
        function ensureMinimumRows(minRows) {
            if (!Array.isArray(sizeChartData)) sizeChartData = [];
            const preferredLabels = ['XS','S','M','L','XL','XXL','3XL','4XL','5XL','6XL'];
            const existingLabels = new Set(sizeChartData.map(r => (r.size || '').toUpperCase()));
            let labelIndex = 0;
            while (sizeChartData.length < minRows) {
                let label = preferredLabels[labelIndex] || `SIZE ${labelIndex + 1}`;
                // avoid duplicates
                while (existingLabels.has(label)) {
                    labelIndex++;
                    label = preferredLabels[labelIndex] || `SIZE ${labelIndex + 1}`;
                }
                sizeChartData.push({ size: label, bust: 0, waist: 0, hip: 0 });
                existingLabels.add(label);
                labelIndex++;
            }
        }

        // Load size chart from API
        async function loadSizeChart() {
            try {
                const statusEl = document.getElementById('sizeChartStatus');
                if (statusEl) statusEl.textContent = '🔄 Loading...';
                
                const apiBaseUrl = window.location.hostname === 'localhost' 
                    ? 'http://localhost:3001/api' 
                    : 'https://ideal-fit-app1.onrender.com/api';
                
                const response = await fetch(`${apiBaseUrl}/sizecharts?shop=idealfit-2.myshopify.com`);
                const data = await response.json();
                
                if (data.success && data.data && data.data.length > 0) {
                    const chart = data.data[0].sizeChart;
                    sizeChartData = JSON.parse(JSON.stringify(chart)); // Deep copy
                    sizeChartOriginalData = JSON.parse(JSON.stringify(chart)); // Store original
                    ensureMinimumRows(10);
                    renderSizeChart();
                    hasUnsavedChanges = false; // Reset unsaved changes flag
                    
                    if (statusEl) statusEl.textContent = '✅ Size chart loaded';
                } else {
                    // Default size chart if none exists (seed 6 + auto-expand to 10)
                    sizeChartData = [
                        { size: 'XS', bust: 30, waist: 25, hip: 35 },
                        { size: 'S', bust: 32, waist: 27, hip: 37 },
                        { size: 'M', bust: 34, waist: 29, hip: 39 },
                        { size: 'L', bust: 36, waist: 31, hip: 41 },
                        { size: 'XL', bust: 38, waist: 33, hip: 43 },
                        { size: 'XXL', bust: 40, waist: 35, hip: 45 }
                    ];
                    sizeChartOriginalData = JSON.parse(JSON.stringify(sizeChartData)); // Store original
                    ensureMinimumRows(10);
                    renderSizeChart();
                    hasUnsavedChanges = false; // Reset unsaved changes flag
                    
                    if (statusEl) statusEl.textContent = '📝 Default size chart loaded';
                }
            } catch (error) {
                console.error('Error loading size chart:', error);
                const statusEl = document.getElementById('sizeChartStatus');
                if (statusEl) statusEl.textContent = '❌ Error loading size chart';
            }
        }
        
        // Render size chart table
        function renderSizeChart() {
            const tbody = document.getElementById('sizeChartBody');
            if (!tbody) return;
            
            let html = '';
            
            sizeChartData.forEach((row, index) => {
                // Get display values based on current unit
                const bustDisplay = getDisplayValue(row.bust);
                const waistDisplay = getDisplayValue(row.waist);
                const hipDisplay = getDisplayValue(row.hip);
                
                // Determine step based on unit (more precision for cm)
                const step = currentUnit === 'inches' ? '0.5' : '1';
                
                html += `
                    <tr>
                        <td style="padding: 8px;">
                            <input type="text" class="editable-input" data-index="${index}" data-field="size" value="${row.size}" placeholder="Size" onchange="markAsChanged()" onblur="markAsChanged()">
                        </td>
                        <td style="padding: 8px;">
                            <input type="number" class="editable-input" data-index="${index}" data-field="bust" value="${bustDisplay}" placeholder="Bust" step="${step}" min="0" onchange="markAsChanged()" onblur="markAsChanged()">
                        </td>
                        <td style="padding: 8px;">
                            <input type="number" class="editable-input" data-index="${index}" data-field="waist" value="${waistDisplay}" placeholder="Waist" step="${step}" min="0" onchange="markAsChanged()" onblur="markAsChanged()">
                        </td>
                        <td style="padding: 8px;">
                            <input type="number" class="editable-input" data-index="${index}" data-field="hip" value="${hipDisplay}" placeholder="Hip" step="${step}" min="0" onchange="markAsChanged()" onblur="markAsChanged()">
                        </td>
                        <td style="padding: 8px; text-align: center;">
                            <button class="delete-btn" onclick="deleteSizeRow(${index})">🗑️ Delete</button>
                        </td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
        }
        
        // Mark as changed when user edits
        function markAsChanged() {
            hasUnsavedChanges = true;
            const statusEl = document.getElementById('sizeChartStatus');
            if (statusEl) statusEl.textContent = '⚠️ You have unsaved changes';
        }
        
        // Add new size row
        function addNewSizeRow() {
            sizeChartData.push({
                size: 'NEW',
                bust: 0,
                waist: 0,
                hip: 0
            });
            renderSizeChart();
            hasUnsavedChanges = true;
            
            const statusEl = document.getElementById('sizeChartStatus');
            if (statusEl) statusEl.textContent = '➕ New row added - you have unsaved changes';
        }
        
        // Delete size row
        function deleteSizeRow(index) {
            if (sizeChartData.length <= 1) {
                alert('⚠️ You need at least one size in your chart!');
                return;
            }
            
            if (confirm('Are you sure you want to delete this size?')) {
                sizeChartData.splice(index, 1);
                ensureMinimumRows(10);
                renderSizeChart();
                hasUnsavedChanges = true;
                
                const statusEl = document.getElementById('sizeChartStatus');
                if (statusEl) statusEl.textContent = '🗑️ Size deleted - you have unsaved changes';
            }
        }
        
        // Save size chart to API
        async function saveSizeChart() {
            try {
                const statusEl = document.getElementById('sizeChartStatus');
                if (statusEl) statusEl.textContent = '💾 Saving...';
                
                // Collect all input values and convert based on current unit
                const inputs = document.querySelectorAll('#sizeChartBody .editable-input');
                inputs.forEach(input => {
                    const index = parseInt(input.dataset.index);
                    const field = input.dataset.field;
                    
                    if (field === 'size') {
                        sizeChartData[index][field] = input.value.trim();
                    } else {
                        // Parse measurement values based on current unit
                        const inputValue = parseFloat(input.value);
                        sizeChartData[index][field] = parseInputValue(inputValue);
                    }
                });
                
                // Clean: keep only filled rows, ignore blank placeholders
                const cleaned = sizeChartData.filter(r => {
                    const hasSize = r.size && r.size.trim() !== '';
                    const hasAnyMeasure = Number(r.bust) > 0 || Number(r.waist) > 0 || Number(r.hip) > 0;
                    return hasSize && hasAnyMeasure;
                });
                if (cleaned.length === 0) {
                    alert('⚠️ Please enter at least one valid size with measurements.');
                    if (statusEl) statusEl.textContent = '❌ Validation failed';
                    return;
                }
                
                const apiBaseUrl = window.location.hostname === 'localhost' 
                    ? 'http://localhost:3001/api' 
                    : 'https://ideal-fit-app1.onrender.com/api';
                
                const response = await fetch(`${apiBaseUrl}/sizecharts`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        shop: 'idealfit-2.myshopify.com',
                        sizeChart: cleaned
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Persist cleaned data and pad back to 10 for UI
                    sizeChartData = JSON.parse(JSON.stringify(cleaned));
                    sizeChartOriginalData = JSON.parse(JSON.stringify(cleaned));
                    ensureMinimumRows(10);
                    renderSizeChart();
                    hasUnsavedChanges = false;
                    
                    if (statusEl) statusEl.textContent = '✅ Size chart saved successfully!';
                    alert('✅ Size chart saved successfully!');
                } else {
                    throw new Error('Save failed');
                }
            } catch (error) {
                console.error('Error saving size chart:', error);
                const statusEl = document.getElementById('sizeChartStatus');
                if (statusEl) statusEl.textContent = '❌ Error saving size chart';
                alert('❌ Error saving size chart. Please try again.');
            }
        }
        
        // Restore saved tab on page load
        function restoreSavedTab() {
            try {
                const savedTab = localStorage.getItem('idealfit_current_tab');
                if (savedTab) {
                    showTab(savedTab);
                } else {
                    // Default to analytics tab and load data
                    loadAnalyticsData();
                }
            } catch (error) {
                console.error('Error restoring saved tab:', error);
            }
        }
        
                 // Billing Management Functions
         // Currency detection
         function detectCurrency() {
             try {
                 // Get user's timezone
                 const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
                 
                 // India-specific timezones
                 if (timezone === 'Asia/Kolkata' || timezone === 'Asia/Calcutta') {
                     return 'INR';
                 }
                 
                 // Get user's language/locale
                 const locale = navigator.language || navigator.userLanguage;
                 
                 // Check if India in locale string
                 if (locale.includes('IN') || locale.includes('hi-IN') || locale.includes('en-IN')) {
                     return 'INR';
                 }
                 
                 // Default to USD
                 return 'USD';
             } catch (error) {
                 console.error('Error detecting currency:', error);
                 return 'USD';
             }
         }
         
         // Get currency rates (static for now, could be dynamic)
         function getCurrencyRates(baseCurrency) {
             // Exchange rates (can be updated dynamically from an API)
             const rates = {
                 'INR': {
                     starter: 10,    // ₹10 per order (approx $0.12)
                     professional: 7.5, // ₹7.5 per order (approx $0.09)
                     enterprise: 5,   // ₹5 per order (approx $0.06)
                     symbol: '₹'
                 },
                 'USD': {
                     starter: 0.12,
                     professional: 0.09,
                     enterprise: 0.06,
                     symbol: '$'
                 }
             };
             
             return rates[baseCurrency] || rates['USD'];
         }
         
         async function loadBillingData() {
             try {
                 // Detect user's currency
                 const currency = detectCurrency();
                 const currencyInfo = getCurrencyRates(currency);
                 const currencySymbol = currencyInfo.symbol;
                 
                                   // Fetch orders data to calculate billing
                  const apiBaseUrl = window.location.hostname === 'localhost' 
                      ? 'http://localhost:3001/api' 
                      : 'https://ideal-fit-app1.onrender.com/api';
                  
                                   const response = await fetch(`${apiBaseUrl}/billing`);
                const data = await response.json();
                
                if (data.success && data.data) {
                    const billing = data.data;
                    const monthData = billing.currentMonth;
                    const pricing = billing.pricing;
                    
                    // Get values from API response
                    const orderCount = monthData.orderCount || 0;
                    const totalCost = monthData.totalBill || 0;
                    const plan = pricing.currentTier.name;
                    const rate = pricing.currentTier.pricePerOrder;
                    const currencyFromAPI = monthData.currency;
                    
                    // Use API currency if available, otherwise use detected currency
                    const finalCurrency = currencyFromAPI || currency;
                    const finalCurrencyInfo = getCurrencyRates(finalCurrency);
                    const finalCurrencySymbol = finalCurrencyInfo.symbol;
                     
                                         // Update stat cards
                    updateStatCard('currentPlan', plan);
                    updateStatCard('currentRate', finalCurrencySymbol + rate.toFixed(finalCurrency === 'INR' ? 0 : 2));
                    updateStatCard('ordersThisMonth', orderCount);
                    
                    // Calculate next billing date (end of current month)
                    const now = new Date();
                    const nextBillingDate = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                    updateStatCard('nextBillingDate', nextBillingDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
                    
                                                                                                                                                                     // Update billing breakdown
                    const breakdownEl = document.getElementById('billingBreakdown');
                    if (breakdownEl) {
                        const rateDisplay = rate.toFixed(finalCurrency === 'INR' ? 0 : 2);
                        const totalDisplay = totalCost.toFixed(finalCurrency === 'INR' ? 0 : 2);
                        
                        breakdownEl.innerHTML = `
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-top: 1rem;">
                                <div style="background: #f0f9ff; padding: 1rem; border-radius: 8px; border-left: 4px solid #3b82f6;">
                                    <div style="font-size: 0.875rem; color: #6b7280;">Orders This Month</div>
                                    <div style="font-size: 1.5rem; font-weight: 700; color: #1e40af;">${orderCount}</div>
                                </div>
                                <div style="background: #f0fdf4; padding: 1rem; border-radius: 8px; border-left: 4px solid #10b981;">
                                    <div style="font-size: 0.875rem; color: #6b7280;">Current Rate</div>
                                    <div style="font-size: 1.5rem; font-weight: 700; color: #059669;">${finalCurrencySymbol}${rateDisplay}/order</div>
                                </div>
                                <div style="background: #fef3c7; padding: 1rem; border-radius: 8px; border-left: 4px solid #f59e0b;">
                                    <div style="font-size: 0.875rem; color: #6b7280;">Estimated Monthly Cost</div>
                                    <div style="font-size: 1.5rem; font-weight: 700; color: #d97706;">${finalCurrencySymbol}${totalDisplay}</div>
                                </div>
                            </div>
                            <p style="margin-top: 1rem; color: #6b7280; font-size: 0.875rem;">
                                💡 <strong>Current Tier:</strong> ${plan} Plan - Based on ${orderCount} orders this month<br>
                                💵 <strong>Currency:</strong> ${finalCurrency} (${finalCurrencySymbol === '₹' ? 'Indian Rupee' : 'US Dollar'})
                            </p>
                        `;
                          
                          // Show payment section if there are orders
                          const paymentSection = document.getElementById('makePaymentSection');
                          if (paymentSection && orderCount > 0) {
                              paymentSection.style.display = 'block';
                          }
                      }
                    
                                                              // Skip billing history for now (would need orders data)
                     // Update billing tier table
                     updateBillingTierTable(finalCurrency, finalCurrencyInfo, finalCurrencySymbol);
                     
                } else {
                    // No orders found
                    const currency = detectCurrency();
                    const currencyInfo = getCurrencyRates(currency);
                    const currencySymbol = currencyInfo.symbol;
                    
                    updateStatCard('currentPlan', 'Starter');
                    updateStatCard('currentRate', currencySymbol + currencyInfo.starter.toFixed(currency === 'INR' ? 0 : 2));
                    updateStatCard('ordersThisMonth', 0);
                    updateStatCard('nextBillingDate', 'End of Month');
                    
                    // Update billing tier table
                    updateBillingTierTable(currency, currencyInfo, currencySymbol);
                }
                
                // Initialize billing history with empty state
                const historyEl = document.getElementById('billingHistory');
                if (historyEl) {
                    historyEl.innerHTML = '<p style="color: #6b7280;">No billing history available yet.</p>';
                }
                
            } catch (error) {
                console.error('Error loading billing data:', error);
            }
        }
        
        // Update billing tier table
        function updateBillingTierTable(currency, currencyInfo, currencySymbol) {
            const tierTableEl = document.getElementById('billingTierTable');
            if (!tierTableEl) return;
            
            const starterRate = currencyInfo.starter.toFixed(currency === 'INR' ? 0 : 2);
            const professionalRate = currencyInfo.professional.toFixed(currency === 'INR' ? 0 : 2);
            const enterpriseRate = currencyInfo.enterprise.toFixed(currency === 'INR' ? 0 : 2);
            
            tierTableEl.innerHTML = `
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background: #dbeafe;">
                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #3b82f6;">Tier</th>
                            <th style="padding: 12px; text-align: center; border-bottom: 2px solid #3b82f6;">Order Range</th>
                            <th style="padding: 12px; text-align: center; border-bottom: 2px solid #3b82f6;">Rate per Order</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr style="border-bottom: 1px solid #e5e7eb;">
                            <td style="padding: 12px;"><strong>Starter</strong></td>
                            <td style="padding: 12px; text-align: center;">1 - 500 orders</td>
                            <td style="padding: 12px; text-align: center; color: #059669; font-weight: 600;">${currencySymbol}${starterRate}</td>
                        </tr>
                        <tr style="border-bottom: 1px solid #e5e7eb;">
                            <td style="padding: 12px;"><strong>Professional</strong></td>
                            <td style="padding: 12px; text-align: center;">501 - 1500 orders</td>
                            <td style="padding: 12px; text-align: center; color: #059669; font-weight: 600;">${currencySymbol}${professionalRate}</td>
                        </tr>
                        <tr>
                            <td style="padding: 12px;"><strong>Enterprise</strong></td>
                            <td style="padding: 12px; text-align: center;">1501+ orders</td>
                            <td style="padding: 12px; text-align: center; color: #059669; font-weight: 600;">${currencySymbol}${enterpriseRate}</td>
                        </tr>
                    </tbody>
                </table>
            `;
        }
        
                 // Generate billing history for last 3 months
         function generateBillingHistory(allOrders, currency = 'USD', currencyInfo = null, currencySymbol = '$') {
             const historyEl = document.getElementById('billingHistory');
             if (!historyEl) return;
             
             // Get currency info if not provided
             if (!currencyInfo) {
                 currencyInfo = getCurrencyRates(currency);
             }
             
             const now = new Date();
             let historyHTML = '<div style="margin-top: 1rem;">';
             
             // Generate history for last 3 months
             for (let i = 0; i < 3; i++) {
                 const monthDate = new Date(now.getFullYear(), now.getMonth() - i, 1);
                 const monthName = monthDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                 const month = monthDate.getMonth();
                 const year = monthDate.getFullYear();
                 
                 // Filter orders for this month
                 const monthOrders = allOrders.filter(order => {
                     const orderDate = new Date(order.createdAt);
                     return orderDate.getMonth() === month && orderDate.getFullYear() === year;
                 });
                 
                 // Calculate billing for this month
                 const orderCount = monthOrders.length;
                 let plan, rate, totalCost;
                 
                 if (orderCount <= 500) {
                     plan = 'Starter';
                     rate = currencyInfo.starter;
                 } else if (orderCount <= 1500) {
                     plan = 'Professional';
                     rate = currencyInfo.professional;
                 } else {
                     plan = 'Enterprise';
                     rate = currencyInfo.enterprise;
                 }
                 
                 totalCost = orderCount * rate;
                 const rateDisplay = rate.toFixed(currency === 'INR' ? 0 : 2);
                 const totalDisplay = totalCost.toFixed(currency === 'INR' ? 0 : 2);
                 
                 historyHTML += `
                     <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; border-bottom: 1px solid #e5e7eb;">
                         <div>
                             <div style="font-weight: 600; color: #1f2937;">${monthName}</div>
                             <div style="font-size: 0.875rem; color: #6b7280;">
                                 ${orderCount} orders • ${plan} Plan • ${currencySymbol}${rateDisplay}/order
                             </div>
                         </div>
                         <div style="font-size: 1.25rem; font-weight: 700; color: #059669;">
                             ${currencySymbol}${totalDisplay}
                         </div>
                     </div>
                 `;
             }
             
             historyHTML += '</div>';
             
             if (historyHTML === '<div style="margin-top: 1rem;"></div>') {
                 historyHTML = '<p style="color: #6b7280;">No billing history available yet.</p>';
             }
             
             historyEl.innerHTML = historyHTML;
         }
        
                 // Initiate payment based on gateway
         async function initiatePayment(gateway) {
             try {
                 // Get the current estimated cost from the page
                 const breakdownEl = document.getElementById('billingBreakdown');
                 if (!breakdownEl) {
                     alert('⚠️ Please wait for billing information to load');
                     return;
                 }
                 
                 // Extract amount from the page (for demo purposes)
                 const costMatch = breakdownEl.textContent.match(/\$(\d+\.\d+)/);
                 const amount = costMatch ? parseFloat(costMatch[1]) : 0;
                 
                 if (amount === 0) {
                     alert('⚠️ No payment amount found. Please refresh the billing data.');
                     return;
                 }
                 
                 if (gateway === 'razorpay') {
                     // Razorpay payment
                     const options = {
                         key: 'YOUR_RAZORPAY_KEY_ID', // Replace with your Razorpay Key ID
                         amount: amount * 100, // Amount in paise (multiply by 100)
                         currency: 'USD',
                         name: 'IdealFit',
                         description: `Monthly subscription - ${amount} orders`,
                         handler: function(response) {
                             // Handle success
                             console.log('Payment successful:', response);
                             alert('✅ Payment successful! Transaction ID: ' + response.razorpay_payment_id);
                             // Reload billing data
                             loadBillingData();
                         },
                         prefill: {
                             email: 'store@example.com',
                             contact: '+919876543210'
                         },
                         theme: {
                             color: '#667eea'
                         },
                         modal: {
                             ondismiss: function() {
                                 console.log('Payment cancelled by user');
                             }
                         }
                     };
                     
                     // Note: This is a placeholder. In production, you'd load Razorpay checkout script
                     // and initialize it with the options above.
                     alert(`🔄 Initiating Razorpay payment for $${amount}\n\nThis is a demo. In production, this would open the Razorpay payment gateway.`);
                     
                 } else if (gateway === 'stripe') {
                     // Stripe payment
                     const options = {
                         amount: amount * 100, // Amount in cents
                         currency: 'usd',
                         description: `IdealFit Monthly Subscription - ${amount} orders`,
                         source: 'card' // or other payment methods
                     };
                     
                     // Note: This is a placeholder. In production, you'd create a Stripe Checkout session
                     // or use Stripe Elements to handle the payment
                     alert(`🔄 Initiating Stripe payment for $${amount}\n\nThis is a demo. In production, this would open the Stripe payment gateway.`);
                     
                 }
                 
             } catch (error) {
                 console.error('Error initiating payment:', error);
                 alert('❌ Error initiating payment. Please try again.');
             }
         }
         
         // Authentication check
         function checkAuth() {
             const isLoggedIn = localStorage.getItem('idealfit_logged_in');
             if (isLoggedIn !== 'true') {
                 window.location.href = 'login.html';
             } else {
                 // Update displayed username
                 const username = localStorage.getItem('idealfit_username') || 'admin';
                 const usernameElement = document.getElementById('displayUsername');
                 if (usernameElement) {
                     usernameElement.textContent = username;
                 }
                 // Update sidebar username
                 const sidebarUsername = document.querySelector('.user-name');
                 if (sidebarUsername && username !== 'guest') {
                     sidebarUsername.textContent = username;
                 }
             }
         }
         
         // Logout function
         function logout() {
             if (confirm('Are you sure you want to logout?')) {
                 localStorage.removeItem('idealfit_logged_in');
                 localStorage.removeItem('idealfit_username');
                 localStorage.removeItem('idealfit_credentials');
                 window.location.href = 'login.html';
             }
         }
         
         // Change credentials function
         function changeCredentials(event) {
             event.preventDefault();
             
             const currentPassword = document.getElementById('currentPassword').value;
             const newUsername = document.getElementById('newUsername').value;
             const newPassword = document.getElementById('newPassword').value;
             const confirmPassword = document.getElementById('confirmPassword').value;
             
             // Get stored credentials
             const storedCredentials = JSON.parse(localStorage.getItem('idealfit_credentials') || '{"username":"admin","password":"admin123"}');
             
             // Validate current password
             if (currentPassword !== storedCredentials.password) {
                 showMessage('Current password is incorrect.', 'error');
                 return;
             }
             
             // Validate password match
             if (newPassword !== confirmPassword) {
                 showMessage('New passwords do not match.', 'error');
                 return;
             }
             
             // Validate password length
             if (newPassword.length < 6) {
                 showMessage('Password must be at least 6 characters long.', 'error');
                 return;
             }
             
             // Validate username
             if (newUsername.length < 3) {
                 showMessage('Username must be at least 3 characters long.', 'error');
                 return;
             }
             
             // Save new credentials
             const newCredentials = {
                 username: newUsername,
                 password: newPassword
             };
             localStorage.setItem('idealfit_credentials', JSON.stringify(newCredentials));
             localStorage.setItem('idealfit_username', newUsername);
             
             // Update display
             document.getElementById('displayUsername').textContent = newUsername;
             const sidebarUsername = document.querySelector('.user-name');
             if (sidebarUsername) {
                 sidebarUsername.textContent = newUsername;
             }
             
             // Clear form
             document.getElementById('changeCredentialsForm').reset();
             
             showMessage('Credentials updated successfully!', 'success');
             
             alert('✅ Your credentials have been updated successfully!');
         }
         
         function showMessage(message, type) {
             const messageDiv = document.getElementById('credentialsMessage');
             messageDiv.textContent = message;
             messageDiv.style.padding = '0.75rem';
             messageDiv.style.borderRadius = '8px';
             messageDiv.style.marginTop = '1rem';
             messageDiv.style.display = 'block';
             
             if (type === 'error') {
                 messageDiv.style.background = '#fee2e2';
                 messageDiv.style.color = '#991b1b';
             } else {
                 messageDiv.style.background = '#d1fae5';
                 messageDiv.style.color = '#065f46';
             }
             
             setTimeout(() => {
                 messageDiv.style.display = 'none';
             }, 5000);
         }
         
         // Initialize dashboard
         document.addEventListener('DOMContentLoaded', function() {
             console.log('🎯 IdealFit Merchant Dashboard Loaded Successfully!');
             
             // Check authentication
             checkAuth();
             
             // Initialize credentials if not exists
             if (!localStorage.getItem('idealfit_credentials')) {
                 localStorage.setItem('idealfit_credentials', JSON.stringify({
                     username: 'admin',
                     password: 'admin123'
                 }));
             }
             
             // Populate year dropdown
             populateYearDropdown();
             
             // Restore saved tab
             restoreSavedTab();
             
             // Load billing data if on billing tab
             if (localStorage.getItem('idealfit_current_tab') === 'billing') {
                 loadBillingData();
             }
             
             console.log('showTab function defined:', typeof showTab);
             console.log('dashboardState defined:', typeof dashboardState);
         });
    </script>
</body>
</html>
